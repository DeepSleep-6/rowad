<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2d2d2d; --accent: #bfa15f; --accent-dark: #a3884d;
            --bg: #f4f4f4; --surface: #ffffff; --text: #2d2d2d; --text-light: #666;
            --border: #e0e0e0; 
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .hidden { display: none !important; }
        .p-4 { padding: 16px; } .rounded { border-radius: 8px; } .shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Layout */
        .sidebar { width: 250px; background: var(--surface); height: 100vh; position: fixed; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main-content { margin-left: 250px; padding: 24px; }
        
        /* Components */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; } .btn-primary:hover { background: var(--accent-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); } .btn-outline:hover { background: #f5f5f5; }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .card { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        input, select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { font-weight: 600; color: var(--text-light); background: #fafafa; }
        tr:hover { background: #f8f9fa; }
        
        /* Text Colors */
        .text-green { color: #27ae60; font-weight: 600; }
        .text-red { color: #c0392b; font-weight: 600; }
        .text-orange { color: #d35400; font-weight: 600; }
        .text-blue { color: #2980b9; font-weight: 600; }
        .text-gray { color: #7f8c8d; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--surface); padding: 24px; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        
        /* Grid for Cards */
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        /* Chart Containers */
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-4 border-b" style="border-color: var(--border);">
            <h2 style="margin:0; color: var(--accent);">Rowad Calls</h2>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-light);">Hospital Dashboard</p>
        </div>
        <div class="p-4 flex-grow">
            <div class="flex flex-col gap-4">
                <input type="text" id="searchInput" placeholder="Search hospitals..." onkeyup="render()">
                
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-light);">REGION</label>
                    <select id="filterRegion" onchange="render()" style="margin-top: 4px;">
                        <option value="">All Regions</option>
                    </select>
                </div>

                <div>
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-light);">STATUS</label>
                    <select id="filterStatus" onchange="render()" style="margin-top: 4px;">
                        <option value="">All Statuses</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="p-4 border-t" style="border-color: var(--border);">
            <div id="userInfo" class="hidden">
                <div class="flex items-center gap-2 mb-2">
                    <div style="width: 32px; height: 32px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;" id="userInitial">U</div>
                    <div style="overflow: hidden;">
                        <div id="userName" style="font-weight: 500; font-size: 14px;">User</div>
                        <div id="userRole" style="font-size: 11px; color: var(--text-light);">Viewer</div>
                    </div>
                </div>
            </div>
            <div id="g_id_onload" data-client_id="YOUR_GOOGLE_CLIENT_ID" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="flex justify-between items-center mb-6">
            <h1 style="margin:0; font-size: 24px;">Hospital Database</h1>
            
            <div class="flex gap-2 bg-white p-1 rounded shadow">
                <button class="view-btn btn active" data-view="table" onclick="switchView('table')"><i class="fas fa-table"></i> Table</button>
                <button class="view-btn btn btn-outline" data-view="card" onclick="switchView('card')"><i class="fas fa-th-large"></i> Cards</button>
                <button class="view-btn btn btn-outline" data-view="charts" onclick="switchView('charts')"><i class="fas fa-chart-pie"></i> Charts</button>
                <button class="view-btn btn btn-outline" data-view="export" onclick="switchView('export')"><i class="fas fa-file-export"></i> Export</button>
            </div>
        </div>

        <div id="tableView" class="card" style="padding: 0; overflow: hidden;">
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th width="40">#</th>
                            <th>Hospital Name</th>
                            <th>Region</th>
                            <th>Devices</th>
                            <th>Status</th>
                            <th>Satisfaction</th>
                            <th>Contact</th>
                            <th width="50"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="cardView" class="grid-cards hidden"></div>

        <div id="chartsView" class="hidden">
            <div class="flex gap-4">
                <div class="card" style="flex: 1;">
                    <h3 class="mb-4">Call Outcomes</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="card" style="flex: 1;">
                    <h3 class="mb-4">Customer Satisfaction</h3>
                    <div class="chart-container">
                        <canvas id="satisfactionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="exportView" class="hidden">
            <div class="card flex flex-col items-center justify-center" style="min-height: 300px;">
                <h2 class="mb-4">Export Data</h2>
                <p class="text-light mb-6">Download the complete database as a CSV file for external reporting.</p>
                <button class="btn btn-primary" onclick="downloadCSV()" style="font-size: 16px; padding: 12px 24px;">
                    <i class="fas fa-download"></i> Download Full Database (CSV)
                </button>
            </div>
        </div>

    </div>

    <div id="editModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-4">
                <h2 style="margin:0">Update Hospital</h2>
                <button onclick="closeModal()" style="background:none; border:none; font-size: 20px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="flex flex-col gap-4">
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div id="editHospitalName" style="font-weight: bold; margin-bottom: 4px;"></div>
                    <div id="editRegion" style="font-size: 12px; color: var(--text-light);"></div>
                </div>

                <div>
                    <label class="block mb-1 text-sm font-bold">Status</label>
                    <select id="editStatus">
                        <option value="">- Select -</option>
                        <option value="No Answer">No Answer</option>
                        <option value="Call Later">Call Later</option>
                        <option value="Quote Requested">Quote Requested</option>
                        <option value="Not Interested">Not Interested</option>
                        <option value="Renewed">Renewed</option>
                    </select>
                </div>

                <div>
                    <label class="block mb-1 text-sm font-bold">Satisfaction</label>
                    <select id="editSatisfaction">
                        <option value="">- Select -</option>
                        <option value="Satisfied">Satisfied</option>
                        <option value="Unsatisfied">Unsatisfied</option>
                    </select>
                </div>

                <div>
                    <label class="block mb-1 text-sm font-bold">Notes</label>
                    <textarea id="editNotes" rows="3" style="width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 8px;"></textarea>
                </div>

                <div>
                    <label class="block mb-1 text-sm font-bold">Contact Person</label>
                    <input type="text" id="editContact">
                </div>
                 
                <div>
                    <label class="block mb-1 text-sm font-bold">Mobile Number</label>
                    <input type="text" id="editMobile">
                </div>

                <button id="saveBtn" class="btn btn-primary" style="margin-top: 10px;" onclick="saveChanges()">Save Updates</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE'; // Replace with deployment URL
        
        // State
        let db = [];
        let filteredDb = [];
        let currentUser = null;
        let currentEditIndex = -1;
        let charts = { status: null, satisfaction: null };

        // Initialization
        async function init() {
            // Check local storage for basic auth persistence (demo only)
            const savedUser = localStorage.getItem('rowad_user');
            if(savedUser) handleLoginSuccess(JSON.parse(savedUser));
            
            // Initial public fetch
            await fetchData();
        }
        
        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const json = await res.json();
                db = json.data;
                populateFilters();
                render();
            } catch(e) { console.error(e); }
        }

        function populateFilters() {
            const regions = [...new Set(db.map(i => i.Region))].filter(Boolean).sort();
            const statuses = [...new Set(db.map(i => i.Status))].filter(Boolean).sort();
            
            const rSelect = document.getElementById('filterRegion');
            regions.forEach(r => rSelect.add(new Option(r, r)));
            
            const sSelect = document.getElementById('filterStatus');
            statuses.forEach(s => sSelect.add(new Option(s, s)));
        }

        // Logic
        function render() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const region = document.getElementById('filterRegion').value;
            const status = document.getElementById('filterStatus').value;
            
            filteredDb = db.filter(item => {
                const matchSearch = (item['Hospital Name'] || '').toLowerCase().includes(search);
                const matchRegion = !region || item.Region === region;
                const matchStatus = !status || item.Status === status;
                return matchSearch && matchRegion && matchStatus;
            });

            const currentView = document.querySelector('.view-btn.active').dataset.view;
            
            if (currentView === 'table') renderTable();
            else if (currentView === 'card') renderCards();
            else if (currentView === 'charts') renderCharts();
        }

        // Helper for Colors
        function getStatusClass(text) {
            if (!text) return 'text-gray';
            const t = text.toLowerCase();
            if (t.includes('renewed') || t.includes('satisfied')) return 'text-green';
            if (t.includes('quote') || t.includes('call')) return 'text-blue'; // Call Later / Quote
            if (t.includes('no answer') || t.includes('unsatisfied') || t.includes('not interested')) return 'text-red';
            return 'text-gray';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filteredDb.map((item, idx) => `
                <tr onclick="openEdit(${item._rowIndex})">
                    <td class="text-light">${idx + 1}</td>
                    <td style="font-weight: 500">${item['Hospital Name']}</td>
                    <td>${item.Region}</td>
                    <td><span style="background: #eef2f5; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${item.Device || ''} ${item.Tags || ''}</span></td>
                    <td class="${getStatusClass(item.Status)}">${item.Status || '-'}</td>
                    <td class="${getStatusClass(item.Satisfaction)}">${item.Satisfaction || '-'}</td>
                    <td>
                        <div style="font-size: 12px;">${item.Contact || ''}</div>
                        <div style="font-size: 11px; color: var(--text-light);">${item['Contact Mobile Number'] || ''}</div>
                    </td>
                    <td><button class="btn btn-outline" style="padding: 4px 8px;"><i class="fas fa-pen"></i></button></td>
                </tr>
            `).join('');
        }

        function renderCards() {
            const container = document.getElementById('cardView');
            container.innerHTML = filteredDb.map(item => `
                <div class="card">
                    <div class="flex justify-between items-start mb-2">
                        <div style="font-size: 11px; color: var(--accent); font-weight: bold; text-transform: uppercase;">${item.Region}</div>
                        <div class="${getStatusClass(item.Status)}" style="font-size: 12px;">${item.Status || 'Unknown'}</div>
                    </div>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px;">${item['Hospital Name']}</h3>
                    <div style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">
                         ${item.Device || ''} ${item.Tags || ''}
                    </div>
                    <div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; font-size: 12px;">
                        <i class="fas fa-user-circle text-light"></i> ${item.Contact || 'No Contact'}
                    </div>
                    <button class="btn btn-outline" style="width: 100%; margin-top: 12px;" onclick="openEdit(${item._rowIndex})">Update</button>
                </div>
            `).join('');
        }

        function renderCharts() {
            // Prepare Data
            const statusCounts = {};
            const satisfactionCounts = { 'Satisfied': 0, 'Unsatisfied': 0, 'Unknown': 0 };

            filteredDb.forEach(i => {
                // Status Stats
                const s = i.Status || 'Pending';
                statusCounts[s] = (statusCounts[s] || 0) + 1;

                // Satisfaction Stats
                const sat = i.Satisfaction;
                if (sat === 'Satisfied') satisfactionCounts['Satisfied']++;
                else if (sat === 'Unsatisfied') satisfactionCounts['Unsatisfied']++;
                else satisfactionCounts['Unknown']++;
            });

            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            const ctxSat = document.getElementById('satisfactionChart').getContext('2d');

            // Destroy previous if exists
            if (charts.status) charts.status.destroy();
            if (charts.satisfaction) charts.satisfaction.destroy();

            // Status Bar Chart
            charts.status = new Chart(ctxStatus, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: '# of Hospitals',
                        data: Object.values(statusCounts),
                        backgroundColor: '#bfa15f'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Satisfaction Doughnut Chart
            charts.satisfaction = new Chart(ctxSat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(satisfactionCounts),
                    datasets: [{
                        data: Object.values(satisfactionCounts),
                        backgroundColor: ['#27ae60', '#c0392b', '#ecf0f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function downloadCSV() {
            if (!db || !db.length) return;
            const headers = Object.keys(db[0]);
            const csvRows = [];
            
            // Header
            csvRows.push(headers.join(','));
            
            // Rows
            for (const row of db) {
                const values = headers.map(header => {
                    const escaped = ('' + (row[header] || '')).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'hospital_db_full.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Auth & Actions
        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', token: response.credential })
            })
            .then(r => r.json())
            .then(res => {
                if(res.result === 'success') {
                    db = res.data; // Update with full data
                    handleLoginSuccess({ ...payload, role: res.role });
                    render();
                } else {
                    alert(res.message);
                }
            });
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            localStorage.setItem('rowad_user', JSON.stringify(user));
            
            document.getElementById('userInfo').classList.remove('hidden');
            document.querySelector('.g_id_signin').classList.add('hidden');
            document.getElementById('userInitial').innerText = user.name.charAt(0);
            document.getElementById('userName').innerText = user.name;
            document.getElementById('userRole').innerText = user.role || 'User';
        }

        function openEdit(rowIndex) {
            if(!currentUser || currentUser.role === 'Viewer') {
                alert("You need to log in with Editor permissions to modify data.");
                return;
            }

            const item = db.find(i => i._rowIndex === rowIndex);
            if(!item) return;

            currentEditIndex = rowIndex;
            document.getElementById('editHospitalName').innerText = item['Hospital Name'];
            document.getElementById('editRegion').innerText = item.Region;
            document.getElementById('editStatus').value = item.Status || '';
            document.getElementById('editSatisfaction').value = item.Satisfaction || '';
            document.getElementById('editNotes').value = item.Notes || '';
            document.getElementById('editContact').value = item.Contact || '';
            document.getElementById('editMobile').value = item['Contact Mobile Number'] || '';
            
            document.getElementById('editModal').style.display = 'flex';
        }

        window.saveChanges = async function() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Saving...";
            
            const updates = {
                'Status': document.getElementById('editStatus').value,
                'Satisfaction': document.getElementById('editSatisfaction').value,
                'Notes': document.getElementById('editNotes').value,
                'Contact': document.getElementById('editContact').value,
                'Contact Mobile Number': document.getElementById('editMobile').value,
                '_rowIndex': currentEditIndex
            };

            try {
                const r = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'save',
                        token: currentUser.token, // Sends token for validation
                        userEmail: currentUser.email,
                        data: updates
                    }) 
                });
                const res = await r.json();
                if(res.result === "success") {
                    alert("Saved Successfully!");
                    
                    // Update Local Data immediately
                    const localItem = db.find(i => i._rowIndex === currentEditIndex);
                    if(localItem) Object.assign(localItem, updates);
                    
                    closeModal();
                    render();
                } else {
                    alert("Error: " + res.message);
                }
            } catch(e) { 
                alert("Save failed. Check console."); 
                console.error(e); 
            }
            btn.innerText = "Save Updates";
        };

        window.closeModal = function() { document.getElementById('editModal').style.display = 'none'; };
        window.switchView = function(v) { 
            document.getElementById('tableView').classList.toggle('hidden', v!=='table');
            document.getElementById('cardView').classList.toggle('hidden', v!=='card');
            document.getElementById('chartsView').classList.toggle('hidden', v!=='charts');
            document.getElementById('exportView').classList.toggle('hidden', v!=='export');
            
            document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view===v));
            // Trigger render to update charts if switching to them
            if (v === 'charts') renderCharts();
        };

        init();
    </script>
</body>
</html>
