<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2d2d2d; --accent: #bfa15f; --accent-dark: #a3884d;
            --bg: #f4f4f4; --surface: #ffffff; --text: #2d2d2d; --text-light: #666;
            --border: #e0e0e0;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; } .p-4 { padding: 1rem; } .w-full { width: 100%; }
        
        /* Navbar */
        nav { background: var(--primary); color: white; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: var(--primary); }
        .btn-primary:hover { background: var(--accent-dark); }
        
        /* Main Layout */
        main { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        
        /* Table */
        .card { background: var(--surface); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 1rem; text-align: left; font-weight: 600; color: var(--text-light); border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); }
        tr:hover { background: #fcfcfc; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: inline-block; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: var(--surface); width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { background: var(--primary); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; }
        .modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .info-group { background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid var(--border); }
        .info-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.5px; margin-bottom: 0.25rem; }
        .info-value { font-weight: 600; color: var(--text); }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-light); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; box-sizing: border-box; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-content">
            <div class="logo"><i class="fas fa-hospital-alt"></i> ROWAD Portal</div>
            <div id="authBtn"></div>
        </div>
    </nav>

    <main>
        <div class="flex justify-between items-center" style="margin-bottom: 1.5rem;">
            <div class="flex gap-2">
                <input type="text" id="searchInput" placeholder="Search hospitals..." style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 4px; width: 300px;">
            </div>
            <div class="flex gap-2">
                <button class="btn" onclick="render('table')"><i class="fas fa-list"></i></button>
                <button class="btn" onclick="render('card')"><i class="fas fa-th-large"></i></button>
            </div>
        </div>

        <div id="loading" style="text-align: center; padding: 3rem;">
            <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--accent);"></i>
        </div>

        <div id="tableView" class="card hidden">
            <table>
                <thead>
                    <tr>
                        <th>Region</th>
                        <th>City</th>
                        <th>Hospital Name</th>
                        <th>Device</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </main>

    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.25rem;">
                    <span id="mRegion"></span> &bull; <span id="mCity"></span>
                </div>
                <h2 id="mHospital" style="margin:0; font-size: 1.5rem;">Hospital Name</h2>
            </div>
            <div class="modal-body">
                <div class="info-group flex gap-4">
                    <div style="flex:1">
                        <div class="info-label">Device Type</div>
                        <div class="info-value" id="mDevice">-</div>
                    </div>
                    <div style="flex:1">
                        <div class="info-label">Surfacide SN</div>
                        <div class="info-value" id="mSurfSN">-</div>
                    </div>
                    <div style="flex:1">
                        <div class="info-label">AccuFIT SN</div>
                        <div class="info-value" id="mAccuSN">-</div>
                    </div>
                </div>
                <div class="info-group">
                    <div class="info-label">Surfacide Username</div>
                    <div class="info-value" id="mSurfUser">-</div>
                </div>

                <div class="flex gap-4">
                    <div class="form-group" style="flex:1">
                        <label>Contact Name</label>
                        <input type="text" id="eContact">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Mobile</label>
                        <input type="text" id="eMobile">
                    </div>
                </div>

                <div class="flex gap-4">
                     <div class="form-group" style="flex:1">
                        <label>Status</label>
                        <select id="eStatus">
                            <option value="">- Select -</option>
                            <option value="Active">Active</option>
                            <option value="Pending">Pending</option>
                            <option value="Expired">Expired</option>
                            <option value="No Contract">No Contract</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Satisfaction</label>
                        <select id="eSat">
                            <option value="">- Select -</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tags</label>
                    <input type="text" id="eTags" placeholder="VIP, New, etc.">
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="eNotes"></textarea>
                </div>

                <div class="flex justify-between" style="margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #e2e8f0;">Cancel</button>
                    <button class="btn btn-primary" id="saveBtn" onclick="saveChanges()">Save Updates</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PASTE YOUR DEPLOYED WEB APP URL HERE
        const SCRIPT_URL = 'INSERT_YOUR_APPS_SCRIPT_URL_HERE';
        
        let db = [];
        let currentUser = null;
        let currentEditItem = null;

        // Init Google Auth
        window.onload = function() {
            google.accounts.id.initialize({
                client_id: "YOUR_GOOGLE_CLIENT_ID", // Keep your existing Client ID
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("authBtn"),
                { theme: "outline", size: "large" }
            );
            // Load public data initially
            fetchData();
        };

        async function handleCredentialResponse(response) {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', token: response.credential })
            });
            const data = await res.json();
            if(data.result === 'success') {
                currentUser = data.email;
                db = data.data; // Load uncensored data
                document.getElementById("authBtn").innerHTML = `<span style="font-weight:bold;">${currentUser}</span>`;
                render();
            } else {
                alert(data.message);
            }
        }

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(SCRIPT_URL);
                db = await res.json();
                render();
            } catch(e) { console.error(e); }
            document.getElementById('loading').classList.add('hidden');
        }

        function render(viewType = 'table') {
            document.getElementById('tableView').classList.remove('hidden');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            db.filter(item => 
                (item["Hospital Name"] && item["Hospital Name"].toLowerCase().includes(term)) ||
                (item.City && item.City.toLowerCase().includes(term))
            ).forEach(item => {
                const tr = document.createElement('tr');
                // Use bracket notation matching CSV Headers exactly
                tr.innerHTML = `
                    <td>${item.Region || ''}</td>
                    <td>${item.City || ''}</td>
                    <td style="font-weight:600">${item["Hospital Name"] || ''}</td>
                    <td>${item.Device || ''}</td>
                    <td><span class="status-badge" style="background:${getStatusColor(item.Status)}">${item.Status || '-'}</span></td>
                    <td><button class="btn btn-primary" onclick="openModal(${item._rowIndex})">Edit</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getStatusColor(status) {
            if(!status) return '#eee';
            const s = status.toLowerCase();
            if(s.includes('active')) return '#d1fae5'; // Green
            if(s.includes('expired')) return '#fee2e2'; // Red
            return '#fff3cd'; // Yellow
        }

        window.openModal = function(rowIndex) {
            currentEditItem = db.find(i => i._rowIndex === rowIndex);
            if(!currentEditItem) return;

            // Populate Read-Only
            document.getElementById('mHospital').innerText = currentEditItem["Hospital Name"];
            document.getElementById('mRegion').innerText = currentEditItem.Region;
            document.getElementById('mCity').innerText = currentEditItem.City;
            document.getElementById('mDevice').innerText = currentEditItem.Device;
            document.getElementById('mSurfSN').innerText = currentEditItem["Surfacide SN"] || '-';
            document.getElementById('mAccuSN').innerText = currentEditItem["AccuFIT SN"] || '-';
            document.getElementById('mSurfUser').innerText = currentEditItem["Surfacide Username"] || '-';

            // Populate Form (Using Headers as keys)
            document.getElementById('eContact').value = currentEditItem.Contact || '';
            document.getElementById('eMobile').value = currentEditItem["Contact Mobile Number"] || ''; // Note the header name
            document.getElementById('eStatus').value = currentEditItem.Status || '';
            document.getElementById('eSat').value = currentEditItem.Satisfaction || '';
            document.getElementById('eTags').value = currentEditItem.Tags || '';
            document.getElementById('eNotes').value = currentEditItem.Notes || '';

            document.getElementById('editModal').style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('editModal').style.display = 'none';
        };

        window.saveChanges = async function() {
            if(!currentUser) { alert("Please log in to edit."); return; }
            
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Saving...";

            // Construct payload using EXACT CSV Headers as keys
            const updates = {
                _rowIndex: currentEditItem._rowIndex,
                "Hospital Name": currentEditItem["Hospital Name"], // For logging
                "Contact": document.getElementById('eContact').value,
                "Contact Mobile Number": document.getElementById('eMobile').value,
                "Status": document.getElementById('eStatus').value,
                "Satisfaction": document.getElementById('eSat').value,
                "Tags": document.getElementById('eTags').value,
                "Notes": document.getElementById('eNotes').value
            };

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update',
                        userEmail: currentUser,
                        data: updates
                    })
                });
                const result = await res.json();
                
                if(result.result === 'success') {
                    // Update local DB to reflect changes immediately
                    Object.assign(currentEditItem, updates);
                    closeModal();
                    render();
                    alert("Saved successfully!");
                } else {
                    alert("Error: " + result.message);
                }
            } catch(e) {
                alert("Connection failed");
            }
            btn.innerText = "Save Updates";
        };

        // Simple search listener
        document.getElementById('searchInput').addEventListener('keyup', () => render());
    </script>
</body>
</html>
