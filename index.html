<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard v1.6 Optimized</title>
    <link rel="icon" href="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #2d2d2d; --a: #A88B4D; --ad: #8c7335; --bg: #f0f2f5; --s: #ffffff; --txt: #2d2d2d; --b: #e9ecef; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--txt); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Utils */
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .hidden { display: none !important; } .w-full { width: 100%; } .text-center { text-align: center; }
        .text-sm { font-size: 12px; } .text-xs { font-size: 10px; } .text-muted { color: #adb5bd; } .font-bold { font-weight: 700; }
        .mb-2 { margin-bottom: 8px; } .mt-2 { margin-top: 8px; } .mr-2 { margin-right: 8px; }
        
        /* Components */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; width: 100%; flex: 1; box-sizing: border-box; }
        .card-base { background: var(--s); border-radius: 12px; border: 1px solid var(--b); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        
        /* Nav & Login */
        .top-bar { background: var(--s); padding: 15px 30px; border-bottom: 3px solid var(--a); position: sticky; top: 0; z-index: 100; }
        .user-badge { background: #f1f3f5; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid var(--b); }
        .role-tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #e9ecef; text-transform: uppercase; }
        .login-card { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 300px; border-top: 4px solid var(--a); }
        
        /* Inputs & Filters */
        input, select, textarea { padding: 12px 16px; border: 1px solid var(--b); border-radius: 8px; width: 100%; outline: none; background: #fff; font-family: inherit; }
        input:focus, select:focus { border-color: var(--a); box-shadow: 0 0 0 3px rgba(168, 139, 77, 0.1); }
        .filter-panel { display: none; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding: 20px; margin-bottom: 25px; }
        .filter-panel.show { display: grid; }
        
        /* Data Views */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; background: var(--s); border: 1px solid var(--b); }
        .data-table th { padding: 20px; background: #fafafa; color: #8898aa; font-size: 12px; border-bottom: 1px solid var(--b); text-align: left; }
        .data-table td { padding: 18px 20px; border-bottom: 1px solid var(--b); }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { padding: 25px; position: relative; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        .card::before { content: ''; position: absolute; inset: 0 auto 0 0; width: 4px; background: #e9ecef; }
        .card.interacted::before { background: var(--a); } .card[data-active="true"]::before { background: var(--active-contract); }
        
        /* Charts */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .chart-card { background: var(--s); padding: 30px; border-radius: 16px; border: 1px solid var(--b); height: 340px; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-card { background: var(--s); width: 100%; max-width: 650px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .secure-input:disabled { background: transparent; border: none; padding: 0; font-weight: 600; -webkit-text-fill-color: var(--txt); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* Misc */
        .btn-action { background: #f8f9fa; border: 1px solid var(--b); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-save { width: 100%; padding: 16px; background: var(--a); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .tag-pill { font-size: 11px; background: #f1f3f5; padding: 3px 8px; border-radius: 12px; border: 1px solid #dee2e6; margin: 0 4px 2px 0; display: inline-block; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e9ecef; border-top-color: var(--a); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .data-table, .vertical-divider { display: none; } .grid-view, .grid-2 { grid-template-columns: 1fr; } .modal-card { width: 95%; } }
        @media print { body { background: white; } .no-print { display: none !important; } .data-table { display: table !important; } }
    </style>
</head>
<body>
    <div id="loginOverlay" class="flex items-center justify-center" style="position:fixed; inset:0; background:var(--bg); z-index:2000; flex-direction:column;">
        <div class="login-card">
            <h2 class="mb-2" style="font-size: 22px;">Rowad Calls Dashboard</h2>
            <div id="g_id_onload" data-client_id="174253379694-95msalgnm4kbpjlftil4vm8o26c7h7cc.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-size="large" style="display:flex; justify-content:center;"></div>
        </div>
    </div>

    <div id="mainDashboard" class="hidden flex-col h-full">
        <div class="top-bar flex items-center justify-between no-print">
            <div class="flex items-center gap-4"><img src="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico" style="height:45px"> <span class="font-bold" style="font-size:20px">Calls Dashboard</span></div>
            <div class="flex items-center gap-4">
                <div id="userBadge" class="user-badge" onclick="logout()"><i class="fa-solid fa-user-circle text-muted"></i> <span id="userNameDisplay">User</span> <span id="roleLabel" class="role-tag">Viewer</span></div>
                <div class="vertical-divider" style="width:1px; height:24px; background:#dee2e6;"></div>
                <div id="viewControls" class="flex gap-2">
                    <button class="btn-action active" data-view="table"><i class="fa-solid fa-table"></i></button>
                    <button class="btn-action" data-view="card"><i class="fa-solid fa-th-large"></i></button>
                    <button class="btn-action" data-view="charts"><i class="fa-solid fa-chart-pie"></i></button>
                    <button class="btn-action" data-view="export"><i class="fa-solid fa-file-export"></i></button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="flex gap-2 mb-4 items-center no-print">
                <div class="w-full"><input type="text" id="search" placeholder="Search..." onkeyup="debouncedRender()"></div>
                <button class="btn-action" onclick="document.getElementById('filterPanel').classList.toggle('show')"><i class="fa-solid fa-filter"></i></button>
            </div>
            <div id="filterPanel" class="filter-panel card-base no-print"></div>

            <div id="loading" class="text-center" style="padding: 80px 0;"><div class="spinner"></div><span class="text-muted">Loading Database...</span></div>

            <table class="data-table hidden" id="tableView">
                <thead><tr><th width="35%">Hospital</th> <th>Location</th> <th>Devices</th> <th>Satisfaction</th> <th>Status</th> <th style="text-align:right">Action</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
            
            <div class="grid-view hidden" id="cardView"></div>

            <div id="chartsView" class="hidden">
                <h3 class="font-bold mb-4">Overview</h3>
                <div id="chartsOverview" class="chart-grid"></div>
                <h3 class="font-bold mb-4 mt-4">Team Performance</h3>
                <div id="chartsTeam" class="chart-grid"></div>
            </div>

            <div id="exportView" class="hidden text-center" style="padding-top: 40px;">
                <div class="card-base" style="max-width: 700px; margin: 0 auto; padding: 40px;">
                    <i class="fa-solid fa-file-export mb-4" style="font-size:24px; color:var(--a); background:#fff8e6; padding:15px; border-radius:50%;"></i>
                    <h2 class="mb-2">Data Export</h2>
                    <div id="columnPicker" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:15px; text-align:left; margin:25px 0;"></div>
                    <div class="flex gap-4 justify-center">
                        <button onclick="downloadCSV()" class="btn-save" style="width:auto; padding:12px 25px;"><i class="fa-solid fa-file-csv mr-2"></i> CSV</button>
                        <button onclick="window.print()" class="btn-action"><i class="fa-solid fa-print mr-2"></i> PDF</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center text-muted text-xs p-4 no-print">Rowad Calls Dashboard v1.6 • Developed by Faisal Alzougbi</div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="flex justify-between items-center" style="padding:20px 30px; border-bottom:1px solid var(--b); background:#fcfcfc;">
                <div><h2 class="m-0" style="font-size:20px;" id="modalTitle">Hospital</h2><div id="modalSubtitle" class="text-muted text-xs mt-1"></div></div>
                <button onclick="document.getElementById('editModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4" style="padding: 30px;">
                <div class="grid-2 card-base" style="background:#f8f9fa; padding:20px; margin-bottom:20px;">
                    <div><label class="block text-xs font-bold text-muted">Region</label><div id="view_Region">-</div></div>
                    <div><label class="block text-xs font-bold text-muted">City</label><div id="view_City">-</div></div>
                    <div><label class="block text-xs font-bold text-muted">Device</label><div id="view_Device">-</div></div>
                    <div><label class="block text-xs font-bold text-muted">Serial</label><div id="view_SN">-</div></div>
                </div>
                <div class="grid-2">
                    <div>
                        <label class="block text-xs font-bold text-muted mb-2">Contact</label>
                        <div class="card-base" style="padding:15px;">
                            <input type="text" id="in_Contact" class="secure-input" disabled placeholder="Name">
                            <div class="flex items-center mt-2 pt-2" style="border-top:1px solid #f1f3f5;">
                                <i class="fa-solid fa-phone mr-2 text-muted"></i> <span id="displayPhone" class="font-semibold text-sm">***</span>
                                <a id="waLink" class="hidden" target="_blank" style="margin-left:auto; color:#25D366; font-size:18px;"><i class="fa-brands fa-whatsapp"></i></a>
                            </div>
                            <input type="hidden" id="in_Mobile">
                            <button id="editPhoneBtn" onclick="updatePhone()" class="hidden mt-2 text-xs font-semibold" style="color:var(--a); border:none; background:none; cursor:pointer;">Change Number</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4">
                        <select id="in_Status" class="secure-input" disabled><option value="">-</option><option>No Answer</option><option>Call Later</option><option>Quote Requested</option><option>Renewed</option><option>Active Contract</option><option>Not Interested</option></select>
                        <select id="in_Satisfaction" class="secure-input" disabled><option value="">-</option><option>Satisfied</option><option>Unsatisfied</option><option>Neutral</option></select>
                        <input type="text" id="in_Tags" class="secure-input" disabled placeholder="Tags...">
                    </div>
                </div>
                <div class="mb-4 mt-4"><label class="block text-xs font-bold text-muted mb-2">Notes</label><textarea id="in_Notes" class="secure-input" disabled style="min-height:80px;" placeholder="Notes..."></textarea></div>
                <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>Login to Edit</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwaush-5NL-MH3OXm7mqXdj4Gy9M9Wlv8qh8Pe7UmlaH5k7jcb4T218DDpHfD4r4B3asA/exec";
        
        // --- CONFIGURATION ---
        const FILTERS_CFG = [
            {id:'Direction', label:'Directions'}, {id:'Region', label:'Regions'}, {id:'City', label:'Cities'},
            {id:'Status', opts:['Pending','Quote Requested','Call Later','No Answer','Renewed','Active Contract','Not Interested']},
            {id:'Satisfaction', opts:['Satisfied','Unsatisfied','Neutral']}
        ];
        
        const CHARTS_CFG = [
            { id: 'deviceChart', title: 'Device Ownership', type: 'bar', colors: ['#A88B4D','#2d2d2d'], group: 'chartsOverview' },
            { id: 'satChart', title: 'Satisfaction', type: 'doughnut', colors: ['#27ae60','#d35400','#95a5a6'], group: 'chartsOverview' },
            { id: 'funnelChart', title: 'Sales Funnel', type: 'bar', idx: 'y', colors: ['#e9ecef','#C4B27D','#A88B4D','#2d2d2d'], group: 'chartsOverview' },
            { id: 'statusChart', title: 'Call Outcomes', type: 'bar', colors: '#666', group: 'chartsOverview' },
            { id: 'activityChart', title: 'Total Activities', type: 'bar', idx: 'y', colors: '#2d2d2d', group: 'chartsTeam' },
            { id: 'quoteChart', title: 'Quotes Generated', type: 'bar', idx: 'y', colors: '#27ae60', group: 'chartsTeam' }
        ];

        // --- STATE ---
        let db = [], historyDB = [], userMap = {}, charts = {}, currentIdx = -1;
        let user = { email: null, role: 'Public', token: null };
        const priority = { "Quote Requested":1, "Call Later":2, "No Answer":3, "Pending":4, "Renewed":5, "Satisfied":5, "Active Contract":6 };

        // --- CORE LOGIC ---
        window.onload = () => {
            initDOM();
            checkSession();
            document.getElementById('viewControls').addEventListener('click', e => {
                const b = e.target.closest('button'); 
                if(b) {
                    ['table','card','charts','export'].forEach(v => document.getElementById(v+'View').classList.toggle('hidden', b.dataset.view!==v));
                    document.querySelectorAll('#viewControls button').forEach(btn => btn.classList.toggle('active', btn===b));
                    if(b.dataset.view === 'charts') renderCharts();
                }
            });
        };

        function initDOM() {
            // Generate Filters
            document.getElementById('filterPanel').innerHTML = FILTERS_CFG.map(f => 
                `<select id="f_${f.id}" onchange="${f.id==='Region'?'handleRegion()':'debouncedRender()'}"><option value="All">All ${f.label||f.id}</option>${(f.opts||[]).map(o=>`<option>${o}</option>`).join('')}</select>`
            ).join('');
            
            // Generate Chart Containers
            CHARTS_CFG.forEach(c => document.getElementById(c.group).innerHTML += 
                `<div class="chart-card"><h3 class="font-semibold text-sm mb-2">${c.title}</h3><div class="chart-wrapper"><canvas id="${c.id}"></canvas></div></div>`
            );
        }

        async function api(act, pl={}) {
            try { return await (await fetch(API_URL, { method:'POST', body:JSON.stringify({action:act, token:user.token, ...pl}) })).json(); }
            catch(e) { return { result:'error' }; }
        }

        async function checkSession() {
            try {
                const s = JSON.parse(localStorage.getItem('rowad_u'));
                if(s && Date.now()-s.ts < 32400000) { user=s.u; initUser(); fetchData(); return; }
            } catch(e){}
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        window.handleCredentialResponse = async (res) => {
            user.token = res.credential;
            const r = await api('login');
            if(r.result==='success') {
                user = { email:r.email, role:r.role, token:res.credential };
                localStorage.setItem('rowad_u', JSON.stringify({u:user, ts:Date.now()}));
                document.getElementById('loginOverlay').style.display = 'none';
                initUser(); fetchData();
            } else alert(r.message);
        };

        function initUser() {
            document.getElementById('userNameDisplay').innerText = user.email.split('@')[0];
            document.getElementById('roleLabel').innerText = user.role;
            document.getElementById('mainDashboard').classList.replace('hidden','flex');
        }

        async function fetchData() {
            const r = await api('fetch_data');
            if(r.result==='error') { localStorage.removeItem('rowad_u'); location.reload(); return; }
            db = r.data; historyDB = r.history || [];
            (r.permissions||[]).forEach(p => userMap[p.Email] = p.ID);
            
            // Populate Dynamic Dropdowns
            ['Direction','Region','City'].forEach(k => {
                const opts = [...new Set(db.map(r=>r[k]).filter(Boolean))].sort();
                document.getElementById('f_'+k).innerHTML += opts.map(o=>`<option>${o}</option>`).join('');
            });
            
            // Populate Export Cols
            document.getElementById('columnPicker').innerHTML = Object.keys(db[0]).filter(k=>!k.startsWith('_')).map(k=>`<label class="flex items-center gap-2 text-sm"><input type="checkbox" checked value="${k}"> ${k}</label>`).join('');
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableView').classList.remove('hidden');
            render();
        }

        // --- RENDERERS ---
        let timeout; window.debouncedRender = () => { clearTimeout(timeout); timeout=setTimeout(render, 300); };
        window.handleRegion = () => {
            const reg = document.getElementById('f_Region').value;
            const cities = [...new Set(db.filter(r => reg==='All' || r.Region===reg).map(r=>r.City).filter(Boolean))].sort();
            document.getElementById('f_City').innerHTML = '<option value="All">All Cities</option>' + cities.map(c=>`<option>${c}</option>`).join('');
            debouncedRender();
        };

        function render() {
            const s = document.getElementById('search').value.toLowerCase();
            const flt = FILTERS_CFG.reduce((acc, f) => ({ ...acc, [f.id]: document.getElementById('f_'+f.id).value }), {});
            
            db.sort((a,b) => (priority[a.Status]||9) - (priority[b.Status]||9));
            const data = db.filter(r => 
                Object.keys(flt).every(k => flt[k]==='All' || (r[k]||'Pending')===flt[k]) &&
                (r["Hospital Name"]+r.Contact+r.City).toLowerCase().includes(s)
            );

            const color = (st) => (st||'').match(/Renew|Satis/) ? '#27ae60' : (st||'').match(/Quote|Call/) ? '#2980b9' : (st||'').match(/Active/) ? '#5DADE2' : '#666';
            const esc = (t) => (t||'').toString().replace(/</g,'&lt;');

            document.getElementById('tableBody').innerHTML = data.map(r => `
                <tr>
                    <td><div class="font-bold">${esc(r["Hospital Name"])}</div><div class="text-xs text-muted">${esc(r.Contact)}</div></td>
                    <td class="text-xs text-muted">${esc(r.City)}</td>
                    <td><div class="text-xs font-bold">${esc(r.Device)}</div><div class="mt-2">${(r.Tags||'').split(',').map(t=>t?`<span class="tag-pill">${t}</span>`:'').join('')}</div></td>
                    <td><span style="color:${color(r.Satisfaction)}; background:${color(r.Satisfaction)}15; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:700">${esc(r.Satisfaction||'-')}</span></td>
                    <td style="color:${color(r.Status)}; font-weight:700; font-size:12px">${esc(r.Status||'-')}</td>
                    <td style="text-align:right"><button class="btn-action" onclick="openModal(${r._rowIndex})"><i class="fa-solid fa-pen"></i></button></td>
                </tr>`).join('');

            document.getElementById('cardView').innerHTML = data.map(r => `
                <div class="card card-base ${(r.Status||'Pending')!=='Pending'?'interacted':''}" data-active="${r.Status==='Active Contract'}" onclick="openModal(${r._rowIndex})">
                    <h3 class="mb-2 m-0" style="font-size:16px;">${esc(r["Hospital Name"])}</h3>
                    <div class="text-xs text-muted font-bold">${esc(r.Device||'-')} • ${esc(r.Region)}</div>
                    <div class="flex justify-between items-center pt-4 mt-2" style="border-top:1px solid #f1f3f5">
                        <span style="color:${color(r.Status)}; font-weight:700; font-size:12px;">${esc(r.Status||'Pending')}</span>
                        ${r.Contact ? '<i class="fa-solid fa-user text-muted"></i>' : ''}
                    </div>
                </div>`).join('');
            
            if(!document.getElementById('chartsView').classList.contains('hidden')) renderCharts(data);
        }

        function renderCharts(data=db) {
            // Tally Helper
            const tally = (src, key, cond) => src.reduce((acc, r) => {
                if(!cond || cond(r)) { const k = resolve(r[key]); acc[k] = (acc[k]||0)+1; } return acc;
            }, {});
            const resolve = (u) => userMap[u] || u || 'Unknown';
            const sort = (o) => Object.entries(o).sort((a,b)=>b[1]-a[1]);

            // Aggregations
            const dev = { Surfacide:0, AccuFIT:0 };
            const funnel = { Total:data.length, Contacted:0, Quotes:0, Active:0 };
            const sat = {}, stat = {};

            data.forEach(r => {
                const s = r.Status||'Pending', d=(r.Device||'').toLowerCase();
                if(d.includes('surf')) dev.Surfacide++; if(d.includes('accu')) dev.AccuFIT++;
                if(s!=='Pending') funnel.Contacted++; if(s==='Quote Requested') funnel.Quotes++; if(s.match(/Renew|Active/)) funnel.Active++;
                if(r.Satisfaction) sat[r.Satisfaction] = (sat[r.Satisfaction]||0)+1;
                if(!['Pending','Active Contract'].includes(s)) stat[s] = (stat[s]||0)+1;
            });

            // History Aggregations
            const act = tally(historyDB, 'User');
            const quo = tally(historyDB, 'User', r => r["Field Changed"]==='Status' && r["New Value"]==='Quote Requested');

            const datasets = {
                deviceChart: [Object.keys(dev), Object.values(dev)],
                satChart: [Object.keys(sat), Object.values(sat)],
                funnelChart: [Object.keys(funnel), Object.values(funnel)],
                statusChart: [Object.keys(stat), Object.values(stat)],
                activityChart: [sort(act).map(x=>x[0]), sort(act).map(x=>x[1])],
                quoteChart: [sort(quo).map(x=>x[0]), sort(quo).map(x=>x[1])]
            };

            CHARTS_CFG.forEach(c => {
                if(charts[c.id]) charts[c.id].destroy();
                charts[c.id] = new Chart(document.getElementById(c.id), {
                    type: c.type, indexAxis: c.idx||'x',
                    data: { labels: datasets[c.id][0], datasets: [{ data: datasets[c.id][1], backgroundColor: c.colors, borderRadius: 4, barThickness: c.idx?20:undefined }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: c.type==='doughnut', position:'right' } }, scales: { [c.idx||'x']: { grid: { display: false } } } }
                });
            });
        }

        // --- ACTIONS ---
        window.openModal = (idx) => {
            currentIdx = idx;
            const r = db.find(i => i._rowIndex === idx);
            if(!r) return;
            
            const raw = r["Last Editor"] || "Unknown";
            document.getElementById('modalTitle').innerText = r["Hospital Name"];
            document.getElementById('modalSubtitle').innerText = `Updated: ${raw.includes('@') ? (userMap[raw.split(' on ')[0]] || raw.split('@')[0]) : raw}`;
            
            // Auto-Wire: Views
            ['Region','City','Device'].forEach(k => document.getElementById('view_'+k).innerText = r[k]||'-');
            document.getElementById('view_SN').innerText = (r['Surfacide SN']||'') + ' ' + (r['AccuFIT SN']||'');
            
            // Auto-Wire: Inputs
            ['Contact','Status','Satisfaction','Tags','Notes'].forEach(k => document.getElementById('in_'+k).value = r[k]||'');
            document.getElementById('in_Mobile').value = r['Contact Mobile Number']||'';
            
            // Phone Logic
            const m = r['Contact Mobile Number'], hasM = m && m.length > 5;
            document.getElementById('displayPhone').innerText = m || "No Number";
            if(hasM) document.getElementById('waLink').href = `https://wa.me/966${m.match(/\d+/)?.[0].slice(-9)}`;
            document.getElementById('waLink').classList.toggle('hidden', !hasM);
            
            // Access
            const can = ['Admin','Editor'].includes(user.role);
            document.querySelectorAll('.secure-input').forEach(e => e.disabled = !can);
            document.getElementById('saveBtn').disabled = !can;
            document.getElementById('saveBtn').innerText = can ? "Save Updates" : "Login to Edit";
            document.getElementById('editPhoneBtn').classList.toggle('hidden', !can);
            document.getElementById('editModal').style.display = 'flex';
        };

        window.updatePhone = () => {
            const n = prompt("New Number:", document.getElementById('in_Mobile').value);
            if(n) { document.getElementById('in_Mobile').value=n; document.getElementById('displayPhone').innerText=n; }
        };

        window.saveChanges = async () => {
            const btn = document.getElementById('saveBtn'); btn.innerText = "Saving...";
            const data = { 
                _rowIndex: currentIdx, 
                "Last Editor": `${user.email} on ${new Date().toLocaleDateString('en-GB')}`,
                "Contact Mobile Number": document.getElementById('in_Mobile').value
            };
            ['Contact','Status','Satisfaction','Tags','Notes'].forEach(k => data[k] = document.getElementById('in_'+k).value);
            
            const res = await api('save', { userEmail: user.email, data });
            if(res.result === 'success') {
                Object.assign(db.find(r => r._rowIndex === currentIdx), data);
                render(); btn.classList.add('success'); btn.innerText = "Saved";
                setTimeout(() => { document.getElementById('editModal').style.display = 'none'; }, 1000);
            } else { alert("Error"); btn.innerText = "Save Updates"; }
        };

        window.logout = () => { localStorage.removeItem('rowad_u'); location.reload(); };
        window.downloadCSV = () => {
            const cols = [...document.querySelectorAll('#columnPicker input:checked')].map(c=>c.value);
            const csv = [cols.join(',')].concat(db.map(r => cols.map(c => `"${(r[c]||'').toString().replace(/"/g, '""')}"`).join(','))).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download='db.csv'; a.click();
        };
    </script>
</body>
</html>
