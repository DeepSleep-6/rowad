<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2d2d2d; --accent: #bfa15f; --accent-dark: #a3884d;
            --bg: #f4f4f4; --surface: #ffffff; --text: #2d2d2d; --text-light: #666;
            --border: #e0e0e0; 
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .hidden { display: none !important; }
        .p-4 { padding: 16px; } .rounded { border-radius: 8px; }

        /* Top Bar */
        .top-bar { background: var(--surface); padding: 15px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 100; }
        .logo-img { height: 45px; width: auto; } 
        .page-title { font-size: 20px; font-weight: 700; padding-left: 15px; border-left: 2px solid #eee; margin-left: 15px; }
        
        /* Login UI */
        .user-badge { background: #f0f0f0; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .role-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #ccc; color: #333; text-transform: uppercase; }
        .role-admin { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .role-rowad { background: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }

        /* Controls */
        .view-btn { border: none; background: #eee; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; }
        .view-btn.active { background: white; color: var(--accent-dark); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input, select, textarea { padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; outline: none; background: #fff; font-family: inherit; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; min-height: 80vh; }
        .controls { flex-wrap: wrap; margin-bottom: 25px; }
        .search-box { flex: 2; min-width: 250px; } .filter-box { flex: 1; min-width: 150px; }

        /* Table */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--surface); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .data-table th { text-align: left; padding: 18px 15px; background: #fafafa; color: var(--text-light); font-weight: 700; text-transform: uppercase; border-bottom: 2px solid var(--border); cursor: pointer; }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); }
        .tag { padding: 4px 10px; border-radius: 12px; font-size: 11px; background: #eee; border: 1px solid #ddd; display: inline-block; margin: 0 4px 2px 0; }
        .btn-action { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-card { background: var(--surface); width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; border-top: 5px solid var(--accent); max-height: 90vh; overflow-y: auto; }
        
        /* New Info Section in Modal */
        .info-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); }
        .info-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .info-item { flex: 1; }
        .info-label { font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
        .info-val { font-weight: 600; font-size: 14px; color: #333; }

        .contact-box { background: #fcfcfc; border: 1px solid var(--border); padding: 12px; position: relative; }
        .wa-btn { background: #25D366; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none; font-size: 16px; margin-left: auto; }
        .btn-save { width: 100%; padding: 14px; margin-top: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }
        
        .loading-container { text-align: center; padding: 60px 0; color: var(--text-light); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) { .data-table { display: none; } .grid-view { display: grid !important; } .controls { flex-direction: column; } }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--surface); padding: 20px; border: 1px solid var(--border); transition: transform 0.2s; cursor: pointer; }

        /* ADDED: Chart Container */
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .chart-card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); flex: 1; }
    </style>
</head>
<body>
    <div class="top-bar flex items-center justify-between">
        <div class="flex items-center">
            <img src="https://alrowad-ksa.com/wp-content/uploads/2022/10/Rowad-Medical-Services_Horizontal_Logo.svg" alt="Rowad Logo" class="logo-img">
            <span class="page-title">Calls Dashboard</span>
        </div>
        <div class="flex items-center gap-4">
            <div id="g_id_onload"
                 data-client_id="174253379694-95msalgnm4kbpjlftil4vm8o26c7h7cc.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="medium" data-logo_alignment="left" id="loginBtn"></div>
            
            <div id="userBadge" class="user-badge hidden">
                <i class="fa-solid fa-user-circle"></i>
                <span id="userNameDisplay">User</span>
                <span id="roleLabel" class="role-tag">Public</span>
            </div>

            <div class="view-toggles flex gap-2" id="viewControls">
                <button class="view-btn active" data-view="table"><i class="fa-solid fa-table"></i></button>
                <button class="view-btn" data-view="card"><i class="fa-solid fa-th-large"></i></button>
                <button class="view-btn" data-view="charts"><i class="fa-solid fa-chart-pie"></i></button>
                <button class="view-btn" data-view="export"><i class="fa-solid fa-file-export"></i></button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="controls flex gap-4">
            <div class="search-box"><input type="text" id="search" placeholder="Search Hospital, Contact..." onkeyup="debouncedRender()"></div>
            <div class="filter-box"><select id="filterDirection" onchange="debouncedRender()"><option value="All">All Directions</option></select></div>
        </div>

        <div id="loading" class="loading-container"><div class="spinner"></div><span>Loading Database...</span></div>

        <table class="data-table hidden" id="tableView">
            <thead>
                <tr>
                    <th width="30%">Hospital</th> <th>Location</th> <th>Devices</th> <th>Satisfaction</th> <th>Status</th> <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        
        <div class="grid-view hidden" id="cardView"></div>

        <div id="chartsView" class="hidden">
            <div class="flex gap-4" style="flex-wrap: wrap;">
                <div class="chart-card">
                    <h3 style="margin-top:0">Call Outcomes</h3>
                    <div class="chart-wrapper"><canvas id="statusChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 style="margin-top:0">Satisfaction Overview</h3>
                    <div class="chart-wrapper"><canvas id="satChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="exportView" class="hidden" style="text-align: center; padding-top: 40px;">
            <div class="card" style="max-width: 400px; margin: 0 auto; padding: 40px;">
                <i class="fa-solid fa-file-csv" style="font-size: 48px; color: var(--accent); margin-bottom: 20px;"></i>
                <h2>Export Database</h2>
                <p style="color: #666; margin-bottom: 30px;">Download the complete dataset including all hospitals and contact details.</p>
                <button onclick="downloadCSV()" class="btn-save"><i class="fa-solid fa-download"></i> Download Full CSV</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="flex justify-between items-start mb-4">
                <h2 style="margin:0; font-size:24px;" id="modalTitle">Hospital</h2>
                <button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div class="info-section">
                <div class="info-row" style="border-bottom:1px solid #eee; padding-bottom:8px;">
                    <div class="info-item"><div class="info-label">Region</div><div class="info-val" id="dispRegion">-</div></div>
                    <div class="info-item"><div class="info-label">City</div><div class="info-val" id="dispCity">-</div></div>
                </div>
                <div class="info-row">
                    <div class="info-item"><div class="info-label">Device</div><div class="info-val" id="dispDevice">-</div></div>
                    <div class="info-item"><div class="info-label">Surfacide SN</div><div class="info-val" id="dispSurfSN">-</div></div>
                    <div class="info-item"><div class="info-label">AccuFIT SN</div><div class="info-val" id="dispAccuSN">-</div></div>
                </div>
                <div class="info-row" style="margin-bottom:0">
                    <div class="info-item"><div class="info-label">Surfacide Username</div><div class="info-val" id="dispSurfUser">-</div></div>
                </div>
            </div>

            <div class="mb-4" style="margin-bottom: 16px;">
                <label class="block mb-2 font-bold" style="font-size:14px; color:#666;">Contact</label>
                <div class="contact-box rounded">
                    <input type="text" id="editContactName" class="secure-input" disabled placeholder="Name">
                    <div class="flex items-center mt-2">
                        <i class="fa-solid fa-phone" style="margin-right:8px; color:#666;"></i> 
                        <span id="displayPhone">***</span>
                        <a id="waLink" class="wa-btn hidden" target="_blank"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                    <input type="hidden" id="editContactMobile">
                    <button id="editPhoneBtn" onclick="promptPhoneUpdate()" class="hidden" style="margin-top:5px; color:var(--accent); border:none; background:none; cursor:pointer; font-size:12px;">Change Number</button>
                </div>
            </div>

            <div class="flex gap-4" style="margin-bottom:16px;">
                <div style="flex:1"><label class="block mb-2 font-bold">Satisfaction</label>
                <select id="editSat" class="secure-input" disabled>
                    <option value="">-</option>
                    <option value="Satisfied">Satisfied</option>
                    <option value="Unsatisfied">Unsatisfied</option>
                </select></div>
                
                <div style="flex:1"><label class="block mb-2 font-bold">Status</label>
                <select id="editStatus" class="secure-input" disabled>
                    <option value="">-</option>
                    <option value="No Answer">No Answer</option>
                    <option value="Call Later">Call Later</option>
                    <option value="Quote Requested">Quote Requested</option>
                    <option value="Not Interested">Not Interested</option>
                    <option value="Renewed">Renewed</option>
                </select></div>
            </div>

            <div style="margin-bottom:16px;">
                <label class="block mb-2 font-bold">Tags</label>
                <input type="text" id="editTags" class="secure-input" disabled placeholder="VIP, New...">
            </div>

            <div class="mb-4">
                <label class="block mb-2 font-bold">Notes</label>
                <textarea id="editNotes" class="secure-input" disabled style="resize:vertical; min-height:80px;" placeholder="Add notes..."></textarea>
            </div>
            
            <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>Login to Edit</button>
            <div id="loginPrompt" style="text-align:center; font-size:12px; color:#666; margin-top:5px;" class="hidden">Only Editors can save changes.</div>
        </div>
    </div>

    <script>
        // --- PASTE YOUR DEPLOYED APPS SCRIPT URL HERE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaush-5NL-MH3OXm7mqXdj4Gy9M9Wlv8qh8Pe7UmlaH5k7jcb4T218DDpHfD4r4B3asA/exec"; 
        
        let db = [], currentEditIndex = -1;
        let currentUser = { email: null, token: null, role: 'Public' };
        let chartInstances = {};

        // 1. INIT
        window.onload = function() {
            fetchData();
            document.getElementById('viewControls').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if(btn) switchView(btn.dataset.view);
            });
        };

        // 2. LOGIN HANDLER
        window.handleCredentialResponse = async function(response) {
            currentUser.token = response.credential;
            document.getElementById('loginBtn').style.opacity = '0.5';

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', token: currentUser.token })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    currentUser.email = json.email;
                    currentUser.role = json.role; 
                    db = json.data; // Load Uncensored Data
                    render();
                    updateUserUI(json);
                } else {
                    alert("Login Failed: " + json.message);
                }
            } catch (e) { console.error(e); alert("Connection failed."); }
        };

        function updateUserUI(json) {
            document.getElementById('loginBtn').classList.add('hidden');
            const badge = document.getElementById('userBadge');
            badge.classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = json.email.split('@')[0];
            const tag = document.getElementById('roleLabel');
            tag.innerText = json.role;
            tag.className = 'role-tag ' + (json.role === 'Admin' || json.role === 'Editor' ? 'role-admin' : 'role-rowad');
            
            // Re-render to enable edit buttons
            render();
        }

        // 3. FETCH & RENDER
        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL);
                db = await res.json(); 
                
                // Populate Filter
                const dirs = [...new Set(db.map(r => r.Direction))].filter(Boolean).sort();
                const s = document.getElementById('filterDirection');
                s.innerHTML = '<option value="All">All Directions</option>';
                dirs.forEach(d => s.add(new Option(d, d)));

                document.getElementById('loading').style.display = 'none';
                document.getElementById('tableView').classList.remove('hidden');
                render();
            } catch(e) { console.error(e); }
        }

        const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }};
        window.debouncedRender = debounce(() => render(), 300);

        function render() {
            const tb = document.getElementById('tableBody');
            const search = document.getElementById('search').value.toLowerCase();
            const fDir = document.getElementById('filterDirection').value;
            const cv = document.getElementById('cardView');
            
            tb.innerHTML = '';
            cv.innerHTML = '';

            const flt = db.filter(i => {
                if(fDir !== 'All' && i.Direction !== fDir) return false; 
                // Search in Name, Contact, City
                const term = (i["Hospital Name"] + " " + (i.Contact||"") + " " + (i.City||"")).toLowerCase();
                return term.includes(search);
            });

            // Table View
            // MODIFIED: Merged Devices column and added text coloring for Status/Satisfaction
            tb.innerHTML = flt.map(i => `
                <tr>
                    <td><strong>${i["Hospital Name"]}</strong><br><small style="color:#888">${i.Contact || ''}</small></td>
                    <td>${i.City}</td>
                    <td>${i.Device || ''} <span style="color:#888; font-size:0.85em;">${i.Tags || ''}</span></td>
                    <td style="color:${getTextColor(i.Satisfaction)}; font-weight:600;">${i.Satisfaction || '-'}</td>
                    <td style="color:${getTextColor(i.Status)}; font-weight:600;">${i.Status || '-'}</td>
                    <td><button class="btn-action" onclick="openEdit(${i._rowIndex})"><i class="fa-solid fa-pen"></i></button></td>
                </tr>
            `).join('');

            // Card View
            cv.innerHTML = flt.map(i => `
                <div class="card" onclick="openEdit(${i._rowIndex})">
                    <h3 style="margin:0 0 10px 0">${i["Hospital Name"]}</h3>
                    <p style="font-size:12px; color:#666">${i.City} | ${i.Contact || 'No Contact'}</p>
                    <div style="margin-top:10px;">
                        <span style="color:${getTextColor(i.Status)}; font-weight:bold;">${i.Status || '-'}</span>
                    </div>
                </div>
            `).join('');
            
            // If charts are visible, update them
            if(!document.getElementById('chartsView').classList.contains('hidden')) {
                renderCharts(flt);
            }
        }

        // ADDED: Text Color Helper
        function getTextColor(s) {
            if(!s) return '#666';
            s = s.toLowerCase();
            if(s.includes('renewed') || s.includes('satisfied')) return '#27ae60'; // Green
            if(s.includes('quote') || s.includes('call')) return '#2980b9'; // Blue
            if(s.includes('no answer') || s.includes('unsatisfied') || s.includes('not interested')) return '#c0392b'; // Red
            return '#666';
        }

        // ADDED: Charts Logic
        function renderCharts(data) {
            // Count Statuses
            const statusCounts = {};
            const satCounts = { 'Satisfied': 0, 'Unsatisfied': 0, 'Unknown': 0 };

            data.forEach(i => {
                const s = i.Status || 'Pending';
                statusCounts[s] = (statusCounts[s] || 0) + 1;
                
                const sat = i.Satisfaction;
                if(sat === 'Satisfied') satCounts['Satisfied']++;
                else if(sat === 'Unsatisfied') satCounts['Unsatisfied']++;
                else satCounts['Unknown']++;
            });

            // Destroy old charts
            if(chartInstances.status) chartInstances.status.destroy();
            if(chartInstances.sat) chartInstances.sat.destroy();

            // Render Status Chart
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            chartInstances.status = new Chart(ctxStatus, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Hospitals',
                        data: Object.values(statusCounts),
                        backgroundColor: '#bfa15f'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Render Satisfaction Chart
            const ctxSat = document.getElementById('satChart').getContext('2d');
            chartInstances.sat = new Chart(ctxSat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(satCounts),
                    datasets: [{
                        data: Object.values(satCounts),
                        backgroundColor: ['#27ae60', '#c0392b', '#ecf0f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // ADDED: Export Logic
        function downloadCSV() {
            if (!db || !db.length) return alert("No data to export");
            const headers = Object.keys(db[0]).filter(k => k !== '_rowIndex'); // Exclude internal index
            const csvRows = [headers.join(',')];
            
            for (const row of db) {
                const values = headers.map(header => {
                    const escaped = ('' + (row[header] || '')).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'hospital_db_full.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 4. MODAL & EDIT
        window.openEdit = function(rowIndex) {
            currentEditIndex = rowIndex; 
            const item = db.find(r => r._rowIndex === rowIndex);
            if (!item) return;

            // Header & Read-Only Info
            document.getElementById('modalTitle').innerText = item["Hospital Name"];
            document.getElementById('dispRegion').innerText = item.Region || '-';
            document.getElementById('dispCity').innerText = item.City || '-';
            document.getElementById('dispDevice').innerText = item.Device || '-';
            document.getElementById('dispSurfSN').innerText = item["Surfacide SN"] || '-';
            document.getElementById('dispAccuSN').innerText = item["AccuFIT SN"] || '-';
            document.getElementById('dispSurfUser').innerText = item["Surfacide Username"] || '-';

            // Editable Forms
            document.getElementById('editContactName').value = item.Contact || '';
            document.getElementById('editContactMobile').value = item["Contact Mobile Number"] || '';
            document.getElementById('editSat').value = item.Satisfaction || '';
            document.getElementById('editStatus').value = item.Status || ''; 
            document.getElementById('editTags').value = item.Tags || '';
            document.getElementById('editNotes').value = item.Notes || '';
            
            // Logic: Is this an uncensored number?
            const mobile = item["Contact Mobile Number"];
            const isUncensored = mobile && !mobile.includes('HIDDEN') && mobile.length > 5;
            const display = document.getElementById('displayPhone');
            const wa = document.getElementById('waLink');
            
            display.innerText = mobile || "No Number";
            
            if (isUncensored) {
                wa.classList.remove('hidden');
                // Format for WhatsApp (assuming 05xxxxxxxx -> 9665xxxxxxxx)
                let waNum = mobile.replace(/\D/g,'');
                if(waNum.startsWith('0')) waNum = '966' + waNum.substring(1);
                wa.href = `https://wa.me/${waNum}`;
                display.innerHTML = `<a href="tel:${mobile}">${mobile}</a>`;
            } else {
                wa.classList.add('hidden');
            }

            // PERMISSIONS
            const canEdit = currentUser.role === 'Admin' || currentUser.role === 'Editor';
            
            document.querySelectorAll('.secure-input').forEach(el => el.disabled = !canEdit);
            document.getElementById('saveBtn').disabled = !canEdit;
            document.getElementById('editPhoneBtn').classList.toggle('hidden', !canEdit);
            
            const btn = document.getElementById('saveBtn');
            btn.innerText = canEdit ? "Save Updates" : "Login to Edit";
            document.getElementById('loginPrompt').classList.toggle('hidden', canEdit);

            document.getElementById('editModal').style.display = 'flex';
        };

        window.promptPhoneUpdate = function() {
            const newNum = prompt("Enter new 05xxxxxxxx number:");
            if(newNum) {
                if(!/^05\d{8}$/.test(newNum)) return alert("Invalid format. Must be 05xxxxxxxx");
                document.getElementById('editContactMobile').value = newNum;
                document.getElementById('displayPhone').innerText = newNum;
            }
        };

        // --- UPDATED SAVE FUNCTION ---
        window.saveChanges = async function() {
            if (currentUser.role !== 'Admin' && currentUser.role !== 'Editor') return;
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Saving...";
            
            // Construct payload
            const updates = {
                _rowIndex: currentEditIndex,
                "Hospital Name": document.getElementById('modalTitle').innerText,
                "Contact": document.getElementById('editContactName').value,
                "Contact Mobile Number": document.getElementById('editContactMobile').value,
                "Status": document.getElementById('editStatus').value,
                "Satisfaction": document.getElementById('editSat').value,
                "Tags": document.getElementById('editTags').value,
                "Notes": document.getElementById('editNotes').value
            };

            try {
                const r = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({
                        action: 'save',
                        token: currentUser.token, // Sends token for validation
                        userEmail: currentUser.email,
                        data: updates
                    }) 
                });
                const res = await r.json();
                if(res.result === "success") {
                    alert("Saved Successfully!");
                    
                    // Update Local Data immediately
                    const localItem = db.find(i => i._rowIndex === currentEditIndex);
                    if(localItem) Object.assign(localItem, updates);
                    
                    closeModal();
                    render();
                } else {
                    alert("Error: " + res.message);
                }
            } catch(e) { 
                alert("Save failed. Check console."); 
                console.error(e); 
            }
            btn.innerText = "Save Updates";
        };

        window.closeModal = function() { document.getElementById('editModal').style.display = 'none'; };
        
        // MODIFIED: Updated switchView to handle new views and trigger chart rendering
        window.switchView = function(v) { 
            document.getElementById('tableView').classList.toggle('hidden', v!=='table');
            document.getElementById('cardView').classList.toggle('hidden', v!=='card');
            document.getElementById('chartsView').classList.toggle('hidden', v!=='charts');
            document.getElementById('exportView').classList.toggle('hidden', v!=='export');
            
            document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view===v));
            
            // Trigger render to update charts if switching to them
            if(v === 'charts') render();
        };
    </script>
</body>
</html>
