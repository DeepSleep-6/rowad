<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2d2d2d; --accent: #bfa15f; --accent-dark: #a3884d;
            --bg: #f0f2f5; --surface: #ffffff; --text: #2d2d2d; --text-light: #6c757d;
            --border: #e9ecef; 
            --active-contract: #5DADE2;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text); -webkit-font-smoothing: antialiased; display: flex; flex-direction: column; min-height: 100vh; }
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .hidden { display: none !important; }
        .p-4 { padding: 16px; } .rounded { border-radius: 8px; }

        /* Login Overlay - CHANGED: Simplified for v1.1 */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); text-align: center; width: 300px; border-top: 4px solid var(--accent); display: flex; flex-direction: column; align-items: center; }

        /* Top Bar */
        .top-bar { background: var(--surface); padding: 15px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 15px; }
        .logo-img { height: 45px; width: auto; } 
        .page-title { font-size: 20px; font-weight: 700; padding-left: 20px; border-left: 2px solid #eee; margin-left: 20px; letter-spacing: -0.5px; white-space: nowrap; }
        
        /* NEW: Vertical Divider */
        .vertical-divider { width: 1px; height: 24px; background: #dee2e6; margin: 0 10px; }

        /* User UI */
        .user-badge { background: #f1f3f5; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); }
        .role-tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #e9ecef; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .role-admin { background: #e6fcf5; color: #0ca678; border: 1px solid #c3fae8; }
        .role-rowad { background: #fff4e6; color: #d9480f; border: 1px solid #ffec99; }

        .view-btn { border: 1px solid transparent; background: transparent; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: #adb5bd; transition: 0.2s; }
        .view-btn:hover { color: var(--text); background: #f1f3f5; }
        .view-btn.active { background: #fff8e6; color: var(--accent-dark); border: 1px solid #ffe8cc; font-weight: bold; }
        
        input, select, textarea { padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; outline: none; background: #fff; font-family: inherit; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(191, 161, 95, 0.1); }
        
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; flex: 1; width: 100%; box-sizing: border-box; }
        .controls { flex-wrap: wrap; margin-bottom: 25px; }
        .search-box { flex: 2; min-width: 250px; } 
        .filter-box { flex: 1; min-width: 150px; }

        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--surface); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .data-table th { text-align: left; padding: 20px; background: #fafafa; color: #8898aa; font-weight: 700; font-size: 12px; letter-spacing: 0.8px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 18px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background-color: #fcfcfc; }
        
        .btn-action { background: #f8f9fa; color: var(--text-light); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: var(--accent); color: white; border-color: var(--accent); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-card { background: var(--surface); width: 100%; max-width: 550px; padding: 0; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; overflow-x: hidden; }
        .modal-header { padding: 25px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; }
        .modal-body { padding: 30px; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .info-item label { display: block; font-size: 12px; text-transform: uppercase; color: #999; margin-bottom: 4px; letter-spacing: 0.5px; font-weight: 600; }
        .info-item div { font-weight: 600; font-size: 14px; color: #333; }

        .secure-input:disabled { background: transparent; border: none; padding: 0; color: #2d2d2d; font-weight: 600; cursor: text; opacity: 1; -webkit-text-fill-color: #2d2d2d; }
        .secure-input:disabled + .input-icon { display: none; }
        
        .contact-box { background: #fff; border: 1px solid var(--border); padding: 15px; border-radius: 10px; transition: 0.2s; }
        .contact-box:focus-within { border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }

        .wa-btn { background: #25D366; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none; font-size: 18px; margin-left: auto; transition: 0.2s; }
        .wa-btn:hover { transform: scale(1.1); box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }
        
        .btn-save { width: 100%; padding: 16px; margin-top: 20px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; letter-spacing: 0.5px; transition: 0.2s; }
        .btn-save:hover { background: var(--accent-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(191, 161, 95, 0.3); }
        .btn-save:disabled { background: #e9ecef; color: #adb5bd; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-save.success { background: #27ae60; pointer-events: none; }

        .loading-container { text-align: center; padding: 80px 0; color: var(--text-light); }
        .spinner { width: 40px; height: 40px; border: 3px solid #e9ecef; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .tag-pill { font-size: 11px; background: #f1f3f5; padding: 3px 8px; border-radius: 12px; color: #495057; display: inline-block; margin-right: 4px; border: 1px solid #dee2e6; font-weight: 600; margin-bottom: 2px; }

        @media (max-width: 768px) { 
            .data-table { display: none; } 
            .grid-view { display: grid !important; grid-template-columns: 1fr; }
            .controls { flex-direction: column; } 
            /* CHANGED: Mobile Stack Fix */
            .top-bar { justify-content: center; padding: 15px 20px; }
            .top-bar > div { width: 100%; justify-content: center; flex-direction: column; align-items: center; gap: 10px; }
            .page-title { border: none; margin: 0; padding: 0; font-size: 18px; }
            .vertical-divider { display: none; }
            .modal-card { width: 95%; margin: 10px; max-height: 85vh; }
        }

        @media print {
            .top-bar, .controls, .view-toggles, .footer-credit, .btn-action, .dashboard-container > button { display: none !important; }
            body, .dashboard-container { background: white; margin: 0; padding: 0; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            .data-table { display: table !important; box-shadow: none; border: 1px solid #000; width: 100%; }
            .data-table th { background: #ddd !important; color: #000 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            .data-table td { border-bottom: 1px solid #000; color: #000; }
            #cardView, #chartsView, #exportView, #loading { display: none !important; }
            #tableView { display: table !important; }
        }
        
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        .card { background: var(--surface); padding: 25px; border-radius: 12px; border: 1px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); border-color: transparent; }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #e9ecef; transition: 0.2s; }
        
        .card.interacted::before { background: var(--accent); } 
        .card[data-active="true"]::before { background: var(--active-contract) !important; }

        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .chart-card { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid var(--border); flex: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.02); min-width: 300px; }
        
        label.block { color: #adb5bd; font-size: 11px; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }

        .footer-credit { text-align: center; font-size: 11px; color: #adb5bd; padding: 20px; margin-top: auto; font-weight: 500; letter-spacing: 0.5px; }
        .footer-disclaimer { display: block; font-size: 10px; color: #ced4da; margin-top: 5px; font-style: italic; opacity: 0.7; }
        
        .dashboard-container { display: none; flex-direction: column; flex: 1; }

        /* NEW: Column Picker Styles */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; text-align: left; margin: 25px 0; }
        .checkbox-item { background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #e9ecef; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .checkbox-item:hover { border-color: var(--accent); background: #fff; }
        .checkbox-item input { width: auto; margin: 0; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="margin: 0 0 25px 0; font-size: 22px; color: var(--text);">Rowad Calls Dashboard</h2>
            
            <div id="g_id_onload"
                 data-client_id="174253379694-95msalgnm4kbpjlftil4vm8o26c7h7cc.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" style="display:flex; justify-content:center;"></div>
        </div>
    </div>

    <div id="mainDashboard" class="dashboard-container">
        <div class="top-bar flex items-center justify-between">
            <div class="flex items-center" style="min-width: 200px;">
                <img src="https://alrowad-ksa.com/wp-content/uploads/2022/10/Rowad-Medical-Services_Horizontal_Logo.svg" alt="Rowad Logo" class="logo-img">
                <span class="page-title">Calls Dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="userBadge" class="user-badge">
                    <i class="fa-solid fa-user-circle" style="color:#adb5bd"></i>
                    <span id="userNameDisplay">User</span>
                    <span id="roleLabel" class="role-tag">Viewer</span>
                </div>
                
                <button onclick="logout()" style="border:none; background:none; color:#adb5bd; cursor:pointer; font-size:12px;"><i class="fa-solid fa-sign-out-alt"></i></button>

                <div class="vertical-divider"></div>

                <div class="view-toggles flex gap-2" id="viewControls">
                    <button class="view-btn active" data-view="table"><i class="fa-solid fa-table"></i></button>
                    <button class="view-btn" data-view="card"><i class="fa-solid fa-th-large"></i></button>
                    <button class="view-btn" data-view="charts"><i class="fa-solid fa-chart-pie"></i></button>
                    <button class="view-btn" data-view="export"><i class="fa-solid fa-file-export"></i></button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="controls flex gap-4">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Search Hospital, Contact..." onkeyup="debouncedRender()">
                </div>
                <div class="filter-box">
                    <select id="filterRegion" onchange="handleRegionChange()"><option value="All">All Regions</option></select>
                </div>
                <div class="filter-box">
                    <select id="filterCity" onchange="debouncedRender()"><option value="All">All Cities</option></select>
                </div>
                <div class="filter-box">
                    <select id="filterStatus" onchange="debouncedRender()">
                        <option value="All">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Quote Requested">Quote Requested</option>
                        <option value="Call Later">Call Later</option>
                        <option value="No Answer">No Answer</option>
                        <option value="Renewed">Renewed</option>
                        <option value="Active Contract">Active Contract</option>
                        <option value="Not Interested">Not Interested</option>
                    </select>
                </div>
            </div>

            <div id="loading" class="loading-container"><div class="spinner"></div><span>Loading Database...</span></div>

            <table class="data-table hidden" id="tableView">
                <thead>
                    <tr>
                        <th width="35%">Hospital</th> <th>Location</th> <th>Devices</th> <th>Satisfaction</th> <th>Status</th> <th style="text-align:right">Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            
            <div class="grid-view hidden" id="cardView"></div>

            <div id="chartsView" class="hidden">
                <div class="flex gap-4" style="flex-wrap: wrap;">
                    <div class="chart-card" style="flex: 2; min-width: 500px;">
                        <h3 style="margin-top:0; color:var(--text); font-weight:600">Sales Funnel</h3>
                        <div class="chart-wrapper"><canvas id="funnelChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3 style="margin-top:0; color:var(--text); font-weight:600">Satisfaction</h3>
                        <div class="chart-wrapper"><canvas id="satChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="exportView" class="hidden" style="text-align: center; padding-top: 40px;">
                <div class="chart-card" style="max-width: 700px; margin: 0 auto; padding: 40px;">
                    <div style="background: #fff8e6; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fa-solid fa-file-export" style="font-size: 24px; color: var(--accent);"></i>
                    </div>
                    <h2 style="margin: 0 0 10px 0;">Custom Data Export</h2>
                    <p style="color: var(--text-light); margin-bottom: 25px;">Select the columns you wish to include in your report.</p>
                    
                    <div id="columnPicker" class="checkbox-grid"></div>

                    <div class="flex gap-4" style="justify-content: center;">
                        <button onclick="downloadCSV()" class="btn-save" style="margin:0; width: auto; padding: 12px 25px;"><i class="fa-solid fa-file-csv" style="margin-right:8px"></i> Download CSV</button>
                        <button onclick="window.print()" class="btn-action" style="margin:0; background: white;"><i class="fa-solid fa-print" style="margin-right:8px"></i> Print PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-credit">
            Rowad Calls Dashboard v1.1 • Developed by Faisal Alzougbi
            <span class="footer-disclaimer">Disclaimer: This dashboard is an independently developed tool for internal workflow optimization. It is not an official asset of, nor maintained by, Rowad Medical Services.</span>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <h2 style="margin:0; font-size:20px; color:var(--text);" id="modalTitle">Hospital</h2>
                <button onclick="closeModal()" style="border:none; background:none; font-size:20px; cursor:pointer; color:#adb5bd; transition:0.2s"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="modal-body">
                <div class="info-grid">
                    <div class="info-item"><label>Region</label><div id="dispRegion">-</div></div>
                    <div class="info-item"><label>City</label><div id="dispCity">-</div></div>
                    <div class="info-item"><label>Device</label><div id="dispDevice">-</div></div>
                    <div class="info-item"><label>Surfacide SN</label><div id="dispSurfSN">-</div></div>
                    <div class="info-item"><label>AccuFIT SN</label><div id="dispAccuSN">-</div></div>
                    <div class="info-item"><label>Surfacide User</label><div id="dispSurfUser">-</div></div>
                </div>

                <div class="mb-4" style="margin-bottom: 25px;">
                    <label class="block">Contact Person</label>
                    <div class="contact-box">
                        <input type="text" id="editContactName" class="secure-input" disabled placeholder="Name">
                        <div class="flex items-center mt-2" style="margin-top:10px; border-top:1px solid #f1f3f5; padding-top:10px;">
                            <i class="fa-solid fa-phone" style="margin-right:10px; color:#adb5bd; font-size:14px;"></i> 
                            <span id="displayPhone" style="font-weight:600; font-size:14px;">***</span>
                            <a id="waLink" class="wa-btn hidden" target="_blank"><i class="fa-brands fa-whatsapp"></i></a>
                        </div>
                        <input type="hidden" id="editContactMobile">
                        <button id="editPhoneBtn" onclick="promptPhoneUpdate()" class="hidden" style="margin-top:8px; color:var(--accent); border:none; background:none; cursor:pointer; font-size:12px; font-weight:600; padding:0;">Change Number</button>
                    </div>
                </div>

                <div class="flex gap-4" style="margin-bottom:25px;">
                    <div style="flex:1">
                        <label class="block">Satisfaction</label>
                        <select id="editSat" class="secure-input" disabled>
                            <option value="">-</option>
                            <option value="Satisfied">Satisfied</option>
                            <option value="Unsatisfied">Unsatisfied</option>
                            <option value="Neutral">Neutral</option>
                        </select>
                    </div>
                    
                    <div style="flex:1">
                        <label class="block">Status</label>
                        <select id="editStatus" class="secure-input" disabled>
                            <option value="">-</option>
                            <option value="No Answer">No Answer</option>
                            <option value="Call Later">Call Later</option>
                            <option value="Quote Requested">Quote Requested</option>
                            <option value="Not Interested">Not Interested</option>
                            <option value="Renewed">Renewed</option>
                            <option value="Active Contract">Active Contract</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom:25px;">
                    <label class="block">Tags</label>
                    <input type="text" id="editTags" class="secure-input" disabled placeholder="VIP, New...">
                </div>

                <div class="mb-4">
                    <label class="block">Notes</label>
                    <textarea id="editNotes" class="secure-input" disabled style="resize:vertical; min-height:80px; line-height:1.5;" placeholder="Add notes..."></textarea>
                </div>
                
                <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>Login to Edit</button>
                <div id="loginPrompt" style="text-align:center; font-size:12px; color:#adb5bd; margin-top:12px;" class="hidden"><i class="fa-solid fa-lock" style="margin-right:5px;"></i> Only Editors can save changes</div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaush-5NL-MH3OXm7mqXdj4Gy9M9Wlv8qh8Pe7UmlaH5k7jcb4T218DDpHfD4r4B3asA/exec"; 
        
        let db = [], currentEditIndex = -1;
        let currentUser = { email: null, token: null, role: 'Public' };
        let chartInstances = {};
        const SESSION_DURATION = 9 * 60 * 60 * 1000; 

        const priorityMap = {
            "Quote Requested": 1, "Call Later": 2, "No Answer": 3, "Pending": 4,
            "Renewed": 5, "Satisfied": 5, "Active Contract": 6, "Not Interested": 7, "Unsatisfied": 7
        };
        
        const escapeHtml = (unsafe) => {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.onload = function() {
            checkSession();
            document.getElementById('viewControls').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if(btn) switchView(btn.dataset.view);
            });
        };

        function checkSession() {
            const saved = localStorage.getItem('rowad_user');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    const age = Date.now() - session.timestamp;
                    if (age < SESSION_DURATION) {
                        currentUser = session.user;
                        showDashboard();
                        fetchData(); 
                        return;
                    }
                } catch (e) { localStorage.removeItem('rowad_user'); }
            }
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        window.handleCredentialResponse = async function(response) {
            currentUser.token = response.credential;
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', token: currentUser.token })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    currentUser.email = json.email;
                    currentUser.role = json.role; 
                    localStorage.setItem('rowad_user', JSON.stringify({ user: currentUser, timestamp: Date.now() }));
                    showDashboard();
                    fetchData();
                } else {
                    alert("Login Failed: " + json.message);
                }
            } catch (e) { console.error(e); alert("Connection failed."); }
        };

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'flex'; 
            document.getElementById('userNameDisplay').innerText = currentUser.email.split('@')[0];
            const tag = document.getElementById('roleLabel');
            tag.innerText = currentUser.role;
            if (currentUser.role === 'Rowad') tag.className = 'role-tag role-rowad';
            else if (['Admin', 'Editor'].includes(currentUser.role)) tag.className = 'role-tag role-admin';
            else tag.className = 'role-tag';
        }

        window.logout = function() { localStorage.removeItem('rowad_user'); location.reload(); }

        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'fetch_data', token: currentUser.token })
                });
                const json = await res.json();
                
                if (json.result === 'error') { logout(); return; }

                db = json.data; 
                
                // NEW: Initialize Cascading Filters & Export Options
                populateFilters();
                renderExportOptions();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('tableView').classList.remove('hidden');
                render();
            } catch(e) { 
                console.error(e);
                document.getElementById('loading').innerHTML = '<span style="color:var(--text-light)">Connection Failed. <a href="javascript:location.reload()" style="color:var(--accent)">Retry</a></span>';
            }
        }

        // NEW: Cascading Filter Logic
        function populateFilters() {
            const regions = [...new Set(db.map(r => r.Region))].filter(Boolean).sort();
            const rSelect = document.getElementById('filterRegion');
            rSelect.innerHTML = '<option value="All">All Regions</option>';
            regions.forEach(r => rSelect.add(new Option(r, r)));
            
            // Initial City Populate
            handleRegionChange();
        }

        window.handleRegionChange = function() {
            const selectedRegion = document.getElementById('filterRegion').value;
            const cSelect = document.getElementById('filterCity');
            
            const relevantCities = db.filter(r => selectedRegion === 'All' || r.Region === selectedRegion)
                                     .map(r => r.City)
                                     .filter(Boolean);
            
            const uniqueCities = [...new Set(relevantCities)].sort();
            
            cSelect.innerHTML = '<option value="All">All Cities</option>';
            uniqueCities.forEach(c => cSelect.add(new Option(c, c)));
            
            debouncedRender();
        }

        // NEW: Generate Export Checkboxes
        function renderExportOptions() {
            if(!db.length) return;
            const headers = Object.keys(db[0]).filter(k => k !== '_rowIndex' && k !== 'Last Editor');
            const container = document.getElementById('columnPicker');
            
            container.innerHTML = headers.map(h => `
                <label class="checkbox-item">
                    <input type="checkbox" checked value="${h}"> ${h}
                </label>
            `).join('');
        }

        const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }};
        window.debouncedRender = debounce(() => render(), 300);

        function render() {
            const tb = document.getElementById('tableBody');
            const search = document.getElementById('search').value.toLowerCase();
            const fReg = document.getElementById('filterRegion').value;
            const fCity = document.getElementById('filterCity').value;
            const fStat = document.getElementById('filterStatus').value;
            const cv = document.getElementById('cardView');
            
            tb.innerHTML = '';
            cv.innerHTML = '';

            db.sort((a, b) => (priorityMap[a.Status||"Pending"]||5) - (priorityMap[b.Status||"Pending"]||5));

            const flt = db.filter(i => {
                const term = (i["Hospital Name"] + " " + (i.Contact||"") + " " + (i.City||"")).toLowerCase();
                if (!term.includes(search)) return false;

                if(fReg !== 'All' && i.Region !== fReg) return false;
                if(fCity !== 'All' && i.City !== fCity) return false;
                if(fStat !== 'All' && (i.Status || 'Pending') !== fStat) return false;

                return true;
            });

            const renderTags = (tags) => {
                if(!tags) return '';
                return tags.split(',').map(t => `<span class="tag-pill">${escapeHtml(t.trim())}</span>`).join('');
            };

            tb.innerHTML = flt.map(i => `
                <tr>
                    <td>
                        <div style="font-weight:600; color:#2d2d2d">${escapeHtml(i["Hospital Name"])}</div>
                        <div style="color:#888; font-size:12px; margin-top:2px;">${escapeHtml(i.Contact)}</div>
                    </td>
                    <td style="color:#555; font-size:13px;">${escapeHtml(i.City)}</td>
                    <td>
                        <div style="font-size:13px; font-weight:500;">${escapeHtml(i.Device || '-')}</div>
                        <div style="margin-top:4px;">${renderTags(i.Tags)}</div>
                    </td>
                    <td><span style="color:${getTextColor(i.Satisfaction)}; font-weight:600; font-size:13px; background:${getTextColor(i.Satisfaction)}15; padding:4px 8px; border-radius:4px;">${escapeHtml(i.Satisfaction || '-')}</span></td>
                    <td><span style="color:${getTextColor(i.Status)}; font-weight:600; font-size:13px;">${escapeHtml(i.Status || '-')}</span></td>
                    <td style="text-align:right"><button class="btn-action" onclick="openEdit(${i._rowIndex})"><i class="fa-solid fa-pen"></i></button></td>
                </tr>
            `).join('');

            cv.innerHTML = flt.map(i => {
                const s = (i.Status || 'Pending');
                const isInteracted = s !== 'Pending' && s !== '';
                const isActive = s === 'Active Contract'; 
                return `
                <div class="card ${isInteracted ? 'interacted' : ''}" data-active="${isActive}" onclick="openEdit(${i._rowIndex})">
                    <h3 style="margin:0 0 10px 0; font-size:16px;">${escapeHtml(i["Hospital Name"])}</h3>
                    <p style="font-size:12px; color:#666; margin:0 0 15px 0;">
                        <i class="fa-solid fa-location-dot" style="margin-right:5px; color:#adb5bd"></i> ${escapeHtml(i.City)}
                    </p>
                    <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f1f3f5; padding-top:15px;">
                        <span style="color:${getTextColor(i.Status)}; font-weight:600; font-size:12px;">${escapeHtml(i.Status || 'Pending')}</span>
                        ${i.Contact ? '<i class="fa-solid fa-user" style="color:#dee2e6"></i>' : ''}
                    </div>
                </div>
            `}).join('');
            
            if(!document.getElementById('chartsView').classList.contains('hidden')) renderCharts(flt);
        }

        function getTextColor(s) {
            if(!s) return '#adb5bd';
            s = s.toLowerCase();
            if(s.includes('renewed') || s.includes('satisfied')) return '#27ae60'; 
            if(s.includes('quote') || s.includes('call')) return '#2980b9'; 
            if(s.includes('active contract')) return '#5DADE2'; 
            if(s.includes('no answer') || s.includes('unsatisfied') || s.includes('not interested')) return '#d35400'; 
            if(s.includes('neutral')) return '#7f8c8d'; 
            return '#666';
        }

        function renderCharts(data) {
            const satCounts = { 'Satisfied': 0, 'Unsatisfied': 0, 'Neutral': 0 };
            
            // Funnel Metrics
            let total = data.length;
            let contacted = 0, quotes = 0, success = 0;

            data.forEach(i => {
                const s = i.Status || 'Pending';
                
                // Funnel Logic
                if (s !== 'Pending') contacted++;
                if (s === 'Quote Requested') quotes++;
                if (s === 'Renewed' || s === 'Active Contract') success++;

                // Sat Logic
                const sat = i.Satisfaction;
                if(sat === 'Satisfied') satCounts['Satisfied']++;
                else if(sat === 'Unsatisfied') satCounts['Unsatisfied']++;
                else if(sat === 'Neutral') satCounts['Neutral']++;
            });

            if(chartInstances.funnel) chartInstances.funnel.destroy();
            if(chartInstances.sat) chartInstances.sat.destroy();

            // NEW: Funnel Chart
            const ctxFunnel = document.getElementById('funnelChart').getContext('2d');
            chartInstances.funnel = new Chart(ctxFunnel, {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: ['Total Hospitals', 'Contacted', 'Quote Sent', 'Contract Active'],
                    datasets: [{
                        label: 'Funnel',
                        data: [total, contacted, quotes, success],
                        backgroundColor: ['#e9ecef', '#bfa15f', '#a3884d', '#2d2d2d'],
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } } }
                }
            });

            const ctxSat = document.getElementById('satChart').getContext('2d');
            chartInstances.sat = new Chart(ctxSat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(satCounts),
                    datasets: [{
                        data: Object.values(satCounts),
                        backgroundColor: ['#27ae60', '#d35400', '#95a5a6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function downloadCSV() {
            if (!db || !db.length) return alert("No data to export");
            
            // NEW: Get checked headers
            const checkboxes = document.querySelectorAll('#columnPicker input:checked');
            const headers = Array.from(checkboxes).map(cb => cb.value);
            
            if(!headers.length) return alert("Please select at least one column.");

            const csvRows = [headers.join(',')];
            
            for (const row of db) {
                const values = headers.map(header => {
                    const escaped = ('' + (row[header] || '')).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'hospital_db_custom.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.openEdit = function(rowIndex) {
            currentEditIndex = rowIndex; 
            const item = db.find(r => r._rowIndex === rowIndex);
            if (!item) return;

            const lastEditor = item["Last Editor"] || "Unknown";
            document.getElementById('modalTitle').innerHTML = `
                ${escapeHtml(item["Hospital Name"])}
                <div style="font-size:10px; color:#adb5bd; font-weight:400; margin-top:4px;">Last updated by: ${escapeHtml(lastEditor)}</div>
            `;
            
            document.getElementById('dispRegion').innerText = item.Region || '-';
            document.getElementById('dispCity').innerText = item.City || '-';
            document.getElementById('dispDevice').innerText = item.Device || '-';
            document.getElementById('dispSurfSN').innerText = item["Surfacide SN"] || '-';
            document.getElementById('dispAccuSN').innerText = item["AccuFIT SN"] || '-';
            document.getElementById('dispSurfUser').innerText = item["Surfacide Username"] || '-';

            document.getElementById('editContactName').value = item.Contact || '';
            document.getElementById('editContactMobile').value = item["Contact Mobile Number"] || '';
            document.getElementById('editSat').value = item.Satisfaction || '';
            document.getElementById('editStatus').value = item.Status || ''; 
            document.getElementById('editTags').value = item.Tags || '';
            document.getElementById('editNotes').value = item.Notes || '';
            
            const mobile = item["Contact Mobile Number"];
            const isUncensored = mobile && !mobile.includes('HIDDEN') && mobile.length > 5;
            const display = document.getElementById('displayPhone');
            const wa = document.getElementById('waLink');
            
            display.innerText = mobile || "No Number";
            
            if (isUncensored) {
                wa.classList.remove('hidden');
                
                const match = mobile.match(/(05\d{8})/);
                if (match) {
                    let waNum = '966' + match[0].substring(1);
                    const message = "يرجى المشاركة في هذا التقييم كجزء من جهودنا المستمرة لخدمتكم بشكل أفضل: https://forms.gle/DfmEtq8LftRDrAqz5";
                    const encodedMsg = encodeURIComponent(message);
                    wa.href = `https://wa.me/${waNum}?text=${encodedMsg}`;
                } else {
                    wa.classList.add('hidden'); 
                }
                display.innerHTML = mobile; 
            } else { wa.classList.add('hidden'); }

            const canEdit = currentUser.role === 'Admin' || currentUser.role === 'Editor';
            
            document.querySelectorAll('.secure-input').forEach(el => el.disabled = !canEdit);
            document.getElementById('saveBtn').disabled = !canEdit;
            document.getElementById('editPhoneBtn').classList.toggle('hidden', !canEdit);
            
            const btn = document.getElementById('saveBtn');
            btn.innerText = canEdit ? "Save Updates" : "Login to Edit";
            document.getElementById('loginPrompt').classList.toggle('hidden', canEdit);

            document.getElementById('editModal').style.display = 'flex';
        };

        window.promptPhoneUpdate = function() {
            const current = document.getElementById('editContactMobile').value;
            const newNum = prompt("Update Contact Numbers (comma separated):", current);
            if(newNum !== null) {
                document.getElementById('editContactMobile').value = newNum;
                document.getElementById('displayPhone').innerText = newNum;
            }
        };

        window.saveChanges = async function() {
            if (currentUser.role !== 'Admin' && currentUser.role !== 'Editor') return;
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            
            const dateStr = new Date().toLocaleDateString('en-GB'); 
            const editorStr = `${currentUser.email} on ${dateStr}`;

            const updates = {
                _rowIndex: currentEditIndex,
                "Contact": document.getElementById('editContactName').value,
                "Contact Mobile Number": document.getElementById('editContactMobile').value,
                "Status": document.getElementById('editStatus').value,
                "Satisfaction": document.getElementById('editSat').value,
                "Tags": document.getElementById('editTags').value,
                "Notes": document.getElementById('editNotes').value,
                "Last Editor": editorStr
            };

            try {
                const r = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({
                        action: 'save',
                        token: currentUser.token, userEmail: currentUser.email, data: updates
                    }) 
                });
                const res = await r.json();
                if(res.result === "success") {
                    const localItem = db.find(i => i._rowIndex === currentEditIndex);
                    if(localItem) Object.assign(localItem, updates);
                    render();
                    btn.classList.add('success');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
                    setTimeout(() => { btn.classList.remove('success'); btn.innerText = originalText; }, 2000);
                } else { alert("Error: " + res.message); btn.innerText = originalText; }
            } catch(e) { alert("Save failed. Check console."); console.error(e); btn.innerText = originalText; }
        };

        window.closeModal = function() { document.getElementById('editModal').style.display = 'none'; };
        
        window.switchView = function(v) { 
            document.getElementById('tableView').classList.toggle('hidden', v!=='table');
            document.getElementById('cardView').classList.toggle('hidden', v!=='card');
            document.getElementById('chartsView').classList.toggle('hidden', v!=='charts');
            document.getElementById('exportView').classList.toggle('hidden', v!=='export');
            document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view===v));
            if(v === 'charts') render();
        };
    </script>
</body>
</html>
