<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calls Dashboard</title>
    <link rel="icon" href="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CSS VARIABLES & THEME ENGINE --- */
        :root {
            /* Light Mode (Default) */
            --primary: #2d2d2d; 
            --accent: #A88B4D; 
            --accent-dark: #8c7335;
            --bg: #f0f2f5; 
            --surface: #ffffff; 
            --text: #2d2d2d; 
            --text-light: #6c757d;
            --border: #e9ecef; 
            --input-bg: #ffffff;
            
            /* Status Colors */
            --active-contract: #5DADE2;
            --success: #27ae60;
            --warning: #f1c40f;
            --danger: #e74c3c;

            /* Typography settings */
            --font-stack: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --fs-xs: 12px;
            --fs-sm: 13px;
            --fs-base: 14px;
            --fs-lg: 16px;
            --fs-xl: 20px;
            
            /* Spacing (Dynamic for Compact Mode) */
            --sp-card: 25px;
            --sp-cell: 20px;
        }

        /* Dark Mode Overrides */
        body.dark-theme {
            --primary: #e0e0e0;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #e0e0e0;
            --text-light: #a0a0a0;
            --border: #333333;
            --input-bg: #2d2d2d;
        }

        /* Compact Mode Overrides */
        body.compact-mode {
            --fs-xs: 11px;
            --fs-sm: 12px;
            --fs-base: 13px;
            --fs-lg: 15px;
            --fs-xl: 18px;
            --sp-card: 15px;
            --sp-cell: 10px;
        }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        body {
            font-family: var(--font-stack);
            background: var(--bg);
            margin: 0;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        input, button, select, textarea { 
            font-family: var(--font-stack); 
        }

        /* Utility Classes */
        .text-xs { font-size: var(--fs-xs); }
        .text-sm { font-size: var(--fs-sm); } 
        .text-base { font-size: var(--fs-base); }
        .text-lg { font-size: var(--fs-lg); }
        .text-xl { font-size: var(--fs-xl); }
        .text-muted { color: var(--text-light); }
        .text-dark { color: var(--text); }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mr-2 { margin-right: 8px; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .p-4 { padding: 16px; }
        .rounded { border-radius: 8px; }

        /* --- COMPONENTS --- */
        
        /* Login Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 2000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-card {
            background: var(--surface); padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05); text-align: center; width: 300px;
            border-top: 4px solid var(--accent);
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        .login-error {
            color: #d35400; background: #fdf2e9; padding: 10px;
            border-radius: 8px; font-size: 12px; margin-top: 15px;
            width: 100%; display: none; border: 1px solid #fadbd8;
        }

        /* Top Bar */
        .top-bar {
            background: var(--surface); padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-bottom: 3px solid var(--accent);
            position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 15px;
            transition: background 0.3s;
        }
        .logo-img { height: 45px; width: auto; }
        .page-title {
            font-size: var(--fs-xl); font-weight: 700; padding-left: 20px;
            border-left: 2px solid var(--border); margin-left: 20px;
            letter-spacing: -0.5px; white-space: nowrap; color: var(--text);
        }
        .vertical-divider { width: 1px; height: 24px; background: var(--border); margin: 0 10px; }

        /* User Badge */
        .user-badge {
            background: var(--bg); padding: 6px 14px; border-radius: 30px;
            font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px;
            border: 1px solid var(--border); cursor: pointer; transition: 0.2s; color: var(--text);
        }
        .user-badge:hover { border-color: var(--accent); }
        
        .role-tag {
            font-size: 10px; padding: 3px 8px; border-radius: 6px;
            background: var(--border); color: var(--text-light); text-transform: uppercase;
            letter-spacing: 0.5px; font-weight: 700;
        }
        .role-admin { background: rgba(39, 174, 96, 0.1); color: #27ae60; border: 1px solid rgba(39, 174, 96, 0.2); }
        .role-rowad { background: rgba(211, 84, 0, 0.1); color: #d35400; border: 1px solid rgba(211, 84, 0, 0.2); }

        /* View Toggle Buttons */
        .view-btn {
            border: 1px solid transparent; background: transparent; padding: 8px 12px;
            cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s;
        }
        .view-btn:hover { color: var(--text); background: var(--bg); }
        .view-btn.active {
            background: rgba(168, 139, 77, 0.1); color: var(--accent);
            border: 1px solid rgba(168, 139, 77, 0.3); font-weight: bold;
        }

        /* Form Controls */
        input, select, textarea {
            padding: 12px 16px; border: 1px solid var(--border);
            border-radius: 8px; width: 100%; box-sizing: border-box;
            outline: none; background: var(--input-bg); transition: 0.2s;
            color: var(--text);
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent); box-shadow: 0 0 0 3px rgba(168, 139, 77, 0.1);
        }

        /* Main Container */
        .container {
            max-width: 1400px; margin: 30px auto; padding: 0 20px;
            flex: 1; width: 100%; box-sizing: border-box;
        }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .search-box { flex: 1; }
        
        .filter-toggle-btn {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text-light); width: 45px; height: 45px;
            border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 18px; transition: 0.2s;
        }
        .filter-toggle-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .filter-panel {
            display: none; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; background: var(--surface); padding: 20px;
            border-radius: 12px; border: 1px solid var(--border);
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            animation: slideDown 0.3s ease-out;
        }
        .filter-panel.show { display: grid; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Data Table */
        .data-table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            background: var(--surface); border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border);
        }
        .data-table th {
            text-align: left; padding: 20px; background: var(--bg);
            color: var(--text-light); font-weight: 700; font-size: var(--fs-sm);
            letter-spacing: 0.8px; text-transform: uppercase; border-bottom: 1px solid var(--border);
        }
        .data-table td {
            padding: var(--sp-cell) 20px; border-bottom: 1px solid var(--border); vertical-align: middle;
            color: var(--text);
        }
        .data-table tr:hover td { background-color: rgba(0,0,0,0.02); }

        /* Buttons */
        .btn-action {
            background: var(--bg); color: var(--text-light); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        .btn-action:hover { background: var(--accent); color: white; border-color: var(--accent); }

        .btn-save {
            width: 100%; padding: 16px; margin-top: 10px;
            background: var(--accent); color: white; border: none;
            border-radius: 10px; cursor: pointer; font-size: 15px;
            font-weight: 600; letter-spacing: 0.5px; transition: 0.2s;
        }
        .btn-save:hover { background: var(--accent-dark); transform: translateY(-1px); }
        .btn-save:disabled { background: var(--border); color: var(--text-light); cursor: not-allowed; transform: none; }
        .btn-save.success { background: var(--success); pointer-events: none; }

        .wa-btn {
            background: #25D366; color: white; border: none; border-radius: 50%;
            width: 36px; height: 36px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; text-decoration: none;
            font-size: 18px; margin-left: auto; transition: 0.2s;
        }

        /* Cards & Grid */
        .grid-view {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .card {
            background: var(--surface); padding: var(--sp-card); border-radius: 12px;
            border: 1px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden;
        }
        .card:hover {
            transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.08);
            border-color: transparent;
        }
        .card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 4px; background: var(--border); transition: 0.2s;
        }
        .card.interacted::before { background: var(--accent); }
        .card[data-active="true"]::before { background: var(--active-contract) !important; }

        /* Settings (Admin) Panel */
        .admin-section-title {
            font-size: 16px; font-weight: 700; margin-bottom: 15px;
            color: var(--primary); display: flex; align-items: center; gap: 10px;
        }
        .admin-card {
            background: var(--bg); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); height: 100%; box-sizing: border-box;
        }
        .settings-stack { display: flex; flex-direction: column; gap: 20px; }

        /* Logs in Settings */
        .audit-log-item {
            padding: 12px; border-bottom: 1px solid var(--border); font-size: var(--fs-sm);
            background: var(--surface); margin-bottom: 5px; border-radius: 6px;
        }
        .audit-log-item:last-child { border-bottom: none; margin-bottom: 0; }
        .audit-time { color: var(--text-light); font-size: var(--fs-xs); font-weight: 600; margin-bottom: 4px; }
        .audit-change span { font-weight: 700; color: var(--primary); }
        .audit-change .old-val { color: var(--danger); text-decoration: line-through; opacity: 0.7; }
        .audit-change .new-val { color: var(--success); }

        /* Edit Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center;
            align-items: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-card {
            background: var(--surface); width: 100%; max-width: 650px;
            padding: 0; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            max-height: 90vh; overflow-y: auto; overflow-x: hidden;
        }
        .modal-header {
            padding: 20px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; background: var(--surface);
        }
        .modal-body { padding: 30px; }

        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 25px; background: var(--bg); padding: 20px;
            border-radius: 12px; border: 1px solid var(--border);
        }
        .info-item label {
            display: block; font-size: var(--fs-sm); text-transform: uppercase;
            color: var(--text-light); margin-bottom: 4px; letter-spacing: 0.5px; font-weight: 600;
        }
        .info-item div { font-weight: 600; font-size: var(--fs-base); color: var(--text); }

        .input-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .contact-box {
            background: var(--input-bg); border: 1px solid var(--border); padding: 15px;
            border-radius: 10px; transition: 0.2s; height: 100%; box-sizing: border-box;
        }
        
        .secure-input:disabled {
            background: transparent; border: none; padding: 0;
            color: var(--text); font-weight: 600; cursor: text;
            opacity: 1; -webkit-text-fill-color: var(--text);
        }

        .tag-pill {
            font-size: 11px; background: var(--bg); padding: 3px 8px;
            border-radius: 12px; color: var(--text-light); display: inline-block;
            margin-right: 4px; border: 1px solid var(--border); font-weight: 600; margin-bottom: 2px;
        }

        /* Charts */
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .chart-card {
            background: var(--surface); padding: 30px; border-radius: 16px;
            border: 1px solid var(--border); flex: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02); min-width: 300px;
        }

        /* Footer & Misc */
        label.block {
            color: var(--text-light); font-size: var(--fs-xs); text-transform: uppercase;
            font-weight: 700; margin-bottom: 8px; display: block; letter-spacing: 0.5px;
        }
        
        .footer-credit {
            text-align: center; font-size: 11px; color: var(--text-light);
            padding: 20px; margin-top: auto; font-weight: 500; letter-spacing: 0.5px;
            width: 100%; box-sizing: border-box;
        }
        
        #loginOverlay .footer-credit { position: absolute; bottom: 20px; }

        .version-display { font-weight: bold; }
        
        .dashboard-container { display: none; flex-direction: column; flex: 1; }
        .checkbox-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px; text-align: left; margin: 25px 0;
        }
        
        .loading-container { text-align: center; padding: 80px 0; color: var(--text-light); }
        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Media Queries */
        @media (max-width: 768px) {
            .data-table, .vertical-divider { display: none; }
            .grid-view { display: grid !important; grid-template-columns: 1fr; }
            .top-bar { justify-content: center; }
            .top-bar > div { width: 100%; justify-content: center; }
            .modal-card { width: 95%; margin: 10px; }
            .input-grid-2 { grid-template-columns: 1fr; }
        }
        
        @media print {
            .no-print, .top-bar, .controls { display: none !important; }
            .data-table { display: table !important; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 class="text-dark mb-1" style="font-size: 22px">Rowad Calls Dashboard</h2>
            <div id="g_id_onload" 
                 data-client_id="174253379694-95msalgnm4kbpjlftil4vm8o26c7h7cc.apps.googleusercontent.com" 
                 data-callback="handleCredentialResponse" 
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" 
                 data-type="standard" 
                 data-shape="pill" 
                 data-theme="outline" 
                 data-size="large" 
                 data-logo_alignment="left" 
                 style="display:flex;justify-content:center; margin-top: 20px;">
            </div>
            <div id="loginError" class="login-error"></div>
        </div>
        <div class="footer-credit">
            Rowad Calls Dashboard <span class="version-display">v2.12</span> • Developed by Faisal Alzougbi
            <span style="display:block;margin-top:5px;font-style:italic;opacity:0.7">
                Disclaimer: This dashboard is an independently developed tool for internal workflow optimization. It is not an official asset of, nor maintained by, Rowad Medical Services.
            </span>
        </div>
    </div>

    <div id="announcementBanner" style="background:#fff3cd;color:#856404;padding:10px;text-align:center;font-size:13px;font-weight:600;display:none;border-bottom:1px solid #ffeeba"></div>

    <div id="mainDashboard" class="dashboard-container">
        <div class="top-bar flex items-center justify-between no-print">
            <div class="flex items-center" style="min-width:200px">
                <img src="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico" alt="Rowad Logo" class="logo-img">
                <span class="page-title">Calls Dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="userBadge" class="user-badge" onclick="logout()">
                    <i class="fa-solid fa-user-circle" style="color:var(--text-light)"></i>
                    <span id="userNameDisplay">User</span>
                    <span id="roleLabel" class="role-tag">Viewer</span>
                </div>
                <div class="vertical-divider"></div>
                <div class="view-toggles flex gap-2" id="viewControls">
                    <button class="view-btn active" data-view="table"><i class="fa-solid fa-table"></i></button>
                    <button class="view-btn" data-view="card"><i class="fa-solid fa-th-large"></i></button>
                    <button class="view-btn" data-view="charts"><i class="fa-solid fa-chart-pie"></i></button>
                    <button class="view-btn" data-view="export"><i class="fa-solid fa-file-export"></i></button>
                    <button class="view-btn" id="settingsBtn" data-view="settings"><i class="fa-solid fa-cog"></i></button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="controls no-print">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Search Hospital, Contact..." onkeyup="debouncedRender()">
                </div>
                
                <div class="filter-box" style="margin-bottom:0; width: 150px;">
                    <select id="sortBy" onchange="renderDashboard()">
                        <option value="Priority">Sort: Priority</option>
                        <option value="Alphabetical">Sort: A-Z</option>
                        <option value="Location">Sort: City</option>
                        <option value="Device">Sort: Device</option>
                    </select>
                </div>

                <button class="filter-toggle-btn" onclick="toggleFilters()">
                    <i class="fa-solid fa-filter"></i>
                </button>
            </div>

            <div id="filterPanel" class="filter-panel no-print"></div>
            <div id="loading" class="loading-container">
                <div class="spinner"></div><span>Loading Database...</span>
            </div>

            <table class="data-table hidden" id="tableView">
                <thead>
                    <tr>
                        <th width="35%">Hospital</th>
                        <th>Location</th>
                        <th>Devices</th>
                        <th>Satisfaction</th>
                        <th>Status</th>
                        <th style="text-align:right">Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>

            <div class="grid-view hidden" id="cardView"></div>

            <div id="chartsView" class="hidden">
                <h3 class="text-dark font-bold mb-4" style="font-size:18px;margin-top:0">Overview</h3>
                <div class="flex gap-4 mb-4" style="flex-wrap:wrap">
                    <div class="chart-card">
                        <h3 class="text-dark font-semibold mt-1">Device Ownership</h3>
                        <div class="chart-wrapper"><canvas id="deviceChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3 class="text-dark font-semibold mt-1">Satisfaction</h3>
                        <div class="chart-wrapper"><canvas id="satChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3 class="text-dark font-semibold mt-1">Sales Funnel</h3>
                        <div class="chart-wrapper"><canvas id="funnelChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3 class="text-dark font-semibold mt-1">Call Outcomes</h3>
                        <div class="chart-wrapper"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>
                <h3 class="text-dark font-bold mb-4" style="font-size:18px;margin-top:30px">Team Performance</h3>
                <div class="input-grid-2">
                    <div class="chart-card">
                        <h3 class="text-dark font-semibold mt-1">Total Activities (Unique Visits)</h3>
                        <div class="chart-wrapper"><canvas id="activityChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3 class="text-dark font-semibold mt-1">Quotations Generated</h3>
                        <div class="chart-wrapper"><canvas id="quoteChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="exportView" class="hidden text-center" style="padding-top:40px">
                <div class="chart-card" style="max-width:700px;margin:0 auto;padding:40px">
                    <div style="background:#fff8e6;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
                        <i class="fa-solid fa-file-export" style="font-size:24px;color:var(--accent)"></i>
                    </div>
                    <h2 class="mb-2" style="margin-top:0">Custom Data Export</h2>
                    <p class="text-muted mb-4">Select the columns you wish to include in your report.</p>
                    <div id="columnPicker" class="checkbox-grid"></div>
                    <div class="flex gap-4 justify-center" style="justify-content:center">
                        <button onclick="downloadCSV()" class="btn-save" style="margin:0;width:auto;padding:12px 25px">
                            <i class="fa-solid fa-file-csv mr-2"></i> Download CSV
                        </button>
                        <button onclick="window.print()" class="btn-action" style="margin:0;background:white">
                            <i class="fa-solid fa-print mr-2"></i> Print PDF
                        </button>
                    </div>
                </div>
            </div>

            <div id="settingsView" class="hidden" style="padding-top:20px">
                <div class="settings-stack">
                    
                    <div class="chart-card" style="height: auto;">
                        <h3 class="admin-section-title"><i class="fa-solid fa-palette"></i> Theme Customizer</h3>
                        <p class="text-muted text-xs mb-4">Personalize your viewing experience (Saved Locally).</p>
                        
                        <div class="input-grid-2">
                            <div class="flex items-center gap-4 p-4 rounded" style="background: var(--bg);">
                                <input type="color" id="adminColor" value="#A88B4D" style="width: 50px; height: 40px; padding: 2px;" onchange="updateTheme()">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold">Accent Color</span>
                                    <span class="text-xs text-muted">Primary brand color</span>
                                </div>
                            </div>

                            <div class="flex items-center gap-4 p-4 rounded" style="background: var(--bg);">
                                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" style="margin-right: 10px; width: 20px; height: 20px;">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold">Night Mode</span>
                                    <span class="text-xs text-muted">Toggle dark theme</span>
                                </div>
                            </div>

                            <div class="flex items-center gap-4 p-4 rounded" style="background: var(--bg);">
                                <input type="checkbox" id="compactModeToggle" onchange="toggleCompactMode()" style="margin-right: 10px; width: 20px; height: 20px;">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold">Compact Mode</span>
                                    <span class="text-xs text-muted">Fit more data on screen</span>
                                </div>
                            </div>

                            <div class="p-4 rounded" style="background: var(--bg);">
                                <label class="block">Font Family</label>
                                <select id="fontSelector" onchange="updateFont()">
                                    <option value="'Segoe UI', system-ui, sans-serif">Modern (Default)</option>
                                    <option value="'Times New Roman', serif">Classic (Serif)</option>
                                    <option value="'Courier New', monospace">Technical (Mono)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" style="height: auto;">
                        <h3 class="admin-section-title"><i class="fa-solid fa-trophy"></i> Your Impact</h3>
                        <div id="impactWidget" class="flex items-center justify-between">
                            </div>
                    </div>

                    <div class="chart-card" style="height: auto;">
                        <h3 class="admin-section-title"><i class="fa-solid fa-history"></i> Data Editing History</h3>
                        <p class="text-muted text-xs mb-4">Showing last 50 edits.</p>
                        <div id="auditLogContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="chart-card" style="height: auto;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="admin-section-title" style="margin:0"><i class="fa-solid fa-code-branch"></i> System Version History</h3>
                            <button id="addVerBtn" class="btn-action hidden" onclick="toggleAddVersion()">+ Add Entry</button>
                        </div>
                        
                        <div id="addVersionForm" class="hidden mb-4 p-4" style="background: var(--bg); border-radius: 8px;">
                            <div class="input-grid-2">
                                <input type="text" id="newVerNum" placeholder="Version (e.g. 2.11)">
                                <input type="text" id="newVerDate" placeholder="Date (DD/MM/YYYY)">
                            </div>
                            <textarea id="newVerDesc" placeholder="Description of changes..." style="min-height: 60px; margin-bottom: 10px;"></textarea>
                            <button class="btn-save" onclick="submitVersionEntry()">Save Entry</button>
                        </div>

                        <div id="changelogContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                </div>
            </div>
        </div>

        <div class="footer-credit">
            Rowad Calls Dashboard <span class="version-display">v2.12</span> • Developed by Faisal Alzougbi
            <span style="display:block;margin-top:5px;font-style:italic;opacity:0.7">
                Disclaimer: This dashboard is an independently developed tool for internal workflow optimization. It is not an official asset of, nor maintained by, Rowad Medical Services.
            </span>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <div>
                    <h2 class="text-dark" style="margin:0;font-size:20px" id="modalTitle">Hospital</h2>
                    <div id="modalSubtitle" class="text-muted text-xs mt-1 font-normal"></div>
                </div>
                <button onclick="closeModal()" style="border:none;background:none;font-size:20px;cursor:pointer;color:var(--text-light);transition:0.2s">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="info-grid">
                    <div class="info-item"><label>Region</label><div id="dispRegion">-</div></div>
                    <div class="info-item"><label>City</label><div id="dispCity">-</div></div>
                    <div class="info-item"><label>Device</label><div id="dispDevice">-</div></div>
                    <div class="info-item"><label>Surfacide SN</label><div id="dispSurfSN">-</div></div>
                    <div class="info-item"><label>AccuFIT SN</label><div id="dispAccuSN">-</div></div>
                    <div class="info-item"><label>Surfacide User</label><div id="dispSurfUser">-</div></div>
                </div>

                <div class="input-grid-2">
                    <div>
                        <label class="block">Contact Person</label>
                        <div class="contact-box">
                            <input type="text" id="editContactName" class="secure-input" disabled placeholder="Name">
                            <div class="flex items-center mt-2" style="border-top:1px solid var(--border);padding-top:10px">
                                <i class="fa-solid fa-phone" style="margin-right:10px;color:var(--text-light);font-size:14px"></i>
                                <span id="displayPhone" style="font-weight:600;font-size:14px">***</span>
                                <a id="waLink" class="wa-btn hidden" target="_blank"><i class="fa-brands fa-whatsapp"></i></a>
                            </div>
                            <input type="hidden" id="editContactMobile">
                            <button id="editPhoneBtn" onclick="promptPhoneUpdate()" class="hidden" style="margin-top:8px;color:var(--accent);border:none;background:none;cursor:pointer;font-size:12px;font-weight:600;padding:0">
                                Change Number
                            </button>
                        </div>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:15px">
                        <div>
                            <label class="block">Status</label>
                            <select id="editStatus" class="secure-input" disabled>
                                <option value="">-</option>
                                <option value="No Answer">No Answer</option>
                                <option value="Call Later">Call Later</option>
                                <option value="Interested">Interested</option>
                                <option value="Quote Requested">Quote Requested</option>
                                <option value="Not Interested">Not Interested</option>
                                <option value="Renewed">Renewed</option>
                                <option value="Active Contract">Active Contract</option>
                            </select>
                        </div>
                        <div>
                            <label class="block">Satisfaction</label>
                            <select id="editSat" class="secure-input" disabled>
                                <option value="">-</option>
                                <option value="Satisfied">Satisfied</option>
                                <option value="Unsatisfied">Unsatisfied</option>
                                <option value="Neutral">Neutral</option>
                            </select>
                        </div>
                        <div>
                            <label class="block">Tags</label>
                            <input type="text" id="editTags" class="secure-input" disabled placeholder="VIP, New...">
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block">Notes</label>
                    <textarea id="editNotes" class="secure-input" disabled style="resize:vertical;min-height:80px;line-height:1.5" placeholder="Add notes..."></textarea>
                </div>

                <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>Login to Edit</button>
                <div id="loginPrompt" class="text-center text-muted text-sm mt-2 hidden">
                    <i class="fa-solid fa-lock mr-2"></i> Only Editors can save changes
                </div>
            </div>
        </div>
    </div>

<script>
/**
 * =========================================================================================
 * AI PROTOCOL & SYSTEM CONFIGURATION
 * =========================================================================================
 */
const AI_PROTOCOL = `
1. SURGICAL PRECISION PROTOCOL:
   - You are prohibited from refactoring, reorganizing, or "cleaning" existing code.
   - Modify ONLY the specific lines required by the user's request.
   - Treat all surrounding code as immutable infrastructure.

2. MANDATORY VERSION CONTROL:
   - Every code modification triggers a mandatory version update.
   - You must increment the version number in the CHANGELOG constant.
   - You must append a human-readable summary of changes to the CHANGELOG.

3. EXPLICIT CONSENT GATE:
   - Do not output any code until the user gives explicit "Green Light" or confirmation.
   - First, explain your plan. Then wait.

4. ZERO-RETENTION DELETION:
   - When asked to remove a feature, DELETE the code entirely.
   - Do not hide it, comment it out, or restrict it to specific roles.
   - The code must be physically removed from the file.
`;

const APP_VERSION = "2.12";

// Mutable Changelog to support Admin Edits
let systemChangelog = [
    { v: "2.12", d: "22/01/2026", t: "Added Persistent Theme Settings (LocalStorage), Data Editing History with City lookup, Sorting Options, Compact Mode, and Personal Impact Widget." },
    { v: "2.11", d: "22/01/2026", t: "Added Night Mode, Font Chooser, and Colored Outcomes Chart. Fixed Footer positioning." },
    { v: "2.10", d: "22/01/2026", t: "Fixed login centering, refined chart logic to count unique visits, reorganized settings page vertically, added Admin Changelog editing." },
    { v: "2.9", d: "22/01/2026", t: "Fixed footer version color, standard date formatting (DD/MM/YYYY), and hard deletion of legacy admin config." },
    { v: "2.8", d: "22/01/2026", t: "Standardized fonts, removed Theme Studio, moved Version History to Settings, added Data Audit Log to Settings, cleaned up Edit Modal." },
    { v: "2.7", d: "22/01/2026", t: "Complete Code Refactor: De-minified source, standardized fonts, global settings page, and fixed version link logic." }
];

/* --- CONSTANTS --- */
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwaush-5NL-MH3OXm7mqXdj4Gy9M9Wlv8qh8Pe7UmlaH5k7jcb4T218DDpHfD4r4B3asA/exec";

const STATUS_PRIORITY = {
    "Quote Requested": 1,
    "Interested": 1,
    "Call Later": 2,
    "No Answer": 3,
    "Pending": 4,
    "Renewed": 5,
    "Satisfied": 5,
    "Active Contract": 6
};

/* --- STATE MANAGEMENT --- */
let callsDatabase = [];
let auditHistory = [];
let userMapping = {};
let chartInstances = {};
let currentRowIndex = -1;
let debounceTimeout;
let currentUser = { email: null, role: 'Public', token: null, id: null };

/* --- HELPER FUNCTIONS --- */
const getById = (id) => document.getElementById(id);

const formatDate = (date) => {
    if (!date) return '-';
    return new Date(date).toLocaleDateString('en-GB'); 
};

const getChartOptions = (axis = 'x') => ({
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: { [axis]: { grid: { display: false } } }
});

const getStatusColor = (status) => {
    status = status || '';
    if (status.match(/Renew|Satis/)) return '#27ae60'; // Green
    if (status.match(/Quote|Call|Interest/)) return '#2980b9'; // Blue
    if (status.match(/Active/)) return '#5DADE2'; // Light Blue
    if (status.match(/No|Not|Un/)) return '#d35400'; // Red/Orange
    return '#666'; // Grey
};

const escapeHtml = (text) => {
    return (text || '').toString().replace(/&/g, "&amp;").replace(/</g, "&lt;");
};

/* --- INITIALIZATION --- */
window.onload = () => {
    loadLocalPrefs(); // Load saved theme settings immediately
    initApp();
    getById('viewControls').onclick = (e) => {
        const btn = e.target.closest('button');
        if (btn) switchView(btn.dataset.view);
    };
    updateVersionDisplay();
};

function updateVersionDisplay() {
    const versionElements = document.querySelectorAll('.version-display');
    versionElements.forEach(el => {
        el.innerText = `v${APP_VERSION}`;
    });
}

async function callApi(action, payload = {}) {
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({ action: action, token: currentUser.token, ...payload })
        });
        return await response.json();
    } catch (e) {
        return { result: 'error', message: 'Connection Error' };
    }
}

async function initApp() {
    try {
        const session = JSON.parse(localStorage.getItem('rowad_u'));
        if (session && session.user && Date.now() - session.timestamp < 32400000) {
            currentUser = session.user;
            initUserUI();
            getById('loginOverlay').style.display = 'none';
            getById('mainDashboard').style.display = 'flex';
            fetchDashboardData();
            return;
        }
    } catch (e) { }
    getById('loginOverlay').style.display = 'flex';
}

/* --- PERSISTENCE LAYER --- */
function saveLocalPrefs() {
    const prefs = {
        accent: getById('adminColor').value,
        dark: getById('darkModeToggle').checked,
        compact: getById('compactModeToggle').checked,
        font: getById('fontSelector').value
    };
    localStorage.setItem('rowad_prefs', JSON.stringify(prefs));
}

function loadLocalPrefs() {
    try {
        const prefs = JSON.parse(localStorage.getItem('rowad_prefs'));
        if (prefs) {
            if (prefs.accent) {
                getById('adminColor').value = prefs.accent;
                document.documentElement.style.setProperty('--accent', prefs.accent);
            }
            if (prefs.dark) {
                getById('darkModeToggle').checked = true;
                document.body.classList.add('dark-theme');
            }
            if (prefs.compact) {
                getById('compactModeToggle').checked = true;
                document.body.classList.add('compact-mode');
            }
            if (prefs.font) {
                getById('fontSelector').value = prefs.font;
                document.documentElement.style.setProperty('--font-stack', prefs.font);
            }
        }
    } catch (e) { }
}

/* --- AUTHENTICATION --- */
window.handleCredentialResponse = async (response) => {
    currentUser.token = response.credential;
    const result = await callApi('login');
    
    if (result.result === 'success') {
        currentUser = {
            email: result.email,
            role: result.role,
            id: result.id,
            token: response.credential
        };
        localStorage.setItem('rowad_u', JSON.stringify({ user: currentUser, timestamp: Date.now() }));
        getById('loginOverlay').style.display = 'none';
        initUserUI();
        fetchDashboardData();
    } else {
        const errorEl = getById('loginError');
        errorEl.innerText = "Login Failed: " + (result.message || "Unknown");
        errorEl.style.display = 'block';
    }
};

function initUserUI() {
    getById('userNameDisplay').innerText = currentUser.id || currentUser.email.split('@')[0];
    const roleLabel = getById('roleLabel');
    roleLabel.innerText = currentUser.role;
    getById('mainDashboard').style.display = 'flex';
    
    let roleClass = '';
    if (currentUser.role === 'Rowad') roleClass = 'role-rowad';
    else if (['Admin', 'Editor'].includes(currentUser.role)) roleClass = 'role-admin';
    roleLabel.className = `role-tag ${roleClass}`;

    if (currentUser.role === 'Admin') {
        getById('addVerBtn').classList.remove('hidden');
    }
}

function logout() {
    localStorage.removeItem('rowad_u');
    location.reload();
}

/* --- DATA FETCHING & RENDERING --- */
async function fetchDashboardData() {
    const response = await callApi('fetch_data');
    
    if (response.result === 'error') {
        getById('loading').innerHTML = '<div style="color:#d35400">Failed to load. <button onclick="location.reload()">Retry</button></div>';
        return;
    }

    callsDatabase = response.data;
    auditHistory = response.history || [];
    (response.permissions || []).forEach(p => userMapping[p.Email] = p.ID);

    if (response.settings) {
        if (response.settings.Announcement) {
            const banner = getById('announcementBanner');
            banner.innerText = response.settings.Announcement;
            banner.style.display = 'block';
        }
        if (response.settings.Changelog) {
            try {
                const savedLog = JSON.parse(response.settings.Changelog);
                if (Array.isArray(savedLog)) systemChangelog = savedLog;
            } catch(e) {}
        }
    }

    populateFilters();
    populateColumnPicker();
    getById('loading').style.display = 'none';
    getById('tableView').classList.remove('hidden');
    renderDashboard();
}

function populateFilters() {
    const createSelect = (id, label, options) => {
        const optsHtml = options.map(x => `<option>${x}</option>`).join('');
        const onChange = id === 'filterRegion' ? 'handleRegionFilter()' : 'debouncedRender()';
        return `<div class="filter-box" style="margin-bottom:0">
                    <select id="${id}" onchange="${onChange}">
                        <option value="All">All ${label}</option>
                        ${optsHtml}
                    </select>
                </div>`;
    };

    const getUniqueOptions = (key) => [...new Set(callsDatabase.map(r => r[key]).filter(Boolean))].sort();

    getById('filterPanel').innerHTML = 
        createSelect('filterDirection', 'Directions', getUniqueOptions('Direction')) +
        createSelect('filterRegion', 'Regions', getUniqueOptions('Region')) +
        createSelect('filterCity', 'Cities', getUniqueOptions('City')) +
        createSelect('filterStatus', 'Statuses', ['Pending', 'Interested', 'Quote Requested', 'Call Later', 'No Answer', 'Renewed', 'Active Contract', 'Not Interested']) +
        createSelect('filterSat', 'Satisfaction', ['Satisfied', 'Unsatisfied', 'Neutral']);
}

function populateColumnPicker() {
    const keys = Object.keys(callsDatabase[0]).filter(k => !k.startsWith('_'));
    getById('columnPicker').innerHTML = keys.map(k => 
        `<label class="checkbox-item"><input type="checkbox" checked value="${k}"> ${k}</label>`
    ).join('');
}

/* --- FILTER LOGIC --- */
window.debouncedRender = () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(renderDashboard, 300);
};

window.handleRegionFilter = () => {
    const selectedRegion = getById('filterRegion').value;
    const cities = [...new Set(callsDatabase.filter(r => selectedRegion === 'All' || r.Region === selectedRegion).map(r => r.City).filter(Boolean))].sort();
    
    getById('filterCity').innerHTML = '<option value="All">All Cities</option>' + cities.map(x => `<option>${x}</option>`).join('');
    debouncedRender();
};

window.toggleFilters = () => {
    getById('filterPanel').classList.toggle('show');
    document.querySelector('.filter-toggle-btn').classList.toggle('active');
};

/* --- RENDERING ENGINE --- */
function renderDashboard() {
    const searchTerm = getById('search').value.toLowerCase();
    const sortMode = getById('sortBy').value;
    
    const filters = {
        Direction: getById('filterDirection').value,
        Region: getById('filterRegion').value,
        City: getById('filterCity').value,
        Status: getById('filterStatus').value,
        Satisfaction: getById('filterSat').value
    };

    // Sorting Logic
    const sortStrategies = {
        'Priority': (a, b) => (STATUS_PRIORITY[a.Status] || 9) - (STATUS_PRIORITY[b.Status] || 9),
        'Alphabetical': (a, b) => a["Hospital Name"].localeCompare(b["Hospital Name"]),
        'Location': (a, b) => (a.City || '').localeCompare(b.City || ''),
        'Device': (a, b) => (a.Device || '').localeCompare(b.Device || '')
    };

    callsDatabase.sort(sortStrategies[sortMode] || sortStrategies['Priority']);

    const filteredData = callsDatabase.filter(row => {
        const matchesFilters = Object.keys(filters).every(key => 
            filters[key] === 'All' || (row[key] || 'Pending') === filters[key]
        );
        const searchString = (row["Hospital Name"] + row.Contact + row.City).toLowerCase();
        const matchesSearch = searchString.includes(searchTerm);
        return matchesFilters && matchesSearch;
    });

    // Render Table
    getById('tableBody').innerHTML = filteredData.map(row => `
        <tr>
            <td>
                <div class="font-semibold text-dark">${escapeHtml(row["Hospital Name"])}</div>
                <div class="text-sm mt-1" style="color:var(--text-light);">${escapeHtml(row.Contact)}</div>
            </td>
            <td class="text-sm" style="color:var(--text-light);">${escapeHtml(row.City)}</td>
            <td>
                <div class="text-sm" style="font-weight:500;">${escapeHtml(row.Device)}</div>
                <div class="mt-1">${(row.Tags || '').split(',').map(t => t ? `<span class="tag-pill">${t}</span>` : '').join('')}</div>
            </td>
            <td>
                <span style="color:${getStatusColor(row.Satisfaction)};font-weight:600;font-size:13px;background:${getStatusColor(row.Satisfaction)}15;padding:4px 8px;border-radius:4px;">
                    ${escapeHtml(row.Satisfaction || '-')}
                </span>
            </td>
            <td>
                <span style="color:${getStatusColor(row.Status)};font-weight:600;font-size:13px;">
                    ${escapeHtml(row.Status || '-')}
                </span>
            </td>
            <td style="text-align:right">
                <button class="btn-action" onclick="openEditModal(${row._rowIndex})"><i class="fa-solid fa-pen"></i></button>
            </td>
        </tr>
    `).join('');

    // Render Cards
    getById('cardView').innerHTML = filteredData.map(row => `
        <div class="card ${(row.Status || 'Pending') !== 'Pending' ? 'interacted' : ''}" 
             data-active="${row.Status === 'Active Contract'}" 
             onclick="openEditModal(${row._rowIndex})">
            <h3 class="mb-2" style="margin-top:0;font-size:16px;">${escapeHtml(row["Hospital Name"])}</h3>
            <div class="text-xs text-muted mb-2 font-bold" style="letter-spacing:0.5px">
                ${escapeHtml(row.Device || 'No Device')} • ${escapeHtml(row.Region)}
            </div>
            <p style="font-size:12px;color:var(--text-light);margin:0 0 15px 0;">
                <i class="fa-solid fa-location-dot mr-2" style="color:var(--text-light)"></i> ${escapeHtml(row.City)}
            </p>
            <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border);padding-top:15px;">
                <span style="color:${getStatusColor(row.Status)};font-weight:600;font-size:12px;">${escapeHtml(row.Status || 'Pending')}</span>
                ${row.Contact ? '<i class="fa-solid fa-user" style="color:var(--text-light)"></i>' : ''}
            </div>
        </div>
    `).join('');

    if (!getById('chartsView').classList.contains('hidden')) renderCharts(filteredData);
}

function renderCharts(data) {
    const tally = (source, key, condition) => source.reduce((acc, row) => {
        if (!condition || condition(row)) {
            const val = userMapping[row[key]] || row[key] || 'Unknown';
            acc[val] = (acc[val] || 0) + 1;
        }
        return acc;
    }, {});

    const sortObj = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]);

    const stats = {
        devices: { Surfacide: 0, AccuFIT: 0 },
        funnel: { Total: data.length, Contacted: 0, Quotes: 0, Active: 0 },
        status: {},
        satisfaction: {}
    };

    data.forEach(r => {
        const status = r.Status || 'Pending';
        const device = (r.Device || '').toLowerCase();
        
        if (device.includes('surf')) stats.devices.Surfacide++;
        if (device.includes('accu')) stats.devices.AccuFIT++;
        
        if (status !== 'Pending') stats.funnel.Contacted++;
        if (status === 'Quote Requested') stats.funnel.Quotes++;
        if (status.match(/Renew|Active/)) stats.funnel.Active++;
        
        if (r.Satisfaction) stats.satisfaction[r.Satisfaction] = (stats.satisfaction[r.Satisfaction] || 0) + 1;
        if (!['Pending', 'Active Contract'].includes(status)) stats.status[status] = (stats.status[status] || 0) + 1;
    });

    const uniqueVisits = new Set();
    auditHistory.forEach(log => {
        const date = new Date(log.Timestamp).toLocaleDateString();
        const key = `${log.User}_${log['Hospital Name']}_${date}`;
        uniqueVisits.add(key);
    });

    const activityCounts = {};
    uniqueVisits.forEach(key => {
        const userEmail = key.split('_')[0];
        const userName = userMapping[userEmail] || userEmail.split('@')[0];
        activityCounts[userName] = (activityCounts[userName] || 0) + 1;
    });
    const activitySorted = sortObj(activityCounts);

    const quotes = tally(auditHistory, 'User', r => r["Field Changed"] === 'Status' && r["New Value"] === 'Quote Requested');

    const chartConfigs = {
        deviceChart: [Object.keys(stats.devices), Object.values(stats.devices), ['#A88B4D', '#2d2d2d']],
        satChart: [Object.keys(stats.satisfaction), Object.values(stats.satisfaction), ['#27ae60', '#d35400', '#95a5a6'], 'doughnut'],
        funnelChart: [Object.keys(stats.funnel), Object.values(stats.funnel), ['#e9ecef', '#C4B27D', '#A88B4D', '#2d2d2d'], 'bar', 'y'],
        statusChart: [Object.keys(stats.status), Object.values(stats.status), Object.keys(stats.status).map(s => getStatusColor(s))],
        activityChart: [activitySorted.map(x => x[0]), activitySorted.map(x => x[1]), '#2d2d2d', 'bar', 'y'],
        quoteChart: [sortObj(quotes).map(x => x[0]), sortObj(quotes).map(x => x[1]), '#27ae60', 'bar', 'y']
    };

    Object.keys(chartConfigs).forEach(id => {
        const [labels, values, colors, type = 'bar', axis = 'x'] = chartConfigs[id];
        
        if (chartInstances[id]) {
            chartInstances[id].data.labels = labels;
            chartInstances[id].data.datasets[0].data = values;
            chartInstances[id].data.datasets[0].backgroundColor = colors;
            chartInstances[id].update();
        } else {
            chartInstances[id] = new Chart(getById(id), {
                type: type,
                indexAxis: axis,
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderRadius: 4,
                        barThickness: axis === 'y' ? 20 : undefined
                    }]
                },
                options: getChartOptions(axis)
            });
        }
    });
}

/* --- INTERACTION HANDLERS --- */
window.openEditModal = (index) => {
    currentRowIndex = index;
    const row = callsDatabase.find(x => x._rowIndex === index);
    if (!row) return;

    getById('saveBtn').classList.remove('success');

    const editorRaw = row["Last Editor"] || "Unknown";
    getById('modalTitle').innerText = row["Hospital Name"];
    getById('modalSubtitle').innerText = `Updated: ${editorRaw.includes('@') ? (userMapping[editorRaw.split(' on ')[0]] || editorRaw.split('@')[0]) : editorRaw}`;

    getById('dispRegion').innerText = row.Region || '-';
    getById('dispCity').innerText = row.City || '-';
    getById('dispDevice').innerText = row.Device || '-';
    getById('dispSurfSN').innerText = row["Surfacide SN"] || '-';
    getById('dispAccuSN').innerText = row["AccuFIT SN"] || '-';
    getById('dispSurfUser').innerText = row["Surfacide Username"] || '-';

    getById('editContactName').value = row.Contact || '';
    getById('editContactMobile').value = row['Contact Mobile Number'] || '';
    getById('editStatus').value = row.Status || '';
    getById('editSat').value = row.Satisfaction || '';
    getById('editTags').value = row.Tags || '';
    getById('editNotes').value = row.Notes || '';

    const mobile = row['Contact Mobile Number'];
    const hasMobile = mobile && mobile.length > 5;
    getById('displayPhone').innerText = mobile || "No Number";
    const waLink = getById('waLink');
    waLink.href = hasMobile ? `https://wa.me/966${mobile.match(/\d+/)?.[0].slice(-9)}` : '#';
    waLink.classList.toggle('hidden', !hasMobile);

    const canEdit = ['Admin', 'Editor'].includes(currentUser.role);
    document.querySelectorAll('.secure-input').forEach(e => e.disabled = !canEdit);
    const saveBtn = getById('saveBtn');
    saveBtn.disabled = !canEdit;
    saveBtn.innerText = canEdit ? "Save Updates" : "Login to Edit";
    
    getById('editPhoneBtn').classList.toggle('hidden', !canEdit);
    getById('loginPrompt').classList.toggle('hidden', canEdit);

    getById('editModal').style.display = 'flex';
};

window.promptPhoneUpdate = () => {
    const newNumber = prompt("New Number:", getById('editContactMobile').value);
    if (newNumber) {
        getById('editContactMobile').value = newNumber;
        getById('displayPhone').innerText = newNumber;
    }
};

window.closeModal = () => getById('editModal').style.display = 'none';

window.switchView = (viewName) => {
    ['table', 'card', 'charts', 'export', 'settings'].forEach(k => {
        getById(k + 'View').classList.toggle('hidden', viewName !== k);
    });
    
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === viewName);
    });

    if (viewName === 'charts') renderDashboard();
    if (viewName === 'settings') renderSettings();
};

window.renderSettings = () => {
    // Populate Changelog
    getById('changelogContainer').innerHTML = systemChangelog.map(entry => `
        <div style="border-left:2px solid var(--accent);padding-left:10px;margin-bottom:15px">
            <div class="text-xs text-muted">${entry.d} • v${entry.v}</div>
            <div class="font-semibold">${entry.t}</div>
        </div>
    `).join('');

    // Populate Audit Log with CITY lookup
    const auditContainer = getById('auditLogContainer');
    const recentHistory = auditHistory.slice().reverse().slice(0, 50);
    
    if (recentHistory.length === 0) {
        auditContainer.innerHTML = '<div class="text-muted text-center p-4">No recent edits found.</div>';
    } else {
        auditContainer.innerHTML = recentHistory.map(log => {
            const time = new Date(log.Timestamp).toLocaleString('en-GB'); 
            const userName = userMapping[log.User] || log.User.split('@')[0];
            // Lookup City
            const hospitalRow = callsDatabase.find(r => r["Hospital Name"] === log["Hospital Name"]);
            const locationStr = hospitalRow ? `(${hospitalRow.City})` : '';
            
            return `
                <div class="audit-log-item">
                    <div class="audit-time">${time} • ${userName}</div>
                    <div class="audit-change">
                        Updated <span>${log['Hospital Name']}</span> <span class="text-muted text-xs">${locationStr}</span>: 
                        Changed ${log['Field Changed']} from 
                        "<span class="old-val">${log['Old Value']}</span>" to 
                        "<span class="new-val">${log['New Value']}</span>"
                    </div>
                </div>`;
        }).join('');
    }

    // Populate Personal Impact
    const myEdits = auditHistory.filter(h => h.User === currentUser.email).length;
    let rank = "Novice";
    if (myEdits > 10) rank = "Contributor";
    if (myEdits > 50) rank = "Specialist";
    if (myEdits > 100) rank = "Master";

    getById('impactWidget').innerHTML = `
        <div>
            <div class="text-xs text-muted text-uppercase">Total Contributions</div>
            <div style="font-size: 24px; font-weight: 800; color: var(--accent);">${myEdits}</div>
        </div>
        <div class="text-right">
            <div class="text-xs text-muted text-uppercase">Rank</div>
            <div style="font-size: 18px; font-weight: 600;">${rank}</div>
        </div>
    `;
};

window.saveChanges = async () => {
    const btn = getById('saveBtn');
    btn.innerText = "Saving...";

    let editorString = `${currentUser.email} on ${formatDate(new Date())}`;
    
    const dataPayload = {
        _rowIndex: currentRowIndex,
        "Last Editor": editorString,
        "Contact": getById('editContactName').value,
        "Contact Mobile Number": getById('editContactMobile').value,
        "Status": getById('editStatus').value,
        "Satisfaction": getById('editSat').value,
        "Tags": getById('editTags').value,
        "Notes": getById('editNotes').value
    };

    const response = await callApi('save', { userEmail: currentUser.email, data: dataPayload });

    if (response.result === 'success') {
        Object.assign(callsDatabase.find(x => x._rowIndex === currentRowIndex), dataPayload);
        renderDashboard();
        
        btn.classList.add('success');
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
        setTimeout(() => { getById('editModal').style.display = 'none'; }, 1000);
    } else {
        alert("Error");
        btn.innerText = "Save Updates";
    }
};

/* --- ADMIN CHANGELOG EDITING --- */
window.toggleAddVersion = () => getById('addVersionForm').classList.toggle('hidden');

window.submitVersionEntry = async () => {
    const ver = getById('newVerNum').value;
    const date = getById('newVerDate').value;
    const desc = getById('newVerDesc').value;

    if (!ver || !date || !desc) return alert("All fields are required");

    const newEntry = { v: ver, d: date, t: desc };
    systemChangelog.unshift(newEntry);
    
    await callApi('save_settings', {
        userEmail: currentUser.email,
        settings: { 'Changelog': JSON.stringify(systemChangelog) }
    });

    alert("Version History Updated!");
    renderSettings();
    getById('addVersionForm').classList.add('hidden');
    getById('newVerNum').value = '';
    getById('newVerDate').value = '';
    getById('newVerDesc').value = '';
};

/* --- THEME ENGINE --- */
window.updateTheme = () => {
    const r = document.documentElement.style;
    r.setProperty('--accent', getById('adminColor').value);
    saveLocalPrefs();
};

window.toggleDarkMode = () => {
    document.body.classList.toggle('dark-theme');
    saveLocalPrefs();
};

window.toggleCompactMode = () => {
    document.body.classList.toggle('compact-mode');
    saveLocalPrefs();
};

window.updateFont = () => {
    const r = document.documentElement.style;
    r.setProperty('--font-stack', getById('fontSelector').value);
    saveLocalPrefs();
};

window.downloadCSV = () => {
    const selectedColumns = [...document.querySelectorAll('#columnPicker input:checked')].map(c => c.value);
    const csvContent = [
        selectedColumns.join(','),
        ...callsDatabase.map(row => 
            selectedColumns.map(col => `"${(row[col] || '').toString().replace(/"/g, '""')}"`).join(',')
        )
    ].join('\n');

    const link = document.createElement('a');
    link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv' }));
    link.download = 'database_export.csv';
    link.click();
};
</script>
</body>
</html>
