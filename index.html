<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Calls Dashboard</title><link rel="icon" href="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico"><script src="https://accounts.google.com/gsi/client" async defer></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>:root{--primary:#2d2d2d;--accent:#A88B4D;--accent-dark:#8c7335;--bg:#f0f2f5;--surface:#ffffff;--text:#2d2d2d;--text-light:#6c757d;--border:#e9ecef;--active-contract:#5DADE2;--fs-xs:10px;--fs-sm:12px;--fs-base:14px;--fs-lg:16px;--fs-xl:20px}.text-xs{font-size:var(--fs-xs)}.text-sm{font-size:var(--fs-sm)}.text-base{font-size:var(--fs-base)}.text-lg{font-size:var(--fs-lg)}.text-xl{font-size:var(--fs-xl)}.text-muted{color:#adb5bd}.text-dark{color:var(--text)}.font-bold{font-weight:700}.font-semibold{font-weight:600}.mb-1{margin-bottom:4px}.mb-2{margin-bottom:8px}.mb-4{margin-bottom:16px}.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-4{margin-top:16px}.mr-2{margin-right:8px}.w-full{width:100%}.h-full{height:100%}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);margin:0;color:var(--text);-webkit-font-smoothing:antialiased;display:flex;flex-direction:column;min-height:100vh}.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-2{gap:8px}.gap-4{gap:16px}.hidden{display:none!important}.p-4{padding:16px}.rounded{border-radius:8px}.text-center{text-align:center}#loginOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);z-index:2000;display:flex;justify-content:center;align-items:center;flex-direction:column}.login-card{background:white;padding:40px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.05);text-align:center;width:300px;border-top:4px solid var(--accent);display:flex;flex-direction:column;align-items:center;margin-bottom:20px}.login-error{color:#d35400;background:#fdf2e9;padding:10px;border-radius:8px;font-size:12px;margin-top:15px;width:100%;display:none;border:1px solid #fadbd8}.top-bar{background:var(--surface);padding:15px 30px;box-shadow:0 4px 20px rgba(0,0,0,0.05);border-bottom:3px solid var(--accent);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:15px}.logo-img{height:45px;width:auto}.page-title{font-size:var(--fs-xl);font-weight:700;padding-left:20px;border-left:2px solid #eee;margin-left:20px;letter-spacing:-0.5px;white-space:nowrap}.vertical-divider{width:1px;height:24px;background:#dee2e6;margin:0 10px}.user-badge{background:#f1f3f5;padding:6px 14px;border-radius:30px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px;border:1px solid var(--border);cursor:pointer;transition:0.2s}.user-badge:hover{background:#e9ecef;border-color:#dee2e6}.role-tag{font-size:10px;padding:3px 8px;border-radius:6px;background:#e9ecef;color:#495057;text-transform:uppercase;letter-spacing:0.5px;font-weight:700}.role-admin{background:#e6fcf5;color:#0ca678;border:1px solid #c3fae8}.role-rowad{background:#fff4e6;color:#d9480f;border:1px solid #ffec99}.view-btn{border:1px solid transparent;background:transparent;padding:8px 12px;cursor:pointer;border-radius:6px;color:#adb5bd;transition:0.2s}.view-btn:hover{color:var(--text);background:#f1f3f5}.view-btn.active{background:#fff8e6;color:var(--accent-dark);border:1px solid #ffe8cc;font-weight:bold}input,select,textarea{padding:12px 16px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;outline:none;background:#fff;font-family:inherit;transition:0.2s}input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(168,139,77,0.1)}.container{max-width:1400px;margin:30px auto;padding:0 20px;flex:1;width:100%;box-sizing:border-box}.controls{display:flex;gap:10px;margin-bottom:20px;align-items:center}.search-box{flex:1}.filter-toggle-btn{background:var(--surface);border:1px solid var(--border);color:var(--text-light);width:45px;height:45px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:0.2s}.filter-toggle-btn.active{background:var(--accent);color:white;border-color:var(--accent)}.filter-panel{display:none;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:var(--surface);padding:20px;border-radius:12px;border:1px solid var(--border);margin-bottom:25px;box-shadow:0 4px 15px rgba(0,0,0,0.03);animation:slideDown 0.3s ease-out}.filter-panel.show{display:grid}@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.data-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--surface);border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.05);border:1px solid var(--border)}.data-table th{text-align:left;padding:20px;background:#fafafa;color:#8898aa;font-weight:700;font-size:var(--fs-sm);letter-spacing:0.8px;text-transform:uppercase;border-bottom:1px solid var(--border)}.data-table td{padding:18px 20px;border-bottom:1px solid var(--border);vertical-align:middle}.data-table tr:hover td{background-color:#fcfcfc}.btn-action{background:#f8f9fa;color:var(--text-light);border:1px solid var(--border);padding:8px 12px;border-radius:6px;cursor:pointer;transition:0.2s}.btn-action:hover{background:var(--accent);color:white;border-color:var(--accent)}.card{background:var(--surface);padding:25px;border-radius:12px;border:1px solid transparent;box-shadow:0 4px 15px rgba(0,0,0,0.03);transition:all 0.2s;cursor:pointer;position:relative;overflow:hidden}.card:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.08);border-color:transparent}.card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:#e9ecef;transition:0.2s}.card.interacted::before{background:var(--accent)}.card[data-active="true"]::before{background:var(--active-contract)!important}.grid-view{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}.admin-section-title{font-size:16px;font-weight:700;margin-bottom:15px;color:var(--primary);display:flex;align-items:center;gap:10px}.admin-card{background:#f8f9fa;padding:20px;border-radius:12px;border:1px solid var(--border);height:100%;box-sizing:border-box}.range-slider{width:100%;margin:10px 0}.audit-log-item{padding:10px;border-bottom:1px solid #eee;font-size:12px}.audit-log-item:last-child{border-bottom:none}.audit-time{color:#aaa;font-size:10px}.audit-change span{font-weight:600;color:var(--primary)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(4px)}.modal-card{background:var(--surface);width:100%;max-width:650px;padding:0;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,0.1);max-height:90vh;overflow-y:auto;overflow-x:hidden}.modal-header{padding:20px 30px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#fcfcfc}.modal-body{padding:30px}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px;background:#f8f9fa;padding:20px;border-radius:12px;border:1px solid var(--border)}.info-item label{display:block;font-size:var(--fs-sm);text-transform:uppercase;color:#999;margin-bottom:4px;letter-spacing:0.5px;font-weight:600}.info-item div{font-weight:600;font-size:var(--fs-base);color:#333}.input-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}.contact-box{background:#fff;border:1px solid var(--border);padding:15px;border-radius:10px;transition:0.2s;height:100%;box-sizing:border-box}.secure-input:disabled{background:transparent;border:none;padding:0;color:#2d2d2d;font-weight:600;cursor:text;opacity:1;-webkit-text-fill-color:#2d2d2d}.btn-save{width:100%;padding:16px;margin-top:10px;background:var(--accent);color:white;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;letter-spacing:0.5px;transition:0.2s}.btn-save:hover{background:var(--accent-dark);transform:translateY(-1px)}.btn-save:disabled{background:#e9ecef;color:#adb5bd;cursor:not-allowed;transform:none}.btn-save.success{background:#27ae60;pointer-events:none}.tag-pill{font-size:11px;background:#f1f3f5;padding:3px 8px;border-radius:12px;color:#495057;display:inline-block;margin-right:4px;border:1px solid #dee2e6;font-weight:600;margin-bottom:2px}.chart-wrapper{position:relative;height:300px;width:100%}.chart-card{background:var(--surface);padding:30px;border-radius:16px;border:1px solid var(--border);flex:1;box-shadow:0 4px 12px rgba(0,0,0,0.02);min-width:300px}label.block{color:#adb5bd;font-size:var(--fs-xs);text-transform:uppercase;font-weight:700;margin-bottom:8px;display:block;letter-spacing:0.5px}.footer-credit{text-align:center;font-size:11px;color:#adb5bd;padding:20px;margin-top:auto;font-weight:500;letter-spacing:0.5px}.dashboard-container{display:none;flex-direction:column;flex:1}.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;text-align:left;margin:25px 0}.wa-btn{background:#25D366;color:white;border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;text-decoration:none;font-size:18px;margin-left:auto;transition:0.2s}.loading-container{text-align:center;padding:80px 0;color:var(--text-light)}.spinner{width:40px;height:40px;border:3px solid #e9ecef;border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 20px}@keyframes spin{to{transform:rotate(360deg)}}@media (max-width:768px){.data-table,.vertical-divider{display:none}.grid-view{display:grid!important;grid-template-columns:1fr}.top-bar{justify-content:center}.top-bar>div{width:100%;justify-content:center}.modal-card{width:95%;margin:10px}.input-grid-2{grid-template-columns:1fr}}@media print{.no-print,.top-bar,.controls{display:none!important}.data-table{display:table!important}}</style></head>
<body>
<div id="loginOverlay"><div class="login-card"><h2 class="text-dark mb-1" style="font-size:22px">Rowad Calls Dashboard</h2><p class="text-muted mb-4" style="font-size:13px">Internal Services Dashboard</p><div id="g_id_onload" data-client_id="174253379694-95msalgnm4kbpjlftil4vm8o26c7h7cc.apps.googleusercontent.com" data-callback="hCR" data-auto_prompt="false"></div><div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-size="large" data-logo_alignment="left" style="display:flex;justify-content:center"></div><div id="loginError" class="login-error"></div></div><div class="footer-credit">Rowad Calls Dashboard <span onclick="sH()" style="cursor:pointer;text-decoration:underline">v2.4</span> • Developed by Faisal Alzougbi<span style="display:block;margin-top:5px;font-style:italic;opacity:0.7">Disclaimer: This dashboard is an independently developed tool for internal workflow optimization. It is not an official asset of, nor maintained by, Rowad Medical Services.</span></div></div>
<div id="announcementBanner" style="background:#fff3cd;color:#856404;padding:10px;text-align:center;font-size:13px;font-weight:600;display:none;border-bottom:1px solid #ffeeba"></div>
<div id="mainDashboard" class="dashboard-container"><div class="top-bar flex items-center justify-between no-print"><div class="flex items-center" style="min-width:200px"><img src="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico" alt="Rowad Logo" class="logo-img"><span class="page-title">Calls Dashboard</span></div><div class="flex items-center gap-4"><div id="userBadge" class="user-badge" onclick="LO()"><i class="fa-solid fa-user-circle" style="color:#adb5bd"></i><span id="userNameDisplay">User</span><span id="roleLabel" class="role-tag">Viewer</span></div><div class="vertical-divider"></div><div class="view-toggles flex gap-2" id="viewControls"><button class="view-btn active" data-view="table"><i class="fa-solid fa-table"></i></button><button class="view-btn" data-view="card"><i class="fa-solid fa-th-large"></i></button><button class="view-btn" data-view="charts"><i class="fa-solid fa-chart-pie"></i></button><button class="view-btn" data-view="export"><i class="fa-solid fa-file-export"></i></button><button class="view-btn hidden" id="adminBtn" data-view="admin"><i class="fa-solid fa-cog"></i></button></div></div></div>
<div class="container"><div class="controls no-print"><div class="search-box"><input type="text" id="search" placeholder="Search Hospital, Contact..." onkeyup="dR()"></div><button class="filter-toggle-btn" onclick="tF()"><i class="fa-solid fa-filter"></i></button></div><div id="filterPanel" class="filter-panel no-print"></div><div id="loading" class="loading-container"><div class="spinner"></div><span>Loading Database...</span></div>
<table class="data-table hidden" id="tableView"><thead><tr><th width="35%">Hospital</th><th>Location</th><th>Devices</th><th>Satisfaction</th><th>Status</th><th style="text-align:right">Action</th></tr></thead><tbody id="tableBody"></tbody></table><div class="grid-view hidden" id="cardView"></div>
<div id="chartsView" class="hidden"><h3 class="text-dark font-bold mb-4" style="font-size:18px;margin-top:0">Overview</h3><div class="flex gap-4 mb-4" style="flex-wrap:wrap"><div class="chart-card"><h3 class="text-dark font-semibold mt-1">Device Ownership</h3><div class="chart-wrapper"><canvas id="deviceChart"></canvas></div></div><div class="chart-card"><h3 class="text-dark font-semibold mt-1">Satisfaction</h3><div class="chart-wrapper"><canvas id="satChart"></canvas></div></div><div class="chart-card"><h3 class="text-dark font-semibold mt-1">Sales Funnel</h3><div class="chart-wrapper"><canvas id="funnelChart"></canvas></div></div><div class="chart-card"><h3 class="text-dark font-semibold mt-1">Call Outcomes</h3><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div></div><h3 class="text-dark font-bold mb-4" style="font-size:18px;margin-top:30px">Team Performance</h3><div class="input-grid-2"><div class="chart-card"><h3 class="text-dark font-semibold mt-1">Total Activities (Calls/Edits)</h3><div class="chart-wrapper"><canvas id="activityChart"></canvas></div></div><div class="chart-card"><h3 class="text-dark font-semibold mt-1">Quotations Generated</h3><div class="chart-wrapper"><canvas id="quoteChart"></canvas></div></div></div></div>
<div id="exportView" class="hidden text-center" style="padding-top:40px"><div class="chart-card" style="max-width:700px;margin:0 auto;padding:40px"><div style="background:#fff8e6;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px"><i class="fa-solid fa-file-export" style="font-size:24px;color:var(--accent)"></i></div><h2 class="mb-2" style="margin-top:0">Custom Data Export</h2><p class="text-muted mb-4">Select the columns you wish to include in your report.</p><div id="columnPicker" class="checkbox-grid"></div><div class="flex gap-4 justify-center" style="justify-content:center"><button onclick="dlC()" class="btn-save" style="margin:0;width:auto;padding:12px 25px"><i class="fa-solid fa-file-csv mr-2"></i> Download CSV</button><button onclick="window.print()" class="btn-action" style="margin:0;background:white"><i class="fa-solid fa-print mr-2"></i> Print PDF</button></div></div></div>
<div id="adminView" class="hidden" style="padding-top:20px"><div class="input-grid-2"><div class="admin-card"><div class="admin-section-title"><i class="fa-solid fa-globe"></i> Global Config (Affects Everyone)</div><label class="block">Announcement Banner</label><input type="text" id="adminBanner" placeholder="e.g. System Maintenance at 10 PM" class="mb-4"><label class="block">Monthly Call Target</label><input type="number" id="adminTarget" placeholder="500" class="mb-4"><button class="btn-save" onclick="sGS()">Save to Database</button></div><div class="admin-card"><div class="admin-section-title"><i class="fa-solid fa-palette"></i> Theme Studio (Session Only)</div><label class="block">Accent Color</label><input type="color" id="adminColor" value="#A88B4D" class="mb-4" onchange="pT()"><label class="block">Font Size (Base)</label><input type="range" id="adminFs" min="12" max="18" value="14" class="range-slider" oninput="pT()"><button class="btn-action" onclick="location.reload()" style="width:100%;margin-top:10px">Reset Theme</button></div></div><div class="admin-card" style="height:auto;margin-top:20px"><div class="admin-section-title"><i class="fa-solid fa-history"></i> Audit Logs</div><div style="max-height:400px;overflow-y:auto" id="auditLogContainer"></div></div></div></div><div class="footer-credit">Rowad Calls Dashboard v2.0 • Developed by Faisal Alzougbi<span style="display:block;margin-top:5px;font-style:italic;opacity:0.7">Disclaimer: This dashboard is an independently developed tool for internal workflow optimization. It is not an official asset of, nor maintained by, Rowad Medical Services.</span></div></div>
<div class="modal-overlay" id="editModal"><div class="modal-card"><div class="modal-header"><div><h2 class="text-dark" style="margin:0;font-size:20px" id="modalTitle">Hospital</h2><div id="modalSubtitle" class="text-muted text-xs mt-1 font-normal"></div></div><button onclick="cM()" style="border:none;background:none;font-size:20px;cursor:pointer;color:#adb5bd;transition:0.2s"><i class="fa-solid fa-xmark"></i></button></div><div class="modal-body"><div class="info-grid"><div class="info-item"><label>Region</label><div id="dispRegion">-</div></div><div class="info-item"><label>City</label><div id="dispCity">-</div></div><div class="info-item"><label>Device</label><div id="dispDevice">-</div></div><div class="info-item"><label>Surfacide SN</label><div id="dispSurfSN">-</div></div><div class="info-item"><label>AccuFIT SN</label><div id="dispAccuSN">-</div></div><div class="info-item"><label>Surfacide User</label><div id="dispSurfUser">-</div></div></div><div class="input-grid-2"><div><label class="block">Contact Person</label><div class="contact-box"><input type="text" id="editContactName" class="secure-input" disabled placeholder="Name"><div class="flex items-center mt-2" style="border-top:1px solid #f1f3f5;padding-top:10px"><i class="fa-solid fa-phone" style="margin-right:10px;color:#adb5bd;font-size:14px"></i><span id="displayPhone" style="font-weight:600;font-size:14px">***</span><a id="waLink" class="wa-btn hidden" target="_blank"><i class="fa-brands fa-whatsapp"></i></a></div><input type="hidden" id="editContactMobile"><button id="editPhoneBtn" onclick="pPU()" class="hidden" style="margin-top:8px;color:var(--accent);border:none;background:none;cursor:pointer;font-size:12px;font-weight:600;padding:0">Change Number</button></div></div><div style="display:flex;flex-direction:column;gap:15px"><div><label class="block">Status</label><select id="editStatus" class="secure-input" disabled><option value="">-</option><option value="No Answer">No Answer</option><option value="Call Later">Call Later</option><option value="Interested">Interested</option><option value="Quote Requested">Quote Requested</option><option value="Not Interested">Not Interested</option><option value="Renewed">Renewed</option><option value="Active Contract">Active Contract</option></select></div><div><label class="block">Satisfaction</label><select id="editSat" class="secure-input" disabled><option value="">-</option><option value="Satisfied">Satisfied</option><option value="Unsatisfied">Unsatisfied</option><option value="Neutral">Neutral</option></select></div><div><label class="block">Tags</label><input type="text" id="editTags" class="secure-input" disabled placeholder="VIP, New..."></div></div></div><div class="mb-4"><label class="block">Notes</label><textarea id="editNotes" class="secure-input" disabled style="resize:vertical;min-height:80px;line-height:1.5" placeholder="Add notes..."></textarea></div><div id="adminOverride" class="hidden mb-4" style="background:#fff3cd;padding:10px;border-radius:8px"><label class="block" style="color:#856404">Admin Override: Last Editor</label><input type="text" id="editLastEditor" style="background:transparent;border:none;font-weight:bold;width:100%"></div><button class="btn-save" id="saveBtn" onclick="sC()" disabled>Login to Edit</button><div id="loginPrompt" class="text-center text-muted text-sm mt-2 hidden"><i class="fa-solid fa-lock mr-2"></i> Only Editors can save changes</div><div id="vHist" class="hidden" style="margin-top:20px"></div></div></div></div>
<script>
const CLOG=[{v:"2.4",d:"2026-01-22",t:"Implemented Version History System & Protocols"},{v:"2.3",d:"2026-01-22",t:"Fixed Syntax Error in Toggle Filter"},{v:"2.2",d:"2026-01-21",t:"Minified Codebase"},{v:"2.1",d:"2026-01-20",t:"Added Login & Auth"}];const $=e=>document.getElementById(e);const A="https://script.google.com/macros/s/AKfycbwaush-5NL-MH3OXm7mqXdj4Gy9M9Wlv8qh8Pe7UmlaH5k7jcb4T218DDpHfD4r4B3asA/exec";let d=[],h=[],um={},c={},ci=-1,to,u={email:null,role:'Public',token:null,id:null};const P={"Quote Requested":1,"Interested":1,"Call Later":2,"No Answer":3,"Pending":4,"Renewed":5,"Satisfied":5,"Active Contract":6};const CO=i=>({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{[i]:{grid:{display:!1}}}});const CL=s=>(s||'').match(/Renew|Satis/)?'#27ae60':(s||'').match(/Quote|Call|Interest/)?'#2980b9':(s||'').match(/Active/)?'#5DADE2':(s||'').match(/No|Not|Un/)?'#d35400':'#666';const ES=t=>(t||'').toString().replace(/&/g,"&amp;").replace(/</g,"&lt;");window.onload=()=>{cS();$('viewControls').onclick=e=>{const b=e.target.closest('button');if(b)sV(b.dataset.view)}};async function Q(a,p={}){try{return await(await fetch(A,{method:'POST',body:JSON.stringify({action:a,token:u.token,...p})})).json()}catch(e){return{result:'error',message:'Connection Error'}}}
async function cS(){try{const s=JSON.parse(localStorage.getItem('rowad_u'));if(s&&s.u&&Date.now()-s.ts<32400000){u=s.u;iU();$('loginOverlay').style.display='none';$('mainDashboard').style.display='flex';fD();return}}catch(e){}$('loginOverlay').style.display='flex'}
window.hCR=async(r)=>{u.token=r.credential;const x=await Q('login');if(x.result==='success'){u={email:x.email,role:x.role,id:x.id,token:r.credential};localStorage.setItem('rowad_u',JSON.stringify({u,ts:Date.now()}));$('loginOverlay').style.display='none';iU();fD()}else{$('loginError').innerText="Login Failed: "+(x.message||"Unknown");$('loginError').style.display='block'}};function iU(){$('userNameDisplay').innerText=u.id||u.email.split('@')[0];$('roleLabel').innerText=u.role;$('mainDashboard').style.display='flex';$('roleLabel').className=`role-tag ${u.role==='Rowad'?'role-rowad':['Admin','Editor'].includes(u.role)?'role-admin':''}`;if(u.role==='Admin')$('adminBtn').classList.remove('hidden')}
function LO(){localStorage.removeItem('rowad_u');location.reload()}
async function fD(){const r=await Q('fetch_data');if(r.result==='error'){$('loading').innerHTML='<div style="color:#d35400">Failed to load. <button onclick="location.reload()">Retry</button></div>';return}d=r.data;h=r.history||[];(r.permissions||[]).forEach(p=>um[p.Email]=p.ID);if(r.settings){if(r.settings.Announcement){$('announcementBanner').innerText=r.settings.Announcement;$('announcementBanner').style.display='block';$('adminBanner').value=r.settings.Announcement}if(r.settings.Target)$('adminTarget').value=r.settings.Target}const mk=(i,l,o)=>`<div class="filter-box" style="margin-bottom:0"><select id="${i}" onchange="${i==='filterRegion'?'hR()':'dR()'}"><option value="All">All ${l}</option>${o.map(x=>`<option>${x}</option>`).join('')}</select></div>`;const DO=k=>[...new Set(d.map(r=>r[k]).filter(Boolean))].sort();$('filterPanel').innerHTML=mk('filterDirection','Directions',DO('Direction'))+mk('filterRegion','Regions',DO('Region'))+mk('filterCity','Cities',DO('City'))+mk('filterStatus','Statuses',['Pending','Interested','Quote Requested','Call Later','No Answer','Renewed','Active Contract','Not Interested'])+mk('filterSat','Satisfaction',['Satisfied','Unsatisfied','Neutral']);$('columnPicker').innerHTML=Object.keys(d[0]).filter(k=>!k.startsWith('_')).map(k=>`<label class="checkbox-item"><input type="checkbox" checked value="${k}"> ${k}</label>`).join('');rH();$('loading').style.display='none';$('tableView').classList.remove('hidden');R()}
function rH(){const l=h.slice().reverse();$('auditLogContainer').innerHTML=l.map(x=>`<div class="audit-log-item"><div class="audit-time">${new Date(x.Timestamp).toLocaleString()} • ${um[x.User]||(x.User||'').split('@')[0]}</div><div class="audit-change">Updated <span>${x['Hospital Name']}</span>: Changed ${x['Field Changed']} from "${x['Old Value']}" to "<span>${x['New Value']}</span>"</div></div>`).join('')}
window.pT=()=>{const r=document.documentElement.style;r.setProperty('--accent',$('adminColor').value);r.setProperty('--fs-base',$('adminFs').value+'px');r.setProperty('--fs-sm',($('adminFs').value-2)+'px')};window.sGS=async()=>{await Q('save_settings',{userEmail:u.email,settings:{'Announcement':$('adminBanner').value,'Target':$('adminTarget').value}});alert("Settings Saved!")};window.dR=()=>{clearTimeout(to);to=setTimeout(R,300)};window.hR=()=>{const g=$('filterRegion').value,z=[...new Set(d.filter(r=>g==='All'||r.Region===g).map(r=>r.City).filter(Boolean))].sort();$('filterCity').innerHTML='<option value="All">All Cities</option>'+z.map(x=>`<option>${x}</option>`).join('');dR()};window.tF=()=>{$('filterPanel').classList.toggle('show');document.querySelector('.filter-toggle-btn').classList.toggle('active')};function R(){const s=$('search').value.toLowerCase(),f={Direction:$('filterDirection').value,Region:$('filterRegion').value,City:$('filterCity').value,Status:$('filterStatus').value,Satisfaction:$('filterSat').value};d.sort((a,b)=>(P[a.Status]||9)-(P[b.Status]||9));const D=d.filter(r=>Object.keys(f).every(k=>f[k]==='All'||(r[k]||'Pending')===f[k])&&(r["Hospital Name"]+r.Contact+r.City).toLowerCase().includes(s));$('tableBody').innerHTML=D.map(r=>`<tr><td><div class="font-semibold text-dark">${ES(r["Hospital Name"])}</div><div class="text-sm mt-1" style="color:#888;">${ES(r.Contact)}</div></td><td class="text-sm" style="color:#555;">${ES(r.City)}</td><td><div class="text-sm" style="font-weight:500;">${ES(r.Device)}</div><div class="mt-1">${(r.Tags||'').split(',').map(t=>t?`<span class="tag-pill">${t}</span>`:'').join('')}</div></td><td><span style="color:${CL(r.Satisfaction)};font-weight:600;font-size:13px;background:${CL(r.Satisfaction)}15;padding:4px 8px;border-radius:4px;">${ES(r.Satisfaction||'-')}</span></td><td><span style="color:${CL(r.Status)};font-weight:600;font-size:13px;">${ES(r.Status||'-')}</span></td><td style="text-align:right"><button class="btn-action" onclick="oM(${r._rowIndex})"><i class="fa-solid fa-pen"></i></button></td></tr>`).join('');$('cardView').innerHTML=D.map(r=>`<div class="card ${(r.Status||'Pending')!=='Pending'?'interacted':''}" data-active="${r.Status==='Active Contract'}" onclick="oM(${r._rowIndex})"><h3 class="mb-2" style="margin-top:0;font-size:16px;">${ES(r["Hospital Name"])}</h3><div class="text-xs text-muted mb-2 font-bold" style="letter-spacing:0.5px">${ES(r.Device||'No Device')} • ${ES(r.Region)}</div><p style="font-size:12px;color:#666;margin:0 0 15px 0;"><i class="fa-solid fa-location-dot mr-2" style="color:#adb5bd"></i> ${ES(r.City)}</p><div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #f1f3f5;padding-top:15px;"><span style="color:${CL(r.Status)};font-weight:600;font-size:12px;">${ES(r.Status||'Pending')}</span>${r.Contact?'<i class="fa-solid fa-user" style="color:#dee2e6"></i>':''}</div></div>`).join('');if(!$('chartsView').classList.contains('hidden'))rC(D)}
function rC(D){const T=(s,k,c)=>s.reduce((a,r)=>{if(!c||c(r)){const x=um[r[k]]||r[k]||'Unknown';a[x]=(a[x]||0)+1}return a},{}),S=o=>Object.entries(o).sort((a,b)=>b[1]-a[1]),dv={Surfacide:0,AccuFIT:0},fn={Total:D.length,Contacted:0,Quotes:0,Active:0},st={},sa={};D.forEach(r=>{const s=r.Status||'Pending',z=(r.Device||'').toLowerCase();if(z.includes('surf'))dv.Surfacide++;if(z.includes('accu'))dv.AccuFIT++;if(s!=='Pending')fn.Contacted++;if(s==='Quote Requested')fn.Quotes++;if(s.match(/Renew|Active/))fn.Active++;if(r.Satisfaction)sa[r.Satisfaction]=(sa[r.Satisfaction]||0)+1;if(!['Pending','Active Contract'].includes(s))st[s]=(st[s]||0)+1});const ac=T(h,'User'),qu=T(h,'User',r=>r["Field Changed"]==='Status'&&r["New Value"]==='Quote Requested'),sets={deviceChart:[Object.keys(dv),Object.values(dv),['#A88B4D','#2d2d2d']],satChart:[Object.keys(sa),Object.values(sa),['#27ae60','#d35400','#95a5a6'],'doughnut'],funnelChart:[Object.keys(fn),Object.values(fn),['#e9ecef','#C4B27D','#A88B4D','#2d2d2d'],'bar','y'],statusChart:[Object.keys(st),Object.values(st),'#666'],activityChart:[S(ac).map(x=>x[0]),S(ac).map(x=>x[1]),'#2d2d2d','bar','y'],quoteChart:[S(qu).map(x=>x[0]),S(qu).map(x=>x[1]),'#27ae60','bar','y']};Object.keys(sets).forEach(i=>{const[l,v,k,t='bar',x='x']=sets[i];if(c[i]){c[i].data.labels=l;c[i].data.datasets[0].data=v;c[i].update()}else c[i]=new Chart($(i),{type:t,indexAxis:x,data:{labels:l,datasets:[{data:v,backgroundColor:k,borderRadius:4,barThickness:x==='y'?20:undefined}]},options:CO(x)})})}
window.oM=i=>{document.querySelectorAll('.modal-body > *').forEach(e=>e.classList.remove('hidden'));$('vHist').classList.add('hidden');ci=i;const r=d.find(x=>x._rowIndex===i);if(!r)return;$('saveBtn').classList.remove('success');const w=r["Last Editor"]||"Unknown";$('modalTitle').innerText=r["Hospital Name"];$('modalSubtitle').innerText=`Updated: ${w.includes('@')?(um[w.split(' on ')[0]]||w.split('@')[0]):w}`;$('dispRegion').innerText=r.Region||'-';$('dispCity').innerText=r.City||'-';$('dispDevice').innerText=r.Device||'-';$('dispSurfSN').innerText=r["Surfacide SN"]||'-';$('dispAccuSN').innerText=r["AccuFIT SN"]||'-';$('dispSurfUser').innerText=r["Surfacide Username"]||'-';$('editContactName').value=r.Contact||'';$('editContactMobile').value=r['Contact Mobile Number']||'';$('editStatus').value=r.Status||'';$('editSat').value=r.Satisfaction||'';$('editTags').value=r.Tags||'';$('editNotes').value=r.Notes||'';$('editLastEditor').value=r["Last Editor"]||"";const m=r['Contact Mobile Number'],hm=m&&m.length>5;$('displayPhone').innerText=m||"No Number";$('waLink').href=hm?`https://wa.me/966${m.match(/\d+/)?.[0].slice(-9)}`:'#';$('waLink').classList.toggle('hidden',!hm);const ok=['Admin','Editor'].includes(u.role),adm=u.role==='Admin';document.querySelectorAll('.secure-input').forEach(e=>e.disabled=!ok);$('saveBtn').disabled=!ok;$('saveBtn').innerText=ok?"Save Updates":"Login to Edit";$('editPhoneBtn').classList.toggle('hidden',!ok);$('loginPrompt').classList.toggle('hidden',ok);$('adminOverride').classList.toggle('hidden',!adm);$('editModal').style.display='flex'};window.pPU=()=>{const n=prompt("New Number:",$('editContactMobile').value);if(n){$('editContactMobile').value=n;$('displayPhone').innerText=n}};window.cM=()=>$('editModal').style.display='none';window.sV=v=>{['table','card','charts','export','admin'].forEach(k=>$(k+'View').classList.toggle('hidden',v!==k));document.querySelectorAll('.view-btn').forEach(b=>b.classList.toggle('active',b.dataset.view===v));if(v==='charts')R()};window.sC=async()=>{const b=$('saveBtn');b.innerText="Saving...";let e=`${u.email} on ${new Date().toLocaleDateString('en-GB')}`;if(u.role==='Admin'&&$('editLastEditor').value)e=$('editLastEditor').value;const D={_rowIndex:ci,"Last Editor":e,"Contact":$('editContactName').value,"Contact Mobile Number":$('editContactMobile').value,"Status":$('editStatus').value,"Satisfaction":$('editSat').value,"Tags":$('editTags').value,"Notes":$('editNotes').value};const r=await Q('save',{userEmail:u.email,data:D});if(r.result==='success'){Object.assign(d.find(x=>x._rowIndex===ci),D);R();b.classList.add('success');b.innerHTML='<i class="fa-solid fa-check"></i> Saved';setTimeout(()=>{$('editModal').style.display='none'},1000)}else{alert("Error");b.innerText="Save Updates"}};window.dlC=()=>{const k=[...document.querySelectorAll('#columnPicker input:checked')].map(c=>c.value),v=[k.join(',')].concat(d.map(r=>k.map(c=>`"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n'),a=document.createElement('a');a.href=URL.createObjectURL(new Blob([v],{type:'text/csv'}));a.download='db.csv';a.click()};window.sH=()=>{if(u.role==='Public')return;$('modalTitle').innerText="System Changelog";$('modalSubtitle').innerText="Version History";$('editModal').style.display='flex';document.querySelectorAll('.modal-body > *:not(#vHist)').forEach(e=>e.classList.add('hidden'));const h=$('vHist');h.classList.remove('hidden');h.innerHTML=CLOG.map(x=>`<div style="border-left:2px solid var(--accent);padding-left:10px;margin-bottom:15px"><div class="text-xs text-muted">${x.d} • v${x.v}</div><div class="font-semibold">${x.t}</div></div>`).join('')};
</script></body></html>
