<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calls Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2d2d2d; 
            --accent: #bfa15f; 
            --accent-dark: #a3884d;
            --bg: #f4f4f4;
            --surface: #ffffff;
            --text-main: #2d2d2d;
            --text-light: #666666;
            --border: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text-main); }
        
        /* Layout */
        .top-bar { background: var(--surface); padding: 15px 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 3px solid var(--accent); }
        
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 45px; width: auto; } 
        .page-title { font-size: 20px; font-weight: 700; color: var(--text-main); padding-left: 15px; border-left: 2px solid #eee; }

        .view-toggles { display: flex; gap: 5px; background: #eee; padding: 4px; border-radius: 8px; }
        .view-btn { border: none; background: none; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; font-size: 14px; display: flex; align-items: center; gap: 6px; }
        .view-btn:hover { background: #ddd; }
        .view-btn.active { background: white; color: var(--accent-dark); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; min-height: 80vh; } 
        
        /* Controls */
        .controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .search-box { flex: 2; min-width: 250px; }
        .filter-box { flex: 1; min-width: 150px; }
        
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(191, 161, 95, 0.2); }
        
        /* Tags */
        .tag { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 4px; margin-bottom: 2px; background: #eee; color: #444; border: 1px solid #ddd; }

        /* Views */
        .hidden { display: none !important; }
        
        /* Table */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--surface); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .data-table th { text-align: left; padding: 18px 15px; background: #fafafa; color: var(--text-light); font-weight: 700; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; transition: background 0.2s; }
        .data-table th:hover { background: #f0f0f0; color: var(--text-main); }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .data-table tr:last-child td { border-bottom: none; }
        
        .row-renewed { background-color: #f0fff4; color: #155724; }
        .row-renewed:hover { background-color: #e3f9e9 !important; }
        .row-dead { opacity: 0.6; background-color: #f9f9f9; filter: grayscale(1); }
        .row-dead:hover { opacity: 0.8; }

        /* Grid */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        .card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        .card h3 { margin: 0 0 10px 0; font-size: 18px; color: var(--text-main); }
        .card-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .label { color: var(--text-light); font-size: 12px; }

        .card-renewed { background-color: #f0fff4; border-color: #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1); }
        .card-renewed h3 { color: #155724; }
        .card-dead { opacity: 0.6; background-color: #f9f9f9; filter: grayscale(1); border-style: dashed; }
        .card-dead:hover { opacity: 0.8; }

        /* Status & Last Updated */
        .sat-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sat-Satisfied { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .sat-Neutral { background: #ffc107; }
        .sat-Unsatisfied { background: #dc3545; }
        
        .last-updated { font-size: 10px; color: #999; margin-top: 4px; display: block; font-style: italic; }

        /* Buttons */
        .btn-edit { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-edit:hover { background: var(--accent-dark); }
        
        .footer-credit { text-align: center; padding: 30px 0; color: #aaa; font-size: 12px; font-weight: 500; margin-top: 40px; border-top: 1px solid #eee; }

        /* Charts Area */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); height: 350px; }

        /* SKELETON LOADING ANIMATION */
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        
        .skeleton { 
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f6f7f8 4%, #edeef1 25%, #f6f7f8 36%);
            background-size: 1000px 100%;
            border-radius: 4px;
        }
        .skeleton-text { height: 16px; margin-bottom: 8px; width: 70%; }
        .skeleton-title { height: 24px; margin-bottom: 15px; width: 50%; }
        .skeleton-card { height: 200px; cursor: default; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-card { background-color: var(--surface); width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border-top: 5px solid var(--accent); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .header-content { display: flex; flex-direction: column; gap: 8px; }
        .modal-title { color: #0f172a; font-size: 24px; font-weight: 700; margin: 0; }
        .modal-location { font-size: 14px; color: #777; font-weight: 500; display:flex; align-items:center; gap:6px; }
        .bmet-info { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; background: #f0f0f0; padding: 4px 10px; border-radius: 4px; align-self: flex-start;}
        .warranty-tag { display: none; background-color: #eee; color: #333; border: 1px solid #ccc; font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); padding: 0; line-height: 1; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: var(--text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .contact-box { background-color: #fcfcfc; border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; position: relative; transition: border-color 0.2s; }
        .contact-box:focus-within { border-color: var(--accent); }
        .contact-name-input { border: none; background: transparent; font-size: 16px; color: var(--text-main); width: 90%; outline: none; font-weight: 500; font-family: inherit; }
        .contact-phone { display: flex; align-items: center; color: #0f172a; font-weight: 700; margin-top: 4px; font-size: 18px; }
        .contact-phone a { color: inherit; text-decoration: none; border-bottom: 1px dotted #ccc; }
        .contact-phone a:hover { border-bottom: 1px solid var(--accent); }
        .phone-icon { margin-right: 8px; color: #0f172a; font-size: 14px; }
        .edit-icon-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); cursor: pointer; background: none; border: none; font-size: 16px; }
        .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; color: var(--text-main); box-sizing: border-box; outline: none; background-color: #fff; font-family: inherit; }
        .form-select:focus, .form-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(191, 161, 95, 0.2); }
        .form-textarea { resize: vertical; min-height: 80px; }
        .btn-save { width: 100%; background-color: var(--accent); color: white; border: none; padding: 14px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; margin-top: 10px; }
        .btn-save:hover { background-color: var(--accent-dark); }
        .btn-save:disabled { background-color: #ccc; cursor: not-allowed; }

        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .data-table { display: none; } 
            .grid-view { display: grid !important; }
            .view-toggles { display: none; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo-container">
            <img src="https://alrowad-ksa.com/wp-content/uploads/2022/10/Rowad-Medical-Services_Horizontal_Logo.svg" alt="Rowad Logo" class="logo-img">
            <span class="page-title">Calls Dashboard</span>
        </div>
        <div class="view-toggles">
            <button class="view-btn active" onclick="switchView('table')"><i class="fa-solid fa-table"></i> Table</button>
            <button class="view-btn" onclick="switchView('card')"><i class="fa-solid fa-th-large"></i> Grid</button>
            <button class="view-btn" onclick="switchView('charts')"><i class="fa-solid fa-chart-pie"></i> Charts</button>
            <button class="view-btn" onclick="exportToCSV()"><i class="fa-solid fa-file-csv"></i> CSV</button>
        </div>
    </div>

    <div class="container">
        <div class="controls" id="mainControls">
            <div class="search-box">
                <input type="text" id="search" placeholder="Search Hospital or Contact..." onkeyup="render()">
            </div>
            
            <div class="filter-box">
                <select id="filterDirection" onchange="updateRegionOptions()">
                    <option value="All">All Directions</option>
                </select>
            </div>
            
            <div class="filter-box hidden" id="boxRegion">
                <select id="filterRegion" onchange="updateCityOptions()">
                    <option value="All">All Regions</option>
                </select>
            </div>

            <div class="filter-box hidden" id="boxCity">
                <select id="filterCity" onchange="render()">
                    <option value="All">All Cities</option>
                </select>
            </div>
        </div>

        <table class="data-table hidden" id="tableView">
            <thead>
                <tr>
                    <th onclick="sortBy('name')" style="width: 30%">Hospital <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortBy('location')">Location <i class="fa-solid fa-sort"></i></th>
                    <th>Tags / Devices</th> 
                    <th onclick="sortBy('satisfaction')">Satisfaction <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortBy('contractStatus')">Call Status <i class="fa-solid fa-sort"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="grid-view hidden" id="cardView"></div>

        <div class="hidden" id="chartsView">
            <div class="charts-container">
                <div class="chart-box">
                    <canvas id="satChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="footer-credit">
            Developed by Faisal Alzougbi
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="header-content">
                    <h2 class="modal-title" id="modalTitle">Hospital Name</h2>
                    <div class="modal-location">
                        <i class="fa-solid fa-location-dot"></i> <span id="modalLocationText"></span>
                    </div>
                    
                    <span class="warranty-tag" id="warrantyBadge">Under Warranty</span>
                    <div id="modalBmetDisplay" class="bmet-info" style="display:none">
                        <i class="fa-solid fa-user-gear"></i> <span id="bmetName"></span>
                    </div>
                </div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="form-group">
                <label class="form-label">Primary Contact</label>
                <div class="contact-box">
                    <input type="text" class="contact-name-input" id="editContactName" value="">
                    <div class="contact-phone">
                        <i class="fa-solid fa-phone phone-icon"></i> 
                        <span id="displayPhone"></span>
                    </div>
                    <input type="hidden" id="editContactMobile">
                    <button class="edit-icon-btn" onclick="promptPhoneUpdate()">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Customer Satisfaction</label>
                <select class="form-select" id="editSat">
                    <option value="-">-</option>
                    <option value="Satisfied">Satisfied</option>
                    <option value="Neutral">Neutral</option>
                    <option value="Unsatisfied">Unsatisfied</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Call Status & Outcome</label>
                <select class="form-select" id="editCallStatus">
                    <option value="-">-</option>
                    <option value="No Answer">No Answer</option>
                    <option value="Call Later">Call Later</option>
                    <option value="Quote Requested">Quote Requested</option>
                    <option value="Not Interested">Not Interested</option>
                    <option value="Renewed">Renewed</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="editNotes" placeholder="Add notes here..."></textarea>
            </div>

            <button class="btn-save" id="saveBtn" onclick="saveChanges()">Save Updates</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNF2dhhpJkxxuvNjg5Hvd2JD-T0cNYNREZF6P1-yY0swHjDphfn8jmPKhXBZsQe22GLA/exec";
        
        let db = [];
        let currentEditId = -1;
        let chartsInitialized = false;
        let chartInstances = {};

        // Sort State
        let currentSort = { key: 'contractStatus', asc: true };

        window.onload = function() {
            renderSkeleton(); // Show skeleton immediately
            fetchData();
        };

        function renderSkeleton() {
            const grid = document.getElementById('cardView');
            grid.classList.remove('hidden');
            grid.innerHTML = '';
            // Create 8 dummy cards
            for(let i=0; i<8; i++) {
                grid.innerHTML += `
                    <div class="card skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text" style="width:40%"></div>
                    </div>
                `;
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                db = data.map((row, index) => {
                    let autoTags = [];
                    const device = row['Device'] || '';
                    if (device.includes('Surfacide') || device === 'Both') autoTags.push('Surfacide');
                    if (device.includes('AccuFIT') || device === 'Both') autoTags.push('AccuFIT');
                    let manualTags = row['Tags'] ? row['Tags'].split(',').map(s => s.trim()) : [];
                    let combinedTags = [...new Set([...autoTags, ...manualTags])];
                    
                    // Parse Last Updated
                    let updatedDate = row['Last Updated'] ? new Date(row['Last Updated']) : null;
                    let dateStr = updatedDate ? updatedDate.toLocaleDateString() : '';

                    return {
                        id: index,
                        name: row['Hospital Name'],
                        direction: row['Direction'] || 'Unknown',
                        region: row['Region'] || 'Unknown',
                        city: row['City'] || 'Unknown',
                        location: (row['Region'] || '') + (row['City'] || ''), // For sorting
                        contact: row['Contact'] || '',
                        mobile: row['Contact Mobile Number'] || '',
                        bmetUser: row['BMET User'] || '', 
                        
                        satisfaction: row['Satisfaction'] || '-',
                        contractStatus: row['ContractStatus'] || '-', 
                        tags: combinedTags,
                        notes: row['Notes'] || '',
                        lastUpdated: dateStr
                    };
                });

                initFilters();
                switchView('table');
                render();
            } catch (error) {
                document.getElementById('cardView').innerHTML = `<div style="text-align:center; color:red; padding:40px;">Error: ${error.message}</div>`;
            }
        }

        function initFilters() {
            const directions = [...new Set(db.map(item => item.direction))].sort();
            const select = document.getElementById('filterDirection');
            select.innerHTML = '<option value="All">All Directions</option>';
            directions.forEach(d => { if(d) select.add(new Option(d, d)); });
        }

        function updateRegionOptions() {
            const dir = document.getElementById('filterDirection').value;
            const regionBox = document.getElementById('boxRegion');
            const cityBox = document.getElementById('boxCity');
            
            if (dir === 'All') {
                regionBox.classList.add('hidden');
                cityBox.classList.add('hidden');
                document.getElementById('filterRegion').value = 'All';
                document.getElementById('filterCity').value = 'All';
                render();
                return;
            }

            const regions = [...new Set(db.filter(x => x.direction === dir).map(x => x.region))].sort();
            const select = document.getElementById('filterRegion');
            select.innerHTML = '<option value="All">All Regions</option>';
            regions.forEach(r => select.add(new Option(r, r)));
            
            regionBox.classList.remove('hidden');
            cityBox.classList.add('hidden'); 
            render();
        }

        function updateCityOptions() {
            const region = document.getElementById('filterRegion').value;
            const cityBox = document.getElementById('boxCity');

            if (region === 'All') {
                cityBox.classList.add('hidden');
                document.getElementById('filterCity').value = 'All';
                render();
                return;
            }

            const cities = [...new Set(db.filter(x => x.region === region).map(x => x.city))].sort();
            const select = document.getElementById('filterCity');
            select.innerHTML = '<option value="All">All Cities</option>';
            cities.forEach(c => select.add(new Option(c, c)));

            cityBox.classList.remove('hidden');
            render();
        }

        function getSortWeight(status) {
            if (status === 'Call Later') return 1;
            if (status === 'Quote Requested') return 1; 
            if (status === 'No Answer') return 2;
            if (status === '-' || !status) return 2; 
            if (status === 'Renewed') return 3; 
            if (status === 'Not Interested') return 4; 
            return 2;
        }

        function sortBy(key) {
            if (currentSort.key === key) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.key = key;
                currentSort.asc = true;
            }
            render();
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            const cardGrid = document.getElementById('cardView');
            tbody.innerHTML = '';
            cardGrid.innerHTML = '';

            const search = document.getElementById('search').value.toLowerCase();
            const filterDir = document.getElementById('filterDirection').value;
            const filterReg = document.getElementById('filterRegion').value;
            const filterCity = document.getElementById('filterCity').value;

            let filtered = db.filter(item => {
                const searchStr = (item.name + item.contact + item.bmetUser).toLowerCase();
                if (!searchStr.includes(search)) return false;
                if (filterDir !== 'All' && item.direction !== filterDir) return false;
                if (filterReg !== 'All' && item.region !== filterReg) return false;
                if (filterCity !== 'All' && item.city !== filterCity) return false;
                return true;
            });

            // Sorting Logic
            filtered.sort((a, b) => {
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                if (currentSort.key === 'contractStatus') {
                    valA = getSortWeight(valA);
                    valB = getSortWeight(valB);
                } else {
                    // Case insensitive string sort
                    valA = valA ? valA.toString().toLowerCase() : '';
                    valB = valB ? valB.toString().toLowerCase() : '';
                }

                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });

            filtered.forEach(item => {
                let satHtml = '-';
                if(item.satisfaction && item.satisfaction !== '-' && item.satisfaction !== 'Unknown') {
                    let displayClass = item.satisfaction;
                    if(item.satisfaction === 'High') displayClass = 'Satisfied';
                    if(item.satisfaction === 'Medium') displayClass = 'Neutral';
                    if(item.satisfaction === 'Low') displayClass = 'Unsatisfied';
                    satHtml = `<span class="sat-dot sat-${displayClass}"></span> ${item.satisfaction}`;
                }

                let statusHtml = '-';
                let rowClass = '';
                let cardClass = '';

                if(item.contractStatus && item.contractStatus !== '-') {
                    let color = '#2c3e50'; 
                    let bg = 'transparent';
                    
                    if(item.contractStatus === 'Renewed') { 
                        color = '#155724'; bg = '#d4edda'; 
                        rowClass = 'row-renewed';
                        cardClass = 'card-renewed';
                    }
                    if(item.contractStatus === 'Quote Requested') { color = '#0c5460'; bg = '#d1ecf1'; }
                    if(item.contractStatus === 'Call Later') { color = '#856404'; bg = '#fff3cd'; }
                    if(item.contractStatus === 'No Answer') { color = '#721c24'; bg = '#f8d7da'; }
                    if(item.contractStatus === 'Not Interested') { 
                        color = '#383d41'; bg = '#e2e3e5'; 
                        rowClass = 'row-dead';
                        cardClass = 'card-dead';
                    }
                    
                    statusHtml = `<span style="font-weight:700; color: ${color}; background:${bg}; padding: 4px 8px; border-radius: 4px; font-size:11px;">${item.contractStatus}</span>`;
                }

                let tagsHtml = '';
                item.tags.forEach(t => {
                    tagsHtml += `<span class="tag">${t}</span>`;
                });

                const bmetHtml = item.bmetUser ? `<div style="font-size:11px; color:#2c3e50; margin-top:4px;"><i class="fa-solid fa-user-gear"></i> ${item.bmetUser}</div>` : '';
                
                // Last Updated HTML
                const updatedHtml = item.lastUpdated ? `<span class="last-updated">Updated: ${item.lastUpdated}</span>` : '';

                const tr = `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${item.name}</strong><br>
                            <span style="font-size:12px; color:#888">${item.contact}</span>
                            ${bmetHtml}
                        </td>
                        <td>${item.region} / ${item.city}</td>
                        <td>${tagsHtml}</td> <td>${satHtml}</td>
                        <td>
                            ${statusHtml}
                            ${updatedHtml}
                        </td>
                        <td><button class="btn-edit" onclick="openEdit(${item.id})"><i class="fa-solid fa-pen"></i></button></td>
                    </tr>
                `;
                tbody.innerHTML += tr;

                const bmetRow = item.bmetUser ? `
                    <div class="card-row">
                        <span class="label">BMET User</span>
                        <span style="font-weight:600; color:#444"><i class="fa-solid fa-user-gear"></i> ${item.bmetUser}</span>
                    </div>` : '';

                const card = `
                    <div class="card ${cardClass}" onclick="openEdit(${item.id})">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start">
                            <h3>${item.name}</h3>
                        </div>
                        <div style="margin-bottom:10px;">${tagsHtml}</div>
                        ${bmetRow}
                        <div class="card-row">
                            <span class="label">Location</span>
                            <span>${item.city}</span>
                        </div>
                        <div class="card-row">
                             <span class="label">Satisfaction</span><span>${satHtml}</span>
                        </div>
                        <div class="card-row">
                             <span class="label">Status</span><span>${statusHtml}</span>
                        </div>
                        <div style="text-align:right; margin-top:8px;">
                            ${updatedHtml}
                        </div>
                    </div>
                `;
                cardGrid.innerHTML += card;
            });
            
            if(!document.getElementById('chartsView').classList.contains('hidden')) {
                renderCharts();
            }
        }

        function renderCharts() {
            const satCounts = { "Satisfied": 0, "Neutral": 0, "Unsatisfied": 0, "Unknown": 0 };
            const statusCounts = {};
            const regionCounts = {};

            db.forEach(item => {
                if(item.satisfaction === 'High' || item.satisfaction === 'Satisfied') satCounts["Satisfied"]++;
                else if(item.satisfaction === 'Medium' || item.satisfaction === 'Neutral') satCounts["Neutral"]++;
                else if(item.satisfaction === 'Low' || item.satisfaction === 'Unsatisfied') satCounts["Unsatisfied"]++;
                else satCounts["Unknown"]++;

                const s = (item.contractStatus === '-' || !item.contractStatus) ? 'No Status' : item.contractStatus;
                statusCounts[s] = (statusCounts[s] || 0) + 1;

                const r = item.region || 'Unknown';
                regionCounts[r] = (regionCounts[r] || 0) + 1;
            });

            const colors = {
                sat: ['#28a745', '#ffc107', '#dc3545', '#ccc'],
                main: '#bfa15f'
            };

            const ctxSat = document.getElementById('satChart').getContext('2d');
            if(chartInstances.sat) chartInstances.sat.destroy();
            chartInstances.sat = new Chart(ctxSat, {
                type: 'doughnut',
                data: {
                    labels: ['Satisfied', 'Neutral', 'Unsatisfied', 'Unknown'],
                    datasets: [{
                        data: Object.values(satCounts),
                        backgroundColor: colors.sat
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Customer Satisfaction' } } }
            });

            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            if(chartInstances.status) chartInstances.status.destroy();
            chartInstances.status = new Chart(ctxStatus, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Hospitals',
                        data: Object.values(statusCounts),
                        backgroundColor: '#2d2d2d'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Call Outcome Status' } } }
            });

            const ctxRegion = document.getElementById('regionChart').getContext('2d');
            if(chartInstances.region) chartInstances.region.destroy();
            chartInstances.region = new Chart(ctxRegion, {
                type: 'bar',
                data: {
                    labels: Object.keys(regionCounts),
                    datasets: [{
                        label: 'Hospitals',
                        data: Object.values(regionCounts),
                        backgroundColor: colors.main
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { title: { display: true, text: 'Hospitals by Region' } } }
            });
        }

        async function saveChanges() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            btn.disabled = true;

            const item = db[currentEditId];
            if (!item) {
                alert("Error: Record not found in local data.");
                btn.textContent = originalText;
                btn.disabled = false;
                return;
            }
            
            const newSat = document.getElementById('editSat').value;
            const newCallStatus = document.getElementById('editCallStatus').value;
            const newNotes = document.getElementById('editNotes').value;
            const newContactName = document.getElementById('editContactName').value;
            const newContactMobile = document.getElementById('editContactMobile').value;

            const payload = {
                hospitalName: item.name, 
                satisfaction: newSat,
                contractStatus: newCallStatus, 
                notes: newNotes,
                contactName: newContactName,
                contactMobile: newContactMobile
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: "follow", 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.result !== "success") {
                    throw new Error(result.message || "Unknown error from server");
                }
                
                // Update Local Data
                item.satisfaction = newSat;
                item.contractStatus = newCallStatus;
                item.notes = newNotes;
                item.contact = newContactName;
                item.mobile = newContactMobile;
                
                // Update timestamp locally
                const now = new Date();
                item.lastUpdated = now.toLocaleDateString();

                closeModal();
                render(); 
                alert("Saved successfully.");

            } catch (error) {
                console.error(error);
                alert("Error saving: " + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        function switchView(view) {
            const table = document.getElementById('tableView');
            const grid = document.getElementById('cardView');
            const charts = document.getElementById('chartsView');
            const controls = document.getElementById('mainControls');
            const btns = document.querySelectorAll('.view-btn');
            
            // Hide all
            table.classList.add('hidden');
            grid.classList.add('hidden');
            charts.classList.add('hidden');
            controls.classList.remove('hidden'); 
            
            // Remove active class
            btns.forEach(b => b.classList.remove('active'));

            if(view === 'table') {
                table.classList.remove('hidden');
                btns[0].classList.add('active');
            } else if(view === 'card') {
                grid.classList.remove('hidden');
                btns[1].classList.add('active');
            } else if(view === 'charts') {
                charts.classList.remove('hidden');
                btns[2].classList.add('active');
                controls.classList.add('hidden'); 
                renderCharts();
            }
        }

        function openEdit(id) {
            currentEditId = id; 
            const item = db[id]; 
            
            document.getElementById('modalTitle').innerText = item.name;
            document.getElementById('modalLocationText').innerText = `${item.region} / ${item.city}`;

            const isWarranty = item.tags.some(tag => tag.toLowerCase().includes('warranty'));
            const warrantyBadge = document.getElementById('warrantyBadge');
            if(isWarranty) {
                warrantyBadge.style.display = 'inline-block';
            } else {
                warrantyBadge.style.display = 'none';
            }
            
            const bmetDisplay = document.getElementById('modalBmetDisplay');
            if(item.bmetUser) {
                document.getElementById('bmetName').innerText = item.bmetUser;
                bmetDisplay.style.display = 'flex';
            } else {
                bmetDisplay.style.display = 'none';
            }

            document.getElementById('editContactName').value = item.contact || "";
            
            const phoneDisplay = document.getElementById('displayPhone');
            const phoneInput = document.getElementById('editContactMobile');
            
            const mobile = item.mobile || "";
            phoneInput.value = mobile;
            
            if(mobile) {
                phoneDisplay.innerHTML = `<a href="tel:${mobile}">${mobile}</a>`;
            } else {
                phoneDisplay.innerHTML = "No Number";
            }

            document.getElementById('editSat').value = (item.satisfaction === '-' || !item.satisfaction) ? '-' : item.satisfaction;
            document.getElementById('editCallStatus').value = (item.contractStatus === '-' || !item.contractStatus) ? '-' : item.contractStatus;
            document.getElementById('editNotes').value = item.notes;

            document.getElementById('editModal').style.display = 'flex';
        }

        function promptPhoneUpdate() {
            const hiddenInput = document.getElementById('editContactMobile');
            const display = document.getElementById('displayPhone');
            
            const current = hiddenInput.value;
            const newPhone = prompt("Enter new mobile number:", current);
            
            if(newPhone !== null) {
                hiddenInput.value = newPhone;
                if(newPhone) {
                    display.innerHTML = `<a href="tel:${newPhone}">${newPhone}</a>`;
                } else {
                    display.innerText = "No Number";
                }
            }
            document.getElementById('editContactName').focus();
        }

        function exportToCSV() {
            if(!db || db.length === 0) {
                alert("No data to export");
                return;
            }

            const headers = ["Hospital Name", "Direction", "Region", "City", "Contact Name", "Contact Mobile", "BMET User", "Satisfaction", "Contract Status", "Last Updated", "Tags", "Notes"];
            
            const csvRows = db.map(item => {
                const row = [
                    item.name,
                    item.direction,
                    item.region,
                    item.city,
                    item.contact,
                    item.mobile,
                    item.bmetUser,
                    item.satisfaction,
                    item.contractStatus,
                    item.lastUpdated,
                    item.tags.join("; "),
                    item.notes.replace(/(\r\n|\n|\r)/gm, " ")
                ];
                
                return row.map(str => {
                    const escaped = String(str).replace(/"/g, '""');
                    return `"${escaped}"`;
                }).join(",");
            });

            const csvContent = [headers.join(","), ...csvRows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "Rowad_Calls_Export.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>
</body>
</html>
