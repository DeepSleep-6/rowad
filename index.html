<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard v1.5 Optimized</title>
    <link rel="icon" href="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- VARIABLES & BASE --- */
        :root { --primary: #2d2d2d; --accent: #A88B4D; --accent-dark: #8c7335; --bg: #f0f2f5; --surface: #ffffff; --text: #2d2d2d; --border: #e9ecef; --active: #5DADE2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* --- UTILITIES (Refactored from Inline) --- */
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .hidden { display: none !important; } .w-full { width: 100%; }
        .text-center { text-align: center; } .text-sm { font-size: 12px; } .text-xs { font-size: 10px; }
        .text-muted { color: #adb5bd; } .text-dark { color: var(--text); } .font-bold { font-weight: 700; } .font-semibold { font-weight: 600; }
        .mb-1 { margin-bottom: 4px; } .mb-2 { margin-bottom: 8px; } .mb-4 { margin-bottom: 16px; } .mt-1 { margin-top: 4px; } .mt-2 { margin-top: 8px; } .mr-2 { margin-right: 8px; }
        
        /* --- COMPONENTS --- */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; width: 100%; box-sizing: border-box; flex: 1; }
        .card-base { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        
        /* Login */
        #loginOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 300px; border-top: 4px solid var(--accent); margin-bottom: 20px; }
        
        /* Nav */
        .top-bar { background: var(--surface); padding: 15px 30px; border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; }
        .logo-img { height: 45px; width: auto; }
        .user-badge { background: #f1f3f5; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .user-badge:hover { background: #e9ecef; }
        .role-tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #e9ecef; color: #495057; font-weight: 700; text-transform: uppercase; }
        .role-admin { background: #e6fcf5; color: #0ca678; border-color: #c3fae8; } .role-rowad { background: #fff4e6; color: #d9480f; border-color: #ffec99; }
        
        /* Controls */
        .view-btn { border: 1px solid transparent; background: transparent; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: #adb5bd; }
        .view-btn.active { background: #fff8e6; color: var(--accent-dark); border-color: #ffe8cc; font-weight: bold; }
        .filter-toggle-btn { background: var(--surface); border: 1px solid var(--border); width: 45px; height: 45px; border-radius: 8px; cursor: pointer; color: var(--text-light); }
        .filter-toggle-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .filter-panel { display: none; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding: 20px; margin-bottom: 25px; animation: slideDown 0.3s; }
        .filter-panel.show { display: grid; }
        @keyframes slideDown { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }

        /* Inputs */
        input, select, textarea { padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; outline: none; transition: 0.2s; font-family: inherit; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(168, 139, 77, 0.1); }
        
        /* Table & Cards */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: var(--surface); }
        .data-table th { padding: 20px; background: #fafafa; color: #8898aa; font-weight: 700; font-size: 12px; border-bottom: 1px solid var(--border); text-align: left; text-transform: uppercase; }
        .data-table td { padding: 18px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { padding: 25px; position: relative; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #e9ecef; }
        .card.interacted::before { background: var(--accent); } 
        .card[data-active="true"]::before { background: var(--active); }
        
        /* Charts */
        .chart-card { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid var(--border); flex: 1; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-card { background: var(--surface); width: 100%; max-width: 650px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .secure-input:disabled { background: transparent; border: none; padding: 0; color: #2d2d2d; font-weight: 600; opacity: 1; -webkit-text-fill-color: #2d2d2d; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; }
        .input-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        /* Misc */
        .btn-action { background: #f8f9fa; color: var(--text-light); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-action:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-save { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-save:hover { background: var(--accent-dark); transform: translateY(-1px); }
        .btn-save:disabled { background: #e9ecef; color: #adb5bd; transform: none; cursor: not-allowed; }
        .btn-save.success { background: #27ae60; pointer-events: none; }
        .tag-pill { font-size: 11px; background: #f1f3f5; padding: 3px 8px; border-radius: 12px; color: #495057; display: inline-block; border: 1px solid #dee2e6; font-weight: 600; margin: 0 4px 2px 0; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e9ecef; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) { 
            .data-table { display: none; } 
            .grid-view { grid-template-columns: 1fr; }
            .top-bar { justify-content: center; position: relative; } 
            .modal-card { width: 95%; margin: 10px; }
            .input-grid-2 { grid-template-columns: 1fr; } 
            .vertical-divider { display: none; }
        }
        @media print { body { background: white; } .no-print { display: none !important; } .data-table { display: table !important; } }
    </style>
</head>
<body>

    <div id="loginOverlay" class="flex items-center justify-center">
        <div class="login-card">
            <h2 class="text-dark mb-1" style="font-size: 22px;">Rowad Calls Dashboard</h2>
            <p class="text-muted mb-4" style="font-size: 13px;">Internal Services Dashboard</p>
            <div id="g_id_onload" data-client_id="174253379694-95msalgnm4kbpjlftil4vm8o26c7h7cc.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-size="large" style="display:flex; justify-content:center;"></div>
        </div>
        <div class="text-center text-muted text-xs" style="position: absolute; bottom: 20px;">Rowad Calls Dashboard v1.5 • Developed by Faisal Alzougbi</div>
    </div>

    <div id="mainDashboard" class="hidden flex-col h-full">
        <div class="top-bar flex items-center justify-between no-print">
            <div class="flex items-center gap-4">
                <img src="https://alrowad-ksa.com/wp-content/themes/cosgrove/assets/images/favicon.ico" class="logo-img">
                <span class="font-bold text-dark" style="font-size: 20px;">Calls Dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="userBadge" class="user-badge" onclick="logout()">
                    <i class="fa-solid fa-user-circle text-muted"></i> <span id="userNameDisplay">User</span> <span id="roleLabel" class="role-tag">Viewer</span>
                </div>
                <div class="vertical-divider" style="width: 1px; height: 24px; background: #dee2e6;"></div>
                <div class="flex gap-2" id="viewControls">
                    <button class="view-btn active" data-view="table"><i class="fa-solid fa-table"></i></button>
                    <button class="view-btn" data-view="card"><i class="fa-solid fa-th-large"></i></button>
                    <button class="view-btn" data-view="charts"><i class="fa-solid fa-chart-pie"></i></button>
                    <button class="view-btn" data-view="export"><i class="fa-solid fa-file-export"></i></button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="flex gap-2 mb-4 items-center no-print">
                <div class="w-full"><input type="text" id="search" placeholder="Search Hospital, Contact..." onkeyup="debouncedRender()"></div>
                <button class="filter-toggle-btn" onclick="toggleFilters()"><i class="fa-solid fa-filter"></i></button>
            </div>

            <div id="filterPanel" class="filter-panel card-base no-print">
                <select id="filterDirection" onchange="debouncedRender()"></select>
                <select id="filterRegion" onchange="handleRegionChange()"></select>
                <select id="filterCity" onchange="debouncedRender()"></select>
                <select id="filterStatus" onchange="debouncedRender()">
                    <option value="All">All Statuses</option> <option value="Pending">Pending</option> <option value="Quote Requested">Quote Requested</option> 
                    <option value="Call Later">Call Later</option> <option value="No Answer">No Answer</option> <option value="Renewed">Renewed</option> 
                    <option value="Active Contract">Active Contract</option> <option value="Not Interested">Not Interested</option>
                </select>
                <select id="filterSat" onchange="debouncedRender()">
                    <option value="All">All Satisfaction</option> <option value="Satisfied">Satisfied</option> <option value="Unsatisfied">Unsatisfied</option> <option value="Neutral">Neutral</option>
                </select>
            </div>

            <div id="loading" class="text-center" style="padding: 80px 0;"><div class="spinner"></div><span class="text-muted">Loading Database...</span></div>

            <table class="data-table hidden" id="tableView">
                <thead><tr><th width="35%">Hospital</th> <th>Location</th> <th>Devices</th> <th>Satisfaction</th> <th>Status</th> <th style="text-align:right">Action</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
            
            <div class="grid-view hidden" id="cardView"></div>

            <div id="chartsView" class="hidden">
                <h3 class="text-dark font-bold mb-4" style="font-size: 18px;">Overview</h3>
                <div class="flex gap-4 mb-4" style="flex-wrap: wrap;">
                    <div class="chart-card"><h3 class="text-dark font-semibold mt-1">Device Ownership</h3><div class="chart-wrapper"><canvas id="deviceChart"></canvas></div></div>
                    <div class="chart-card"><h3 class="text-dark font-semibold mt-1">Satisfaction</h3><div class="chart-wrapper"><canvas id="satChart"></canvas></div></div>
                    <div class="chart-card"><h3 class="text-dark font-semibold mt-1">Sales Funnel</h3><div class="chart-wrapper"><canvas id="funnelChart"></canvas></div></div>
                    <div class="chart-card"><h3 class="text-dark font-semibold mt-1">Call Outcomes</h3><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div>
                </div>
                <h3 class="text-dark font-bold mb-4 mt-4" style="font-size: 18px;">Team Performance</h3>
                <div class="input-grid-2">
                     <div class="chart-card"><h3 class="text-dark font-semibold mt-1">Total Activities</h3><div class="chart-wrapper"><canvas id="activityChart"></canvas></div></div>
                     <div class="chart-card"><h3 class="text-dark font-semibold mt-1">Quotations Generated</h3><div class="chart-wrapper"><canvas id="quoteChart"></canvas></div></div>
                </div>
            </div>

            <div id="exportView" class="hidden text-center" style="padding-top: 40px;">
                <div class="chart-card" style="max-width: 700px; margin: 0 auto; padding: 40px;">
                    <i class="fa-solid fa-file-export mb-4" style="font-size: 24px; color: var(--accent); background: #fff8e6; padding: 15px; border-radius: 50%;"></i>
                    <h2 class="mb-2 mt-2">Custom Data Export</h2>
                    <p class="text-muted mb-4">Select columns for your report.</p>
                    <div id="columnPicker" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; text-align: left; margin: 25px 0;"></div>
                    <div class="flex gap-4 justify-center">
                        <button onclick="downloadCSV()" class="btn-save" style="width: auto; padding: 12px 25px;"><i class="fa-solid fa-file-csv mr-2"></i> CSV</button>
                        <button onclick="window.print()" class="btn-action" style="background: white;"><i class="fa-solid fa-print mr-2"></i> PDF</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center text-muted text-xs p-4 no-print">Rowad Calls Dashboard v1.5 • Developed by Faisal Alzougbi</div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="flex justify-between items-center" style="padding: 20px 30px; border-bottom: 1px solid var(--border); background: #fcfcfc;">
                <div><h2 class="text-dark m-0" style="font-size:20px;" id="modalTitle">Hospital</h2><div id="modalSubtitle" class="text-muted text-xs mt-1"></div></div>
                <button onclick="closeModal()" style="border:none; background:none; font-size:20px; cursor:pointer; color:#adb5bd;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4" style="padding: 30px;">
                <div class="info-grid">
                    <div><label class="block">Region</label><div id="dispRegion">-</div></div> <div><label class="block">City</label><div id="dispCity">-</div></div>
                    <div><label class="block">Device</label><div id="dispDevice">-</div></div> <div><label class="block">Surfacide SN</label><div id="dispSurfSN">-</div></div>
                    <div><label class="block">AccuFIT SN</label><div id="dispAccuSN">-</div></div> <div><label class="block">Surfacide User</label><div id="dispSurfUser">-</div></div>
                </div>
                <div class="input-grid-2">
                    <div>
                        <label class="block">Contact Person</label>
                        <div class="contact-box" style="background:#fff; padding:15px; border:1px solid var(--border); border-radius:10px;">
                            <input type="text" id="editContactName" class="secure-input" disabled placeholder="Name">
                            <div class="flex items-center mt-2 pt-2" style="border-top:1px solid #f1f3f5;">
                                <i class="fa-solid fa-phone mr-2 text-muted"></i> <span id="displayPhone" class="font-semibold text-sm">***</span>
                                <a id="waLink" class="wa-btn hidden" target="_blank" style="margin-left:auto"><i class="fa-brands fa-whatsapp"></i></a>
                            </div>
                            <input type="hidden" id="editContactMobile">
                            <button id="editPhoneBtn" onclick="promptPhoneUpdate()" class="hidden mt-2 text-xs font-semibold" style="color:var(--accent); border:none; background:none; cursor:pointer; padding:0;">Change Number</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4">
                        <div><label class="block">Status</label><select id="editStatus" class="secure-input" disabled>
                            <option value="">-</option><option value="No Answer">No Answer</option><option value="Call Later">Call Later</option>
                            <option value="Quote Requested">Quote Requested</option><option value="Not Interested">Not Interested</option>
                            <option value="Renewed">Renewed</option><option value="Active Contract">Active Contract</option>
                        </select></div>
                        <div><label class="block">Satisfaction</label><select id="editSat" class="secure-input" disabled><option value="">-</option><option value="Satisfied">Satisfied</option><option value="Unsatisfied">Unsatisfied</option><option value="Neutral">Neutral</option></select></div>
                        <div><label class="block">Tags</label><input type="text" id="editTags" class="secure-input" disabled placeholder="VIP..."></div>
                    </div>
                </div>
                <div class="mb-4"><label class="block">Notes</label><textarea id="editNotes" class="secure-input" disabled style="min-height:80px;" placeholder="Add notes..."></textarea></div>
                <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>Login to Edit</button>
                <div id="loginPrompt" class="text-center text-muted text-sm mt-2 hidden"><i class="fa-solid fa-lock mr-2"></i> Only Editors can save</div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaush-5NL-MH3OXm7mqXdj4Gy9M9Wlv8qh8Pe7UmlaH5k7jcb4T218DDpHfD4r4B3asA/exec"; 
        let db = [], historyDB = [], userMap = {}, currentEditIndex = -1;
        let currentUser = { email: null, token: null, role: 'Public' };
        let chartInstances = {};
        const escapeHtml = (s) => (s||'').toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const resolveID = (e) => userMap[e?.split(' on ')[0]] || e?.split(' on ')[0] || "Unknown";
        const priority = { "Quote Requested":1, "Call Later":2, "No Answer":3, "Pending":4, "Renewed":5, "Satisfied":5, "Active Contract":6 };

        window.onload = () => {
            checkSession();
            document.getElementById('viewControls').addEventListener('click', (e) => {
                const btn = e.target.closest('button'); if(btn) switchView(btn.dataset.view);
            });
        };

        async function api(action, payload={}) {
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, token: currentUser.token, ...payload }) });
                return await res.json();
            } catch(e) { console.error(e); return { result: 'error', message: 'Connection Failed' }; }
        }

        function checkSession() {
            try {
                const sess = JSON.parse(localStorage.getItem('rowad_user'));
                if (sess && (Date.now() - sess.timestamp < 32400000)) { // 9 hours
                    currentUser = sess.user; showDashboard(); fetchData(); return;
                }
            } catch(e) {}
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        window.handleCredentialResponse = async (res) => {
            currentUser.token = res.credential;
            const json = await api('login');
            if (json.result === 'success') {
                currentUser = { email: json.email, role: json.role, token: res.credential };
                localStorage.setItem('rowad_user', JSON.stringify({ user: currentUser, timestamp: Date.now() }));
                showDashboard(); fetchData();
            } else alert("Login Failed: " + json.message);
        };

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainDashboard').classList.replace('hidden', 'flex');
            document.getElementById('userNameDisplay').innerText = currentUser.email.split('@')[0];
            const tag = document.getElementById('roleLabel');
            tag.innerText = currentUser.role;
            tag.className = `role-tag role-${currentUser.role === 'Rowad' ? 'rowad' : (['Admin','Editor'].includes(currentUser.role) ? 'admin' : 'viewer')}`;
        }

        window.logout = () => { localStorage.removeItem('rowad_user'); location.reload(); };

        // Optimized Filter Logic
        async function fetchData() {
            const json = await api('fetch_data');
            if (json.result === 'error') return logout();
            db = json.data; 
            if(json.permissions) json.permissions.forEach(p => userMap[p.Email] = p.ID);
            if(json.history) historyDB = json.history;
            if(userMap[currentUser.email]) document.getElementById('userNameDisplay').innerText = userMap[currentUser.email];
            
            // Populate Filters
            ['Direction', 'Region'].forEach(k => {
                const el = document.getElementById(`filter${k}`);
                el.innerHTML = `<option value="All">All ${k}s</option>` + [...new Set(db.map(r=>r[k]).filter(Boolean))].sort().map(v=>`<option>${v}</option>`).join('');
            });
            handleRegionChange();
            
            // Export Columns
            document.getElementById('columnPicker').innerHTML = Object.keys(db[0]).filter(k=>!k.startsWith('_')).map(k=>`<label class="flex items-center gap-2"><input type="checkbox" checked value="${k}"> ${k}</label>`).join('');
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableView').classList.remove('hidden');
            render();
        }

        window.handleRegionChange = () => {
            const reg = document.getElementById('filterRegion').value;
            const cities = [...new Set(db.filter(r => reg === 'All' || r.Region === reg).map(r => r.City).filter(Boolean))].sort();
            document.getElementById('filterCity').innerHTML = '<option value="All">All Cities</option>' + cities.map(c=>`<option>${c}</option>`).join('');
            debouncedRender();
        };

        let timeout; 
        window.debouncedRender = () => { clearTimeout(timeout); timeout = setTimeout(render, 300); };

        function render() {
            const filters = {
                Direction: document.getElementById('filterDirection').value, Region: document.getElementById('filterRegion').value,
                City: document.getElementById('filterCity').value, Status: document.getElementById('filterStatus').value, Satisfaction: document.getElementById('filterSat').value
            };
            const search = document.getElementById('search').value.toLowerCase();
            
            db.sort((a,b) => (priority[a.Status]||9) - (priority[b.Status]||9));
            
            const flt = db.filter(row => {
                if (!Object.keys(filters).every(k => filters[k] === 'All' || (row[k]||'Pending') === filters[k])) return false;
                return (row["Hospital Name"]+row.Contact+row.City).toLowerCase().includes(search);
            });

            const getColor = (s) => { s=(s||'').toLowerCase(); return s.match(/renew|sat/) ? '#27ae60' : s.match(/quote|call/) ? '#2980b9' : s.match(/active/) ? '#5DADE2' : s.match(/no|unsat|not/) ? '#d35400' : '#666'; };

            // Render Table
            document.getElementById('tableBody').innerHTML = flt.map(i => `
                <tr>
                    <td><div class="font-semibold text-dark">${escapeHtml(i["Hospital Name"])}</div><div class="text-sm text-muted">${escapeHtml(i.Contact)}</div></td>
                    <td class="text-sm text-muted">${escapeHtml(i.City)}</td>
                    <td><div class="text-sm font-semibold">${escapeHtml(i.Device)}</div><div class="mt-1">${(i.Tags||'').split(',').map(t=>t?`<span class="tag-pill">${t}</span>`:'').join('')}</div></td>
                    <td><span style="color:${getColor(i.Satisfaction)}; background:${getColor(i.Satisfaction)}15; padding:4px 8px; border-radius:4px; font-size:13px; font-weight:600">${escapeHtml(i.Satisfaction||'-')}</span></td>
                    <td><span style="color:${getColor(i.Status)}; font-weight:600; font-size:13px">${escapeHtml(i.Status||'-')}</span></td>
                    <td style="text-align:right"><button class="btn-action" onclick="openEdit(${i._rowIndex})"><i class="fa-solid fa-pen"></i></button></td>
                </tr>`).join('');

            // Render Cards
            document.getElementById('cardView').innerHTML = flt.map(i => `
                <div class="card card-base ${(i.Status||'Pending')!=='Pending'?'interacted':''}" data-active="${i.Status==='Active Contract'}" onclick="openEdit(${i._rowIndex})">
                    <h3 class="mb-2 m-0" style="font-size:16px;">${escapeHtml(i["Hospital Name"])}</h3>
                    <div class="text-xs text-muted mb-2 font-bold">${escapeHtml(i.Device||'No Device')} • ${escapeHtml(i.Region)}</div>
                    <p class="text-sm text-muted mb-4"><i class="fa-solid fa-location-dot mr-2"></i> ${escapeHtml(i.City)}</p>
                    <div class="flex justify-between items-center pt-2" style="border-top:1px solid #f1f3f5">
                        <span style="color:${getColor(i.Status)}; font-weight:600; font-size:12px;">${escapeHtml(i.Status||'Pending')}</span>
                        ${i.Contact ? '<i class="fa-solid fa-user text-muted"></i>' : ''}
                    </div>
                </div>`).join('');
            
            if(!document.getElementById('chartsView').classList.contains('hidden')) renderCharts(flt);
        }

        // Optimized Chart Factory
        function renderCharts(data) {
            const counts = { sat:{}, stat:{}, dev:{'Surfacide':0,'AccuFIT':0}, funnel:{'Total':data.length,'Contacted':0,'Quotes':0,'Active':0} };
            const team = { act:{}, quo:{} };
            
            // Aggregation Loop
            data.forEach(i => {
                const s = i.Status || 'Pending';
                if(s!=='Pending') counts.funnel.Contacted++;
                if(s==='Quote Requested') counts.funnel.Quotes++;
                if(['Renewed','Active Contract'].includes(s)) counts.funnel.Active++;
                if(!['Pending','Active Contract'].includes(s)) counts.stat[s] = (counts.stat[s]||0)+1;
                if(i.Satisfaction) counts.sat[i.Satisfaction] = (counts.sat[i.Satisfaction]||0)+1;
                if((i.Device||'').toLowerCase().includes('surf')) counts.dev.Surfacide++;
                if((i.Device||'').toLowerCase().includes('accu')) counts.dev.AccuFIT++;
            });

            historyDB.forEach(h => {
                const u = resolveID(h.User);
                team.act[u] = (team.act[u]||0)+1;
                if(h["Field Changed"]==='Status' && h["New Value"]==='Quote Requested') team.quo[u] = (team.quo[u]||0)+1;
            });

            const mkChart = (id, type, labels, vals, colors, idx='x') => {
                if(chartInstances[id]) chartInstances[id].destroy();
                chartInstances[id] = new Chart(document.getElementById(id), {
                    type, indexAxis: idx,
                    data: { labels, datasets: [{ data: vals, backgroundColor: colors, borderRadius: 4, barThickness: idx==='y'?20:undefined }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type==='doughnut', position:'right' } }, scales: { [idx]: { grid: { display: false } } } }
                });
            };

            const sort = (o) => Object.entries(o).sort((a,b)=>b[1]-a[1]);
            const actS = sort(team.act), quoS = sort(team.quo);

            mkChart('deviceChart', 'bar', Object.keys(counts.dev), Object.values(counts.dev), ['#A88B4D', '#2d2d2d']);
            mkChart('satChart', 'doughnut', Object.keys(counts.sat), Object.values(counts.sat), ['#27ae60', '#d35400', '#95a5a6']);
            mkChart('funnelChart', 'bar', Object.keys(counts.funnel), Object.values(counts.funnel), ['#e9ecef', '#C4B27D', '#A88B4D', '#2d2d2d'], 'y');
            mkChart('statusChart', 'bar', Object.keys(counts.stat), Object.values(counts.stat), '#666');
            mkChart('activityChart', 'bar', actS.map(x=>x[0]), actS.map(x=>x[1]), '#2d2d2d', 'y');
            mkChart('quoteChart', 'bar', quoS.map(x=>x[0]), quoS.map(x=>x[1]), '#27ae60', 'y');
        }

        // Optimized Modal
        window.openEdit = (idx) => {
            currentEditIndex = idx;
            const i = db.find(r => r._rowIndex === idx);
            if(!i) return;
            
            const raw = i["Last Editor"] || "Unknown";
            document.getElementById('modalTitle').innerText = i["Hospital Name"];
            document.getElementById('modalSubtitle').innerText = `Last updated by: ${resolveID(raw)}${raw.includes(' on ')?' on '+raw.split(' on ')[1]:''}`;
            
            const map = {
                dispRegion:'Region', dispCity:'City', dispDevice:'Device', dispSurfSN:'Surfacide SN', dispAccuSN:'AccuFIT SN', dispSurfUser:'Surfacide Username',
                editContactName:'Contact', editContactMobile:'Contact Mobile Number', editStatus:'Status', editSat:'Satisfaction', editTags:'Tags', editNotes:'Notes'
            };
            
            Object.entries(map).forEach(([eid, key]) => {
                const el = document.getElementById(eid);
                const val = i[key] || (el.tagName === 'DIV' ? '-' : '');
                if(el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') el.value = val; else el.innerText = val;
            });

            // Phone Logic
            const mob = i["Contact Mobile Number"], hasMob = mob && mob.length > 5;
            document.getElementById('displayPhone').innerText = mob || "No Number";
            document.getElementById('waLink').classList.toggle('hidden', !hasMob);
            if(hasMob) document.getElementById('waLink').href = `https://wa.me/966${mob.match(/\d+/)?.[0].slice(-9)}?text=${encodeURIComponent("يرجى المشاركة في هذا التقييم: https://forms.gle/DfmEtq8LftRDrAqz5")}`;

            // Permissions
            const canEdit = ['Admin','Editor'].includes(currentUser.role);
            document.querySelectorAll('.secure-input').forEach(e => e.disabled = !canEdit);
            document.getElementById('saveBtn').disabled = !canEdit;
            document.getElementById('saveBtn').innerText = canEdit ? "Save Updates" : "Login to Edit";
            document.getElementById('editPhoneBtn').classList.toggle('hidden', !canEdit);
            document.getElementById('loginPrompt').classList.toggle('hidden', canEdit);
            document.getElementById('editModal').style.display = 'flex';
        };

        window.promptPhoneUpdate = () => {
            const n = prompt("Update Number:", document.getElementById('editContactMobile').value);
            if(n) { document.getElementById('editContactMobile').value = n; document.getElementById('displayPhone').innerText = n; }
        };

        window.saveChanges = async () => {
            const btn = document.getElementById('saveBtn'), old = btn.innerText;
            btn.innerText = "Saving...";
            const data = { _rowIndex: currentEditIndex, "Last Editor": `${currentUser.email} on ${new Date().toLocaleDateString('en-GB')}` };
            ['Contact','Contact Mobile Number','Status','Satisfaction','Tags','Notes'].forEach(k => 
                data[k] = document.getElementById(k === 'Contact' ? 'editContactName' : k === 'Contact Mobile Number' ? 'editContactMobile' : k === 'Status' ? 'editStatus' : k === 'Satisfaction' ? 'editSat' : k === 'Tags' ? 'editTags' : 'editNotes').value
            );
            
            const res = await api('save', { userEmail: currentUser.email, data });
            if(res.result === 'success') {
                Object.assign(db.find(r => r._rowIndex === currentEditIndex), data);
                render(); btn.classList.add('success'); btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
                setTimeout(() => { btn.classList.remove('success'); btn.innerText = old; closeModal(); }, 1500);
            } else { alert("Error: " + res.message); btn.innerText = old; }
        };

        window.closeModal = () => document.getElementById('editModal').style.display = 'none';
        window.switchView = (v) => {
            ['table','card','charts','export'].forEach(k => document.getElementById(k+'View').classList.toggle('hidden', v!==k));
            document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view===v));
            if(v==='charts') render();
        };
        window.toggleFilters = () => { document.getElementById('filterPanel').classList.toggle('show'); document.querySelector('.filter-toggle-btn').classList.toggle('active'); };
        window.downloadCSV = () => {
            const cols = [...document.querySelectorAll('#columnPicker input:checked')].map(c=>c.value);
            if(!cols.length) return alert("Select columns");
            const csv = [cols.join(',')]
                .concat(db.map(r => cols.map(c => `"${(r[c]||'').toString().replace(/"/g, '""')}"`).join(',')))
                .join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'data.csv'; a.click();
        };
    </script>
</body>
</html>
