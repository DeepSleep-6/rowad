<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Service Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #003366; 
            --secondary: #00a8e8; 
            --bg: #f4f7f6;
            --surface: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --border: #e2e8f0;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: var(--text-main); }
        
        /* Layout */
        .top-bar { background: var(--surface); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .view-toggles { display: flex; gap: 5px; background: #eee; padding: 4px; border-radius: 8px; }
        .view-btn { border: none; background: none; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; }
        .view-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .loading { text-align: center; padding: 40px; color: var(--text-light); font-size: 18px; }

        /* Controls */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 2; min-width: 250px; }
        .filter-box { flex: 1; min-width: 150px; }
        
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        /* Tags */
        .tag { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 4px; margin-bottom: 2px; }
        .tag-Surfacide { background: #e3f2fd; color: #0d47a1; }
        .tag-AccuFIT { background: #f3e5f5; color: #4a148c; }
        .tag-Warranty { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .tag-VIP { background: #fff3cd; color: #856404; }
        .tag-Expired { background: #ffebee; color: #c62828; }
        .tag-generic { background: #eee; color: #333; }

        /* Views */
        .hidden { display: none !important; }
        
        /* Table */
        .data-table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .data-table th { text-align: left; padding: 15px; background: #f8f9fa; color: var(--text-light); font-weight: 600; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .data-table tr:hover { background-color: #f8faff; }
        
        /* Grid */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; font-size: 18px; color: var(--primary); }
        .card-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .label { color: var(--text-light); font-size: 12px; }

        /* Satisfaction Dots */
        .sat-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sat-High { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .sat-Medium { background: #ffc107; }
        .sat-Low { background: #dc3545; }
        
        /* Buttons */
        .btn-edit { background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-edit:hover { opacity: 0.9; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 16px; width: 500px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-light); font-weight: 600; }
        textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }

        /* Mobile */
        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .data-table { display: none; } 
            .grid-view { display: grid !important; }
            .view-toggles { display: none; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo">
            <i class="fa-solid fa-hospital-user"></i> Rowad<span style="color:var(--secondary)">Track</span>
        </div>
        <div class="view-toggles">
            <button class="view-btn active" onclick="switchView('table')"><i class="fa-solid fa-table"></i> Table</button>
            <button class="view-btn" onclick="switchView('card')"><i class="fa-solid fa-grid-2"></i> Grid</button>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search" placeholder="Search Hospital or Contact..." onkeyup="render()">
            </div>
            
            <div class="filter-box">
                <select id="filterDirection" onchange="updateRegionOptions()">
                    <option value="All">All Directions</option>
                    </select>
            </div>
            
            <div class="filter-box hidden" id="boxRegion">
                <select id="filterRegion" onchange="updateCityOptions()">
                    <option value="All">All Regions</option>
                </select>
            </div>

            <div class="filter-box hidden" id="boxCity">
                <select id="filterCity" onchange="render()">
                    <option value="All">All Cities</option>
                </select>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Loading Database...
        </div>

        <table class="data-table hidden" id="tableView">
            <thead>
                <tr>
                    <th style="width: 30%">Hospital</th>
                    <th>Location</th>
                    <th>Satisfaction</th>
                    <th>Tags / Devices</th>
                    <th>Contract Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="grid-view hidden" id="cardView"></div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle" style="margin:0; color:var(--primary)">Edit Hospital</h2>
                <button onclick="closeModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Customer Satisfaction</label>
                <select id="editSat">
                    <option value="">Unknown</option>
                    <option value="High">High (Happy)</option>
                    <option value="Medium">Medium (Neutral)</option>
                    <option value="Low">Low (Unhappy)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Contract Status</label>
                <select id="editStatus">
                    <option value="">Unknown</option>
                    <option value="Active">Contract Active</option>
                    <option value="Expired">Expired - Needs Renewal</option>
                    <option value="Pending">Renewal Pending</option>
                </select>
            </div>

            <div class="form-group">
                <label>Internal Notes</label>
                <textarea id="editNotes" rows="3"></textarea>
            </div>

            <button id="saveBtn" onclick="saveChanges()" style="width:100%; background:var(--primary); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Save Updates</button>
        </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        // Use your previously deployed Web App URL here
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGOMphPx4DRkwKMm91i4ejJ5BsReQNDMLLX9x122UozWRJo1HqIWJa4axRhzELDS8lnA/exec";
        
        let db = [];
        let currentEditName = "";

        // Start
        window.onload = fetchData;

        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                db = data.map(row => {
                    // Auto-generate tags from 'Device' column
                    let autoTags = [];
                    const device = row['Device'] || '';
                    if (device.includes('Surfacide') || device === 'Both') autoTags.push('Surfacide');
                    if (device.includes('AccuFIT') || device === 'Both') autoTags.push('AccuFIT');
                    
                    // Manual tags from 'Tags' column
                    let manualTags = row['Tags'] ? row['Tags'].split(',').map(s => s.trim()) : [];
                    
                    // Combine unique tags
                    let combinedTags = [...new Set([...autoTags, ...manualTags])];

                    return {
                        name: row['Hospital Name'],
                        direction: row['Direction'] || 'Unknown',
                        region: row['Region'] || 'Unknown',
                        city: row['City'] || 'Unknown',
                        contact: row['Contact'] || 'N/A',
                        
                        // New Fields
                        satisfaction: row['Satisfaction'] || '',
                        contractStatus: row['ContractStatus'] || '',
                        tags: combinedTags,
                        notes: row['Notes'] || ''
                    };
                });

                initFilters();
                document.getElementById('loading').style.display = 'none';
                switchView('table');
                render();
            } catch (error) {
                document.getElementById('loading').innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
            }
        }

        // --- Cascading Filter Logic ---
        function initFilters() {
            const directions = [...new Set(db.map(item => item.direction))].sort();
            const select = document.getElementById('filterDirection');
            // Reset
            select.innerHTML = '<option value="All">All Directions</option>';
            directions.forEach(d => {
                if(d) select.add(new Option(d, d));
            });
        }

        function updateRegionOptions() {
            const dir = document.getElementById('filterDirection').value;
            const regionBox = document.getElementById('boxRegion');
            const cityBox = document.getElementById('boxCity');
            
            if (dir === 'All') {
                regionBox.classList.add('hidden');
                cityBox.classList.add('hidden');
                document.getElementById('filterRegion').value = 'All';
                document.getElementById('filterCity').value = 'All';
                render();
                return;
            }

            // Filter regions belonging to this direction
            const regions = [...new Set(db.filter(x => x.direction === dir).map(x => x.region))].sort();
            const select = document.getElementById('filterRegion');
            select.innerHTML = '<option value="All">All Regions</option>';
            regions.forEach(r => select.add(new Option(r, r)));
            
            regionBox.classList.remove('hidden');
            cityBox.classList.add('hidden'); // Hide city until region is picked
            render();
        }

        function updateCityOptions() {
            const region = document.getElementById('filterRegion').value;
            const cityBox = document.getElementById('boxCity');

            if (region === 'All') {
                cityBox.classList.add('hidden');
                document.getElementById('filterCity').value = 'All';
                render();
                return;
            }

            // Filter cities belonging to this region
            const cities = [...new Set(db.filter(x => x.region === region).map(x => x.city))].sort();
            const select = document.getElementById('filterCity');
            select.innerHTML = '<option value="All">All Cities</option>';
            cities.forEach(c => select.add(new Option(c, c)));

            cityBox.classList.remove('hidden');
            render();
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            const cardGrid = document.getElementById('cardView');
            tbody.innerHTML = '';
            cardGrid.innerHTML = '';

            const search = document.getElementById('search').value.toLowerCase();
            const filterDir = document.getElementById('filterDirection').value;
            const filterReg = document.getElementById('filterRegion').value;
            const filterCity = document.getElementById('filterCity').value;

            db.forEach(item => {
                // Filters
                if (!item.name.toLowerCase().includes(search) && !item.contact.toLowerCase().includes(search)) return;
                if (filterDir !== 'All' && item.direction !== filterDir) return;
                if (filterReg !== 'All' && item.region !== filterReg) return;
                if (filterCity !== 'All' && item.city !== filterCity) return;

                // Visual Helpers
                // Hide Satisfaction if blank/Unknown
                let satHtml = '';
                if(item.satisfaction && item.satisfaction !== 'Unknown') {
                    satHtml = `<span class="sat-dot sat-${item.satisfaction}"></span> ${item.satisfaction}`;
                }

                // Hide Status if blank/Unknown
                let statusHtml = '';
                if(item.contractStatus && item.contractStatus !== 'Unknown') {
                    let color = '#2c3e50';
                    if(item.contractStatus === 'Active') color = '#28a745';
                    if(item.contractStatus === 'Expired') color = '#dc3545';
                    if(item.contractStatus === 'Pending') color = '#ffc107';
                    statusHtml = `<span style="font-weight:bold; color: ${color}">${item.contractStatus}</span>`;
                }

                // Tags HTML
                let tagsHtml = '';
                item.tags.forEach(t => {
                    let cls = 'tag-generic';
                    if(t === 'Surfacide') cls = 'tag-Surfacide';
                    if(t === 'AccuFIT') cls = 'tag-AccuFIT';
                    if(t.toLowerCase().includes('warranty')) cls = 'tag-Warranty';
                    if(t === 'VIP') cls = 'tag-VIP';
                    tagsHtml += `<span class="tag ${cls}">${t}</span>`;
                });

                // 1. Table Row
                const tr = `
                    <tr>
                        <td>
                            <strong>${item.name}</strong><br>
                            <span style="font-size:12px; color:#888">${item.contact}</span>
                        </td>
                        <td>${item.region} / ${item.city}</td>
                        <td>${satHtml}</td>
                        <td>${tagsHtml}</td>
                        <td>${statusHtml}</td>
                        <td><button class="btn-edit" onclick="openEdit('${item.name.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pen"></i> Edit</button></td>
                    </tr>
                `;
                tbody.innerHTML += tr;

                // 2. Card
                const card = `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start">
                            <h3>${item.name}</h3>
                            <button class="btn-edit" onclick="openEdit('${item.name.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pen"></i></button>
                        </div>
                        <div style="margin-bottom:10px;">${tagsHtml}</div>
                        <div class="card-row">
                            <span class="label">Location</span>
                            <span>${item.city}</span>
                        </div>
                        ${satHtml ? `<div class="card-row"><span class="label">Satisfaction</span><span>${satHtml}</span></div>` : ''}
                        ${statusHtml ? `<div class="card-row"><span class="label">Contract</span><span>${statusHtml}</span></div>` : ''}
                    </div>
                `;
                cardGrid.innerHTML += card;
            });
        }

        async function saveChanges() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            btn.disabled = true;

            const item = db.find(x => x.name === currentEditName);
            
            const newSat = document.getElementById('editSat').value;
            const newStatus = document.getElementById('editStatus').value;
            const newNotes = document.getElementById('editNotes').value;
            
            // NOTE: We do not send 'tags' back because you said website doesn't add/delete them.

            const payload = {
                hospitalName: item.name, 
                satisfaction: newSat,
                contractStatus: newStatus,
                notes: newNotes
            };

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                
                // Update Local Data
                item.satisfaction = newSat;
                item.contractStatus = newStatus;
                item.notes = newNotes;
                
                alert("Saved successfully!");
                closeModal();
                render(); 

            } catch (error) {
                alert("Error saving: " + error);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function switchView(view) {
            const table = document.getElementById('tableView');
            const grid = document.getElementById('cardView');
            const btns = document.querySelectorAll('.view-btn');
            
            if(view === 'table') {
                table.classList.remove('hidden');
                grid.classList.add('hidden');
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                table.classList.add('hidden');
                grid.classList.remove('hidden');
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
            }
        }

        function openEdit(name) {
            currentEditName = name;
            const item = db.find(x => x.name === name);
            
            document.getElementById('modalTitle').innerText = item.name;
            document.getElementById('editSat').value = item.satisfaction || "";
            document.getElementById('editStatus').value = item.contractStatus || "";
            document.getElementById('editNotes').value = item.notes;
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>
</body>
</html>
