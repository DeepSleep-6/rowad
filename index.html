<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowad Calls Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* Rowad Palette */
            --primary: #2d2d2d; 
            --accent: #bfa15f; 
            --accent-dark: #a3884d;
            --bg: #f4f4f4;
            --surface: #ffffff;
            --text-main: #2d2d2d;
            --text-light: #666666;
            --border: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: var(--text-main); }
        
        /* Layout */
        .top-bar { background: var(--surface); padding: 15px 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 3px solid var(--accent); }
        .logo { font-size: 24px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent); }
        
        .view-toggles { display: flex; gap: 5px; background: #eee; padding: 4px; border-radius: 8px; }
        .view-btn { border: none; background: none; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; }
        .view-btn.active { background: white; color: var(--accent-dark); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .loading { text-align: center; padding: 40px; color: var(--text-light); font-size: 18px; }

        /* Controls */
        .controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .search-box { flex: 2; min-width: 250px; }
        .filter-box { flex: 1; min-width: 150px; }
        
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(191, 161, 95, 0.2); }
        
        /* Tags - Unified Neutral Style */
        .tag { 
            display: inline-flex; 
            align-items: center; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 600; 
            margin-right: 4px; 
            margin-bottom: 2px;
            background: #eee; 
            color: #444; 
            border: 1px solid #ddd;
        }

        /* Views */
        .hidden { display: none !important; }
        
        /* Table */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--surface); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .data-table th { text-align: left; padding: 18px 15px; background: #fafafa; color: var(--text-light); font-weight: 700; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .data-table tr:last-child td { border-bottom: none; }
        
        /* Table Row Visual States */
        .row-renewed { background-color: #f0fff4; color: #155724; }
        .row-renewed:hover { background-color: #e3f9e9 !important; }
        .row-dead { opacity: 0.6; background-color: #f9f9f9; filter: grayscale(1); }
        .row-dead:hover { opacity: 0.8; }

        /* Grid */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .card h3 { margin: 0 0 10px 0; font-size: 18px; color: var(--text-main); }
        .card-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .label { color: var(--text-light); font-size: 12px; }

        /* Card Visual States */
        .card-renewed { background-color: #f0fff4; border-color: #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1); }
        .card-renewed h3 { color: #155724; }
        .card-dead { opacity: 0.6; background-color: #f9f9f9; filter: grayscale(1); border-style: dashed; }
        .card-dead:hover { opacity: 0.8; }

        /* Satisfaction Dots */
        .sat-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sat-Satisfied { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .sat-Neutral { background: #ffc107; }
        .sat-Unsatisfied { background: #dc3545; }
        .sat-High { background: #28a745; }
        .sat-Medium { background: #ffc107; }
        .sat-Low { background: #dc3545; }
        
        /* Buttons */
        .btn-edit { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-edit:hover { background: var(--accent-dark); }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        
        .modal-card {
            background-color: var(--surface);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border-top: 5px solid var(--accent);
            position: relative;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .header-content { display: flex; flex-direction: column; gap: 8px; }
        .modal-title { color: #0f172a; font-size: 24px; font-weight: 700; margin: 0; }

        .warranty-tag {
            display: none; 
            background-color: #eee; 
            color: #333;
            border: 1px solid #ccc;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: flex-start;
        }

        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); padding: 0; line-height: 1; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: var(--text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px; }

        .contact-box { background-color: #fcfcfc; border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; position: relative; transition: border-color 0.2s; }
        .contact-box:focus-within { border-color: var(--accent); }

        .contact-name-input { border: none; background: transparent; font-size: 16px; color: var(--text-main); width: 90%; outline: none; font-weight: 500; font-family: inherit; }
        .contact-phone { display: flex; align-items: center; color: #0f172a; font-weight: 700; margin-top: 4px; font-size: 18px; }
        .phone-icon { margin-right: 8px; color: #0f172a; font-size: 14px; }
        
        .edit-icon-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); cursor: pointer; background: none; border: none; font-size: 16px; }

        .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; color: var(--text-main); box-sizing: border-box; outline: none; background-color: #fff; font-family: inherit; }
        .form-select:focus, .form-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(191, 161, 95, 0.2); }
        .form-textarea { resize: vertical; min-height: 80px; }

        .btn-save { width: 100%; background-color: var(--accent); color: white; border: none; padding: 14px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; margin-top: 10px; }
        .btn-save:hover { background-color: var(--accent-dark); }
        .btn-save:disabled { background-color: #ccc; cursor: not-allowed; }

        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .data-table { display: none; } 
            .grid-view { display: grid !important; }
            .view-toggles { display: none; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo">
            <div style="border: 2px solid var(--accent); padding: 2px 8px; border-radius: 4px; display:inline-block;">
                <span style="color:var(--accent); font-weight:bold;">Ø±</span>
            </div>
             Rowad Calls Dashboard
        </div>
        <div class="view-toggles">
            <button class="view-btn active" onclick="switchView('table')"><i class="fa-solid fa-table"></i> Table</button>
            <button class="view-btn" onclick="switchView('card')"><i class="fa-solid fa-th-large"></i> Grid</button>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search" placeholder="Search Hospital or Contact..." onkeyup="render()">
            </div>
            
            <div class="filter-box">
                <select id="filterDirection" onchange="updateRegionOptions()">
                    <option value="All">All Directions</option>
                </select>
            </div>
            
            <div class="filter-box hidden" id="boxRegion">
                <select id="filterRegion" onchange="updateCityOptions()">
                    <option value="All">All Regions</option>
                </select>
            </div>

            <div class="filter-box hidden" id="boxCity">
                <select id="filterCity" onchange="render()">
                    <option value="All">All Cities</option>
                </select>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fa-solid fa-circle-notch fa-spin" style="color:var(--accent)"></i> Loading Database...
        </div>

        <table class="data-table hidden" id="tableView">
            <thead>
                <tr>
                    <th style="width: 30%">Hospital</th>
                    <th>Location</th>
                    <th>Tags / Devices</th> <th>Satisfaction</th>
                    <th>Call Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="grid-view hidden" id="cardView"></div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="header-content">
                    <h2 class="modal-title" id="modalTitle">Hospital Name</h2>
                    <span class="warranty-tag" id="warrantyBadge">Under Warranty</span>
                </div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="form-group">
                <label class="form-label">Primary Contact</label>
                <div class="contact-box">
                    <input type="text" class="contact-name-input" id="editContactName" value="">
                    <div class="contact-phone">
                        <i class="fa-solid fa-phone phone-icon"></i> 
                        <span id="displayPhone"></span>
                    </div>
                    <input type="hidden" id="editContactMobile">
                    <button class="edit-icon-btn" onclick="promptPhoneUpdate()">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Customer Satisfaction</label>
                <select class="form-select" id="editSat">
                    <option value="-">-</option>
                    <option value="Satisfied">Satisfied</option>
                    <option value="Neutral">Neutral</option>
                    <option value="Unsatisfied">Unsatisfied</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Call Status & Outcome</label>
                <select class="form-select" id="editCallStatus">
                    <option value="-">-</option>
                    <option value="No Answer">No Answer</option>
                    <option value="Call Later">Call Later</option>
                    <option value="Quote Requested">Quote Requested</option>
                    <option value="Not Interested">Not Interested</option>
                    <option value="Renewed">Renewed</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="editNotes" placeholder="Add notes here..."></textarea>
            </div>

            <button class="btn-save" id="saveBtn" onclick="saveChanges()">Save Updates</button>
        </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhvbSEdhK56SFd-OoGIeS85lgkiX9bcXz5eR7ihi3wSqT7C4uSWMGHvJeD220d4xrAuw/exec";
        
        let db = [];
        let currentEditName = "";

        window.onload = fetchData;

        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                db = data.map(row => {
                    let autoTags = [];
                    const device = row['Device'] || '';
                    if (device.includes('Surfacide') || device === 'Both') autoTags.push('Surfacide');
                    if (device.includes('AccuFIT') || device === 'Both') autoTags.push('AccuFIT');
                    let manualTags = row['Tags'] ? row['Tags'].split(',').map(s => s.trim()) : [];
                    let combinedTags = [...new Set([...autoTags, ...manualTags])];

                    return {
                        name: row['Hospital Name'],
                        direction: row['Direction'] || 'Unknown',
                        region: row['Region'] || 'Unknown',
                        city: row['City'] || 'Unknown',
                        contact: row['Contact'] || '',
                        mobile: row['Contact Mobile Number'] || '',
                        
                        satisfaction: row['Satisfaction'] || '-',
                        contractStatus: row['ContractStatus'] || '-', 
                        tags: combinedTags,
                        notes: row['Notes'] || ''
                    };
                });

                initFilters();
                document.getElementById('loading').style.display = 'none';
                switchView('table');
                render();
            } catch (error) {
                document.getElementById('loading').innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
            }
        }

        function initFilters() {
            const directions = [...new Set(db.map(item => item.direction))].sort();
            const select = document.getElementById('filterDirection');
            select.innerHTML = '<option value="All">All Directions</option>';
            directions.forEach(d => { if(d) select.add(new Option(d, d)); });
        }

        function updateRegionOptions() {
            const dir = document.getElementById('filterDirection').value;
            const regionBox = document.getElementById('boxRegion');
            const cityBox = document.getElementById('boxCity');
            
            if (dir === 'All') {
                regionBox.classList.add('hidden');
                cityBox.classList.add('hidden');
                document.getElementById('filterRegion').value = 'All';
                document.getElementById('filterCity').value = 'All';
                render();
                return;
            }

            const regions = [...new Set(db.filter(x => x.direction === dir).map(x => x.region))].sort();
            const select = document.getElementById('filterRegion');
            select.innerHTML = '<option value="All">All Regions</option>';
            regions.forEach(r => select.add(new Option(r, r)));
            
            regionBox.classList.remove('hidden');
            cityBox.classList.add('hidden'); 
            render();
        }

        function updateCityOptions() {
            const region = document.getElementById('filterRegion').value;
            const cityBox = document.getElementById('boxCity');

            if (region === 'All') {
                cityBox.classList.add('hidden');
                document.getElementById('filterCity').value = 'All';
                render();
                return;
            }

            const cities = [...new Set(db.filter(x => x.region === region).map(x => x.city))].sort();
            const select = document.getElementById('filterCity');
            select.innerHTML = '<option value="All">All Cities</option>';
            cities.forEach(c => select.add(new Option(c, c)));

            cityBox.classList.remove('hidden');
            render();
        }

        function getSortWeight(status) {
            // Lower number = Higher priority (Top of list)
            if (status === 'Call Later') return 1;
            if (status === 'Quote Requested') return 1; // Prioritize hot leads same as urgent calls
            if (status === 'No Answer') return 2;
            if (status === '-' || !status) return 2; // Default pile
            if (status === 'Renewed') return 3; // Bottom
            if (status === 'Not Interested') return 4; // Very Bottom
            return 2;
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            const cardGrid = document.getElementById('cardView');
            tbody.innerHTML = '';
            cardGrid.innerHTML = '';

            const search = document.getElementById('search').value.toLowerCase();
            const filterDir = document.getElementById('filterDirection').value;
            const filterReg = document.getElementById('filterRegion').value;
            const filterCity = document.getElementById('filterCity').value;

            // 1. FILTER
            let filtered = db.filter(item => {
                if (!item.name.toLowerCase().includes(search) && !item.contact.toLowerCase().includes(search)) return false;
                if (filterDir !== 'All' && item.direction !== filterDir) return false;
                if (filterReg !== 'All' && item.region !== filterReg) return false;
                if (filterCity !== 'All' && item.city !== filterCity) return false;
                return true;
            });

            // 2. SORT based on Status Weight
            filtered.sort((a, b) => {
                return getSortWeight(a.contractStatus) - getSortWeight(b.contractStatus);
            });

            // 3. RENDER
            filtered.forEach(item => {
                let satHtml = '-';
                if(item.satisfaction && item.satisfaction !== '-' && item.satisfaction !== 'Unknown') {
                    let displayClass = item.satisfaction;
                    if(item.satisfaction === 'High') displayClass = 'Satisfied';
                    if(item.satisfaction === 'Medium') displayClass = 'Neutral';
                    if(item.satisfaction === 'Low') displayClass = 'Unsatisfied';
                    satHtml = `<span class="sat-dot sat-${displayClass}"></span> ${item.satisfaction}`;
                }

                let statusHtml = '-';
                let rowClass = '';
                let cardClass = '';

                if(item.contractStatus && item.contractStatus !== '-') {
                    let color = '#2c3e50'; 
                    let bg = 'transparent';
                    
                    if(item.contractStatus === 'Renewed') { 
                        color = '#155724'; bg = '#d4edda'; 
                        rowClass = 'row-renewed';
                        cardClass = 'card-renewed';
                    }
                    if(item.contractStatus === 'Quote Requested') { color = '#0c5460'; bg = '#d1ecf1'; }
                    if(item.contractStatus === 'Call Later') { color = '#856404'; bg = '#fff3cd'; }
                    if(item.contractStatus === 'No Answer') { color = '#721c24'; bg = '#f8d7da'; }
                    if(item.contractStatus === 'Not Interested') { 
                        color = '#383d41'; bg = '#e2e3e5'; 
                        rowClass = 'row-dead';
                        cardClass = 'card-dead';
                    }
                    
                    statusHtml = `<span style="font-weight:700; color: ${color}; background:${bg}; padding: 4px 8px; border-radius: 4px; font-size:11px;">${item.contractStatus}</span>`;
                }

                let tagsHtml = '';
                item.tags.forEach(t => {
                    tagsHtml += `<span class="tag">${t}</span>`;
                });

                const tr = `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${item.name}</strong><br>
                            <span style="font-size:12px; color:#888">${item.contact}</span>
                        </td>
                        <td>${item.region} / ${item.city}</td>
                        <td>${tagsHtml}</td> <td>${satHtml}</td>
                        <td>${statusHtml}</td>
                        <td><button class="btn-edit" onclick="openEdit('${item.name.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pen"></i> Edit</button></td>
                    </tr>
                `;
                tbody.innerHTML += tr;

                const card = `
                    <div class="card ${cardClass}">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start">
                            <h3>${item.name}</h3>
                            <button class="btn-edit" onclick="openEdit('${item.name.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pen"></i></button>
                        </div>
                        <div style="margin-bottom:10px;">${tagsHtml}</div>
                        <div class="card-row">
                            <span class="label">Location</span>
                            <span>${item.city}</span>
                        </div>
                        <div class="card-row">
                             <span class="label">Satisfaction</span><span>${satHtml}</span>
                        </div>
                        <div class="card-row">
                             <span class="label">Status</span><span>${statusHtml}</span>
                        </div>
                    </div>
                `;
                cardGrid.innerHTML += card;
            });
        }

        async function saveChanges() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            btn.disabled = true;

            const item = db.find(x => x.name === currentEditName);
            if (!item) {
                alert("Error: Record not found in local data.");
                btn.textContent = originalText;
                btn.disabled = false;
                return;
            }
            
            const newSat = document.getElementById('editSat').value;
            const newCallStatus = document.getElementById('editCallStatus').value;
            const newNotes = document.getElementById('editNotes').value;
            const newContactName = document.getElementById('editContactName').value;
            const newContactMobile = document.getElementById('editContactMobile').value;

            const payload = {
                hospitalName: item.name, 
                satisfaction: newSat,
                contractStatus: newCallStatus, 
                notes: newNotes,
                contactName: newContactName,
                contactMobile: newContactMobile
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: "follow", 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.result !== "success") {
                    throw new Error(result.message || "Unknown error from server");
                }
                
                item.satisfaction = newSat;
                item.contractStatus = newCallStatus;
                item.notes = newNotes;
                item.contact = newContactName;
                item.mobile = newContactMobile;
                
                closeModal();
                render(); 
                alert("Saved successfully.");

            } catch (error) {
                console.error(error);
                alert("Error saving: " + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        function switchView(view) {
            const table = document.getElementById('tableView');
            const grid = document.getElementById('cardView');
            const btns = document.querySelectorAll('.view-btn');
            
            if(view === 'table') {
                table.classList.remove('hidden');
                grid.classList.add('hidden');
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                table.classList.add('hidden');
                grid.classList.remove('hidden');
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
            }
        }

        function openEdit(name) {
            currentEditName = name;
            const item = db.find(x => x.name === name);
            
            document.getElementById('modalTitle').innerText = item.name;

            const isWarranty = item.tags.some(tag => tag.toLowerCase().includes('warranty'));
            const warrantyBadge = document.getElementById('warrantyBadge');
            if(isWarranty) {
                warrantyBadge.style.display = 'inline-block';
            } else {
                warrantyBadge.style.display = 'none';
            }

            document.getElementById('editContactName').value = item.contact || "";
            
            const phoneDisplay = document.getElementById('displayPhone');
            const phoneInput = document.getElementById('editContactMobile');
            
            phoneDisplay.innerText = item.mobile || "No Number";
            phoneInput.value = item.mobile || "";

            document.getElementById('editSat').value = (item.satisfaction === '-' || !item.satisfaction) ? '-' : item.satisfaction;
            document.getElementById('editCallStatus').value = (item.contractStatus === '-' || !item.contractStatus) ? '-' : item.contractStatus;
            document.getElementById('editNotes').value = item.notes;

            document.getElementById('editModal').style.display = 'flex';
        }

        function promptPhoneUpdate() {
            const hiddenInput = document.getElementById('editContactMobile');
            const display = document.getElementById('displayPhone');
            
            const current = hiddenInput.value;
            const newPhone = prompt("Enter new mobile number:", current);
            
            if(newPhone !== null) {
                hiddenInput.value = newPhone;
                display.innerText = newPhone || "No Number";
            }
            document.getElementById('editContactName').focus();
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>
</body>
</html>
